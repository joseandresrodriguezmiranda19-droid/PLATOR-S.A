<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard ‚Äî Palpaci√≥n | Las Cuchillas</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- PapaParse (CSV) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    /* Scrollbar suave (opcional) */
    ::-webkit-scrollbar { width: 10px; height: 10px; }
    ::-webkit-scrollbar-thumb { background: rgba(148,163,184,.6); border-radius: 999px; }
    ::-webkit-scrollbar-track { background: rgba(15,23,42,.05); }
  
    /* KPIs: altura corta (seg√∫n referencia l√≠nea verde) */
    .kpi-card{
      padding: 14px;             /* un poco menos que p-4 (16px) */
      height: 120px;             /* m√°s corta: evita tarjetas largas */
      display:flex;
      flex-direction:column;
      justify-content:space-between;
    }
    .kpi-card .kpi-title{ font-size: 11px; color: rgb(203 213 225); }
    .kpi-card .kpi-value{ font-size: 30px; line-height: 1; font-weight: 600; }
    .kpi-card .kpi-hint{ font-size: 11px; color: rgb(148 163 184); line-height: 1.25; }
    /* Ajustes finos para la tarjeta de Tipo de Pre√±ez (MN/IATF) */
    .kpi-card .tpre-grid{ margin-top: 6px; }
    .kpi-card .tpre-box{ padding: 8px 10px; }
    .kpi-card .tpre-box .tpre-val{ font-size: 18px; line-height: 1; }

  </style>
</head>

<body class="bg-slate-950 text-slate-100">
  <div id="dashboard" class="min-h-screen">
    <!-- Top bar -->
    <header class="sticky top-0 z-40 border-b border-slate-800/60 bg-slate-950/80 backdrop-blur">
      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-4 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <div class="flex items-start gap-3">
          <div class="h-11 w-11 rounded-2xl bg-slate-800/60 grid place-items-center border border-slate-700/60">
            <span class="text-xl">üêÑ</span>
          </div>
          <div>
            <h1 class="text-lg sm:text-xl font-semibold leading-tight">An√°lisis de Palpaci√≥n ‚Äî <span class="text-sky-400 font-semibold">PLATOR S.A</span></h1>
            <p id="metaLine" class="text-sm text-slate-300"></p>
          </div>
        </div>

        <div class="flex flex-col sm:flex-row sm:items-center gap-2">
          <button id="btnExportHTML" class="px-3 py-2 rounded-xl bg-slate-100 text-slate-900 font-medium hover:bg-white active:scale-[.99]">
            Exportar Dashboard (HTML)
          </button>

          <div class="flex flex-col gap-1 min-w-[260px]">
            <input id="csvFile" type="file" accept=".csv,text/csv" multiple class="w-full text-sm file:mr-3 file:rounded-xl file:border-0 file:bg-slate-800 file:px-3 file:py-2 file:text-slate-100 hover:file:bg-slate-700/70 text-slate-200" />
            <p id="csvStatus" class="text-xs text-slate-300">Sub√≠ el CSV del reporte (ej. <span class="text-slate-100">36765745.csv</span>) para cargar datos.</p>
          </div>
        </div>
      </div>
    </header>

    <main class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-6 space-y-6">
      <!-- Filters -->
      <section class="grid grid-cols-1 lg:grid-cols-12 gap-4 items-start">
        <div class="lg:col-span-4 rounded-2xl border border-slate-800/60 bg-slate-900/40 pt-4 px-4 pb-3">
          <div class="flex items-center justify-between">
            <h2 class="font-semibold">Filtros</h2>
            <button id="btnReset" class="text-sm text-slate-300 hover:text-white">Restablecer</button>
          </div>

          <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3">
            <!-- Fincas (multi-select) -->
            <label class="block">
              <span class="text-xs text-slate-300">Fincas</span>
              <div class="mt-1 relative">
                <button id="fFincaBtn" type="button"
                  class="w-full rounded-xl bg-slate-950/40 border border-slate-800 px-3 py-2 text-left outline-none focus:ring-2 focus:ring-slate-400/40">
                  Todos
                </button>

                <div id="fFincaMenu"
                  class="hidden absolute z-50 mt-2 w-full rounded-xl border border-slate-800/80 bg-slate-950/95 backdrop-blur shadow-xl">
                  <!-- se llena por JS -->
                </div>
              </div>
            </label>

            <!-- Estado reproductivo (multi-select) -->
            <label class="block">
              <span class="text-xs text-slate-300">Estado reproductivo</span>
              <div class="mt-1 relative">
                <button id="fEstadoBtn" type="button"
                  class="w-full rounded-xl bg-slate-950/40 border border-slate-800 px-3 py-2 text-left outline-none focus:ring-2 focus:ring-slate-400/40">
                  Todos
                </button>

                <div id="fEstadoMenu"
                  class="hidden absolute z-50 mt-2 w-full rounded-xl border border-slate-800/80 bg-slate-950/95 backdrop-blur shadow-xl">
                  <!-- se llena por JS -->
                </div>
              </div>
            </label>

            <!-- Estado Actual (multi-select) -->
            <label class="block">
              <span class="text-xs text-slate-300">Estado Actual</span>
              <div class="mt-1 relative">
                <button id="fEABtn" type="button"
                  class="w-full rounded-xl bg-slate-950/40 border border-slate-800 px-3 py-2 text-left outline-none focus:ring-2 focus:ring-slate-400/40">
                  Todos
                </button>

                <div id="fEAMenu"
                  class="hidden absolute z-50 mt-2 w-full rounded-xl border border-slate-800/80 bg-slate-950/95 backdrop-blur shadow-xl">
                  <!-- se llena por JS -->
                </div>
              </div>
            </label>

            <!-- Tipo de pre√±ez (multi-select) -->
            <label class="block">
              <span class="text-xs text-slate-300">Tipo de pre√±ez</span>
              <div class="mt-1 relative">
                <button id="fTPreBtn" type="button"
                  class="w-full rounded-xl bg-slate-950/40 border border-slate-800 px-3 py-2 text-left outline-none focus:ring-2 focus:ring-slate-400/40">
                  Todos
                </button>

                <div id="fTPreMenu"
                  class="hidden absolute z-50 mt-2 w-full rounded-xl border border-slate-800/80 bg-slate-950/95 backdrop-blur shadow-xl">
                  <!-- se llena por JS -->
                </div>
              </div>
            </label>

            <label class="block sm:col-span-2">
              <span class="text-xs text-slate-300">Edad (a√±os) ‚Äî rango</span>
              <div class="mt-2 grid grid-cols-2 gap-2">
                <input id="fEdadMin" type="number" step="0.1" placeholder="M√≠n" class="w-full rounded-xl bg-slate-950/40 border border-slate-800 px-3 py-2 outline-none focus:ring-2 focus:ring-slate-400/40">
                <input id="fEdadMax" type="number" step="0.1" placeholder="M√°x" class="w-full rounded-xl bg-slate-950/40 border border-slate-800 px-3 py-2 outline-none focus:ring-2 focus:ring-slate-400/40">
              </div>
            </label>

            <label class="block sm:col-span-2">
              <span class="text-xs text-slate-300">Buscar (N√∫mero / Nombre)</span>
              <input id="fSearch" type="text" placeholder="Ej: 003388176" class="mt-1 w-full rounded-xl bg-slate-950/40 border border-slate-800 px-3 py-2 outline-none focus:ring-2 focus:ring-slate-400/40">
            </label>
</div>
        </div>

        <!-- KPI cards -->
        <div class="lg:col-span-8 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 content-start self-start">
          <div class="rounded-2xl border border-slate-800/60 bg-slate-900/40 kpi-card">
            <p class="kpi-title">Animales (filtrado)</p>
            <p id="kpiTotal" class="mt-2 kpi-value">‚Äî</p>
            <p id="kpiTotalHint" class="mt-1 kpi-hint">‚Äî</p>
          </div>

          <div class="rounded-2xl border border-slate-800/60 bg-slate-900/40 kpi-card">
            <p class="kpi-title">% Pre√±adas</p>
            <p id="kpiPren" class="mt-2 kpi-value">‚Äî</p>
            <p id="kpiPrenHint" class="mt-1 kpi-hint">‚Äî</p>
          </div>

          <div class="rounded-2xl border border-slate-800/60 bg-slate-900/40 kpi-card">
            <p class="kpi-title">Edad promedio (a√±os)</p>
            <p id="kpiEdad" class="mt-2 kpi-value">‚Äî</p>
            <p class="mt-1 kpi-hint">Promedio (ignora 0)</p>
          </div>

          <div class="rounded-2xl border border-slate-800/60 bg-slate-900/40 kpi-card">
            <p class="kpi-title">D√≠as abiertos (prom.)</p>
            <p id="kpiDab" class="mt-2 kpi-value">‚Äî</p>
            <p class="mt-1 kpi-hint">Promedio (ignora 0)</p>
          </div>

          <div class="rounded-2xl border border-slate-800/60 bg-slate-900/40 kpi-card">
            <p class="kpi-title">Total Cr√≠as</p>
            <p id="kpiCrias" class="mt-2 kpi-value">‚Äî</p>
            <p class="mt-1 kpi-hint">Suma de #C</p>
          </div>

          <div class="rounded-2xl border border-slate-800/60 bg-slate-900/40 kpi-card">
            <p class="kpi-title">Total Partos</p>
            <p id="kpiPartos" class="mt-2 kpi-value">‚Äî</p>
            <p class="mt-1 kpi-hint">Suma de #P</p>
          </div>

          <div class="rounded-2xl border border-slate-800/60 bg-slate-900/40 kpi-card">
            <p class="kpi-title">Total Abortos</p>
            <p id="kpiAbortos" class="mt-2 kpi-value">‚Äî</p>
            <p class="mt-1 kpi-hint">Suma de Abortos</p>
          </div>

          <div class="rounded-2xl border border-slate-800/60 bg-slate-900/40 kpi-card">
            <p class="kpi-title">Pr√≥ximos Partos</p>
            <p id="kpiProxPartos" class="mt-2 kpi-value">‚Äî</p>
            <p class="mt-1 kpi-hint">Recuento de F. P. P</p>
          </div>

          <div class="rounded-2xl border border-slate-800/60 bg-slate-900/40 kpi-card">
            <p class="kpi-title">Gestaci√≥n (prom.)</p>
            <p id="kpiGest" class="mt-2 kpi-value">‚Äî</p>
            <p class="mt-1 kpi-hint">Promedio (ignora 0)</p>
          </div>

          <div class="rounded-2xl border border-slate-800/60 bg-slate-900/40 kpi-card">
            <p class="kpi-title">Tipo de Pre√±ez (Top)</p>
            <div class="tpre-grid grid grid-cols-2 gap-2">
              <div class="tpre-box rounded-xl border border-slate-800/60 bg-slate-950/25">
                <p class="text-[11px] text-slate-300 leading-none">MN</p>
                <p id="kpiTPreMN" class="tpre-val mt-1 font-semibold leading-none">‚Äî</p>
              </div>
              <div class="tpre-box rounded-xl border border-slate-800/60 bg-slate-950/25">
                <p class="text-[11px] text-slate-300 leading-none">IATF</p>
                <p id="kpiTPreIATF" class="tpre-val mt-1 font-semibold leading-none">‚Äî</p>
              </div>
            </div>
            <p class="mt-1 text-[10px] text-slate-400 leading-tight">Conteo en el filtro actual</p>
          </div>
        </div>
      </section>

      <!-- Charts -->
      <section class="grid grid-cols-1 lg:grid-cols-12 gap-4 items-start">
        <div class="lg:col-span-5 rounded-2xl border border-slate-800/60 bg-slate-900/40 p-4">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">Distribuci√≥n ‚Äî Estado reproductivo</h3>
            <span id="chartEstadoNote" class="text-xs text-slate-400"></span>
          </div>
          <div class="mt-3">
            <canvas id="chartEstado" height="250"></canvas>
          </div>
        </div>

        <div class="lg:col-span-7 rounded-2xl border border-slate-800/60 bg-slate-900/40 p-4">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">Distribuci√≥n ‚Äî Estado Actual</h3>
            <span id="chartEANote" class="text-xs text-slate-400"></span>
          </div>
          <div class="mt-3">
            <canvas id="chartEA" height="250"></canvas>
          </div>
        </div>

        <div class="lg:col-span-7 rounded-2xl border border-slate-800/60 bg-slate-900/40 p-4">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">Histograma ‚Äî Edad (a√±os)</h3>
            <span class="text-xs text-slate-400">Bins de 1 a√±o</span>
          </div>
          <div class="mt-3">
            <canvas id="chartEdad" height="250"></canvas>
          </div>
        </div>

        <div class="lg:col-span-5 rounded-2xl border border-slate-800/60 bg-slate-900/40 p-4">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">Partos esperados (F. P. P)</h3>
            <span class="text-xs text-slate-400">Conteo por mes</span>
          </div>
          <div class="mt-3 h-64">
            <canvas id="chartFPP"></canvas>
          </div>
        </div>
      </section>

      <!-- Table -->
      <section class="rounded-2xl border border-slate-800/60 bg-slate-900/40 p-4">
        <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
          <div>
            <h3 class="font-semibold">Detalle</h3>
            <p class="text-sm text-slate-300">Tabla din√°mica seg√∫n filtros (paginada para ver todos los animales).</p>
          </div>
          <div class="flex flex-wrap items-center gap-2">
            <label class="text-xs text-slate-300">Ordenar por</label>
            <select id="tSort" class="rounded-xl bg-slate-950/40 border border-slate-800 px-3 py-2 text-sm outline-none">
              <option value="EdadAnios_desc">Edad (a√±os) ‚Üì</option>
              <option value="EdadAnios_asc">Edad (a√±os) ‚Üë</option>
              <option value="DPar_desc">D√≠as Parida ‚Üì</option>
              <option value="DPar_asc">D√≠as Parida ‚Üë</option>
              <option value="Numero_asc">N√∫mero ‚Üë</option>
              <option value="Numero_desc">N√∫mero ‚Üì</option>
            </select>

            <span class="hidden sm:inline-block w-px h-6 bg-slate-800/60 mx-1"></span>

            <label class="text-xs text-slate-300">Filas</label>
            <select id="pageSize" class="rounded-xl bg-slate-950/40 border border-slate-800 px-3 py-2 text-sm outline-none">
              <option value="50" selected>50</option>
              <option value="40">40</option>
            </select>

            <button id="pagePrev" class="px-3 py-2 rounded-xl bg-slate-950/40 border border-slate-800 hover:bg-slate-900/40 active:scale-[.99]" title="Anterior">‚óÄ</button>
            <span id="pageInfo" class="text-xs text-slate-300 min-w-[120px] text-center">P√°gina ‚Äî</span>
            <button id="pageNext" class="px-3 py-2 rounded-xl bg-slate-950/40 border border-slate-800 hover:bg-slate-900/40 active:scale-[.99]" title="Siguiente">‚ñ∂</button>
          </div>
        </div>

        <div class="mt-4 overflow-auto rounded-xl border border-slate-800/60">
          <table class="min-w-[1100px] w-full text-sm">
            <thead class="bg-slate-950/40 text-slate-200">
              <tr>
                <th class="text-left font-medium px-3 py-2 border-b border-slate-800/60">N√∫mero</th>
                <th class="text-left font-medium px-3 py-2 border-b border-slate-800/60">Nombre</th>
                <th class="text-left font-medium px-3 py-2 border-b border-slate-800/60">Estado Actual</th>
                <th class="text-left font-medium px-3 py-2 border-b border-slate-800/60">Estado Reproducci√≥n</th>
                <th class="text-left font-medium px-3 py-2 border-b border-slate-800/60">Gest.</th>
                <th class="text-left font-medium px-3 py-2 border-b border-slate-800/60">TPre√±ez</th>
                <th class="text-left font-medium px-3 py-2 border-b border-slate-800/60">Edad (texto)</th>
                <th class="text-left font-medium px-3 py-2 border-b border-slate-800/60">Fecha Pre√±ez</th>
                <th class="text-left font-medium px-3 py-2 border-b border-slate-800/60">Fecha Primer Parto</th>
                <th class="text-left font-medium px-3 py-2 border-b border-slate-800/60">Partos</th>
                <th class="text-left font-medium px-3 py-2 border-b border-slate-800/60">Cr√≠as</th>                <th class="text-left font-medium px-3 py-2 border-b border-slate-800/60">D√≠as Abiertos</th>
</tr>
            </thead>
            <tbody id="tBody" class="divide-y divide-slate-800/40">
            </tbody>
          </table>
        </div>

        <div class="mt-3 flex items-center justify-between text-xs text-slate-400">
          <span id="tCount">‚Äî</span>
          <span>Consejo: Exportar HTML guarda datos + filtros en un solo archivo.</span>
        </div>
      </section>

      <footer class="pb-6 text-xs text-slate-500">
        <p>Generado desde: <span class="text-slate-300">ES-003 - LAS CUCHILLAS</span> ‚Ä¢ Actualizado a: 08/01/26 ‚Ä¢ Impresi√≥n: 04/02/26 10:12:56 AM</p>
      </footer>
    </main>
  </div>

<script>
  // =========================
  // Datos embebidos (desde Excel)
  // =========================
  const META_DEFAULT = { titulo: '', actualizado: '', impresion: '', fuente: '' };
  let META = (window.__EXPORTED_STATE__ && window.__EXPORTED_STATE__.meta) ? window.__EXPORTED_STATE__.meta : META_DEFAULT;

  const RAW_DEFAULT = [];
  let RAW = (window.__EXPORTED_STATE__ && Array.isArray(window.__EXPORTED_STATE__.data)) ? window.__EXPORTED_STATE__.data : RAW_DEFAULT;

  // UI refs
  const fEdadMin = document.getElementById('fEdadMin');
  const fEdadMax = document.getElementById('fEdadMax');
  const fSearch = document.getElementById('fSearch');
  const tSort = document.getElementById('tSort');
  const pageSizeEl = document.getElementById('pageSize');
  const pagePrevEl = document.getElementById('pagePrev');
  const pageNextEl = document.getElementById('pageNext');
  const pageInfoEl = document.getElementById('pageInfo');

  // Multi-select UI refs
  const fFincaBtn = document.getElementById('fFincaBtn');
  const fFincaMenu = document.getElementById('fFincaMenu');
  const fEstadoBtn = document.getElementById('fEstadoBtn');
  const fEstadoMenu = document.getElementById('fEstadoMenu');
  const fEABtn = document.getElementById('fEABtn');
  const fEAMenu = document.getElementById('fEAMenu');
  const fTPreBtn = document.getElementById('fTPreBtn');
  const fTPreMenu = document.getElementById('fTPreMenu');
let PAGE = 1;

  // Meta line
  const metaEl = document.getElementById('metaLine');
  const formatMeta = (m) => {
    const bits = [];
    if (m?.titulo) bits.push(m.titulo);
    if (m?.fuente) bits.push(m.fuente);
    return bits.filter(Boolean).join(' ‚Ä¢ ');
  };
  if (metaEl) {
    const txt = formatMeta(META);
    metaEl.textContent = txt || 'Sub√≠ el CSV para cargar datos.';
  }

  // Helpers
  const fmt1 = (v) => (v === null || v === undefined || Number.isNaN(v)) ? '‚Äî' : (Math.round(v*10)/10).toFixed(1);
  const fmt0 = (v) => (v === null || v === undefined || Number.isNaN(v)) ? '‚Äî' : Math.round(v).toString();
  const pct = (num, den) => (den ? ((num/den)*100) : 0);

  // Paletas de color (profesional, consistente con el dashboard)
  const chartPalette = {
    pastel: [
      'rgba(59,130,246,0.80)',  // blue
      'rgba(16,185,129,0.80)',  // emerald
      'rgba(245,158,11,0.82)',  // amber
      'rgba(168,85,247,0.78)',  // purple
      'rgba(239,68,68,0.78)',   // red
      'rgba(14,165,233,0.80)',  // sky
      'rgba(244,63,94,0.78)',   // rose
      'rgba(234,179,8,0.82)',   // yellow
      'rgba(34,197,94,0.78)',   // green
      'rgba(100,116,139,0.80)'  // slate
    ],
    green: { fill: 'rgba(34,197,94,0.60)', stroke: 'rgba(34,197,94,0.95)' },
    orange: { fill: 'rgba(249,115,22,0.25)', stroke: 'rgba(249,115,22,0.95)' },
    bars: { fill: 'rgba(148,163,184,0.55)', stroke: 'rgba(226,232,240,0.9)' }
  };

  function uniqSorted(arr) {
    return [...new Set(arr.filter(v => v !== null && v !== undefined && String(v).trim() !== ''))]
      .sort((a,b)=>String(a).localeCompare(String(b)));
  }

  function monthKey(iso) {
    // iso: YYYY-MM-DD
    if (!iso) return null;
    const d = new Date(iso + "T00:00:00");
    if (Number.isNaN(d.getTime())) return null;
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    return `${y}-${m}`;
  }

  function labelEA(code) {
    const c = String(code || '').trim().toUpperCase();
    if (c === 'NV') return 'NV (Novillas)';
    if (c === 'VP') return 'VP (Vacas Paridas)';
    if (c === 'VS') return 'VS (Vacas Secas)';
    return code || 'Sin dato';
  }


  // =========================
  // Multi-select (Estado / EA)
  // =========================
  const MS = {
    Finca:  { key: 'Finca',  btn: fFincaBtn,  menu: fFincaMenu,  selected: new Set(), options: [], setup: false },
    Estado: { key: 'Estado', btn: fEstadoBtn, menu: fEstadoMenu, selected: new Set(), options: [], setup: false },
    EA:     { key: 'EA',     btn: fEABtn,     menu: fEAMenu,     selected: new Set(), options: [], setup: false },
    TPre:   { key: 'TPre',   btn: fTPreBtn,   menu: fTPreMenu,   selected: new Set(), options: [], setup: false }
  };

  function msLabel(ms) {
    const n = ms.selected.size;
    if (n === 0) return 'Todos';
    const arr = [...ms.selected];
    if (n <= 2) return arr.join(', ');
    return `${n} seleccionados`;
  }

  function msCloseAll(exceptKey = null) {
    for (const ms of Object.values(MS)) {
      if (exceptKey && ms.key === exceptKey) continue;
      ms.menu?.classList.add('hidden');
    }
  }

  function msSync(ms) {
    if (!ms.menu) return;
    ms.menu.querySelectorAll('input[type="checkbox"][data-ms-opt="1"]').forEach(ch => {
      ch.checked = ms.selected.has(ch.value);
    });
    if (ms.btn) ms.btn.textContent = msLabel(ms);
  }

  function msRenderMenu(ms) {
    const escAttr = (s) => String(s ?? '').replaceAll('"','&quot;');
    const escText = (s) => String(s ?? '');

    const itemsHtml = ms.options.map(opt => {
      const v = escText(opt);
      const checked = ms.selected.has(v) ? 'checked' : '';
      return `
        <label class="flex items-center gap-2 px-2 py-1 rounded-lg hover:bg-slate-800/40 cursor-pointer">
          <input data-ms-opt="1" type="checkbox" value="${escAttr(v)}" ${checked}
            class="rounded border-slate-600 bg-slate-950/40">
          <span class="text-sm text-slate-200">${v || 'Sin dato'}</span>
        </label>
      `;
    }).join('');

    ms.menu.innerHTML = `
      <div class="p-2 border-b border-slate-800/70 flex items-center gap-2">
        <button type="button" data-ms-action="all"
          class="px-2 py-1 rounded-lg bg-slate-900/60 border border-slate-800/60 hover:bg-slate-800/60 text-xs">
          Todo
        </button>
        <button type="button" data-ms-action="clear"
          class="px-2 py-1 rounded-lg bg-slate-900/60 border border-slate-800/60 hover:bg-slate-800/60 text-xs">
          Limpiar
        </button>
        <span class="ml-auto text-[11px] text-slate-400">${ms.options.length} opciones</span>
      </div>
      <div class="max-h-60 overflow-auto p-2 space-y-1">
        ${itemsHtml || `<p class="text-xs text-slate-400 px-2 py-2">Sin opciones</p>`}
      </div>
    `;
  }

  function msSetup(ms) {
    if (ms.setup || !ms.btn || !ms.menu) return;
    ms.setup = true;

    // Abrir/cerrar
    ms.btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const isOpen = !ms.menu.classList.contains('hidden');
      msCloseAll(ms.key);
      ms.menu.classList.toggle('hidden', isOpen);
    });

    // Acciones (Todo/Limpiar)
    ms.menu.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-ms-action]');
      if (!btn) return;

      const act = btn.getAttribute('data-ms-action');
      if (act === 'all') {
        ms.selected = new Set(ms.options.map(v => String(v)));
      } else if (act === 'clear') {
        ms.selected.clear();
      }
      msSync(ms);
      PAGE = 1;
      render();
    });

    // Checkboxes
    ms.menu.addEventListener('change', (e) => {
      const ch = e.target;
      if (!(ch instanceof HTMLInputElement)) return;
      if (ch.type !== 'checkbox') return;

      if (ch.checked) ms.selected.add(ch.value);
      else ms.selected.delete(ch.value);

      if (ms.btn) ms.btn.textContent = msLabel(ms);
      PAGE = 1;
      render();
    });
  }

  function msBuild(ms, options) {
    msSetup(ms);
    ms.options = options || [];
    msRenderMenu(ms);
    msSync(ms);
  }

  // cerrar al click afuera
  document.addEventListener('click', () => msCloseAll());

  // =========================
  // Populate filter options
  // =========================
  function initFilters() {
    const fincas = uniqSorted(RAW.map(d => d.Finca));
    const estados = uniqSorted(RAW.map(d => d.EstadoReprod));
    const eas = uniqSorted(RAW.map(d => d.EA));
    const tpres = uniqSorted(RAW.map(d => d.TPre√±ez));

    // Si selecci√≥n ya no existe en opciones (por nuevo CSV), limpiarla
    MS.Finca.selected  = new Set([...MS.Finca.selected].filter(v => fincas.includes(v)));
    MS.Estado.selected = new Set([...MS.Estado.selected].filter(v => estados.includes(v)));
    MS.EA.selected     = new Set([...MS.EA.selected].filter(v => eas.includes(v)));
    MS.TPre.selected   = new Set([...MS.TPre.selected].filter(v => tpres.includes(v)));

    msBuild(MS.Finca, fincas);
    msBuild(MS.Estado, estados);
    msBuild(MS.EA, eas);
    msBuild(MS.TPre, tpres);

    // placeholders del rango de edad, si hay datos
    const ages = RAW.map(d => d.EdadAnios).filter(v => typeof v === 'number' && !Number.isNaN(v));
    if (ages.length) {
      const minA = Math.floor(Math.min(...ages));
      const maxA = Math.ceil(Math.max(...ages));
      fEdadMin.placeholder = String(minA);
      fEdadMax.placeholder = String(maxA);
    } else {
      fEdadMin.placeholder = '';
      fEdadMax.placeholder = '';
    }
  }

  function applyFilters() {
    const fincaSel = [...MS.Finca.selected];
    const estSel = [...MS.Estado.selected];
    const eaSel = [...MS.EA.selected];
    const tpreSel = [...MS.TPre.selected];

    const q = fSearch.value.trim().toLowerCase();
    const min = parseFloat(fEdadMin.value);
    const max = parseFloat(fEdadMax.value);

    return RAW.filter(d => {
      if (fincaSel.length && !fincaSel.includes(d.Finca || '')) return false;
      if (estSel.length && !estSel.includes(d.EstadoReprod || '')) return false;
      if (eaSel.length && !eaSel.includes(d.EA || '')) return false;
      if (tpreSel.length && !tpreSel.includes(d.TPre√±ez || '')) return false;

      if (!Number.isNaN(min) && typeof d.EdadAnios === 'number' && d.EdadAnios < min) return false;
      if (!Number.isNaN(max) && typeof d.EdadAnios === 'number' && d.EdadAnios > max) return false;

      if (q) {
        const hay = `${d.Numero} ${d.Nombre}`.toLowerCase();
        if (!hay.includes(q)) return false;
      }
      return true;
    });
  }

  function sortRows(rows) {
    const v = tSort.value;
    const [key, dir] = v.split('_');
    const mult = (dir === 'asc') ? 1 : -1;

    const getter = (r) => {
      if (key === 'Numero') return r.Numero;
      if (key === 'EdadAnios') return (typeof r.EdadAnios === 'number' ? r.EdadAnios : -Infinity);
      if (key === 'DPar') return (typeof r.DPar === 'number' ? r.DPar : -Infinity);
      return r.Numero;
    };

    return [...rows].sort((a,b)=> {
      const A = getter(a), B = getter(b);
      if (typeof A === 'string' || typeof B === 'string') return String(A).localeCompare(String(B)) * mult;
      return (A - B) * mult;
    });
  }

  // =========================
  // Charts
  // =========================
  let chartEstado, chartEA, chartEdad, chartFPP;

  function destroyIf(c) { if (c) c.destroy(); }

  function buildCharts(rows) {
    // Estado (pie)
    const byEstado = new Map();
    for (const r of rows) {
      const k = r.EstadoReprod || 'Sin dato';
      byEstado.set(k, (byEstado.get(k) || 0) + 1);
    }
    const estadoLabels = [...byEstado.keys()];
    const estadoVals = estadoLabels.map(k => byEstado.get(k));

    destroyIf(chartEstado);
    chartEstado = new Chart(document.getElementById('chartEstado'), {
      type: 'doughnut',
      data: {
        labels: estadoLabels,
        datasets: [{ data: estadoVals, backgroundColor: estadoLabels.map((_,i)=>chartPalette.pastel[i % chartPalette.pastel.length]), borderColor: 'rgba(15,23,42,0.65)', borderWidth: 2, hoverOffset: 6 }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom', labels: { color: '#cbd5e1', usePointStyle: true, boxWidth: 10, boxHeight: 10 } },
          tooltip: { callbacks: {
            label: (ctx) => {
              const v = ctx.parsed;
              const total = estadoVals.reduce((a,b)=>a+b,0);
              return ` ${ctx.label}: ${v} (${pct(v,total).toFixed(1)}%)`;
            }
          }}
        }
      }
    });
    document.getElementById('chartEstadoNote').textContent = `${rows.length} registros`;

    // EA (bar)
    const byEA = new Map();
    for (const r of rows) {
      const k = r.EA || 'Sin dato';
      byEA.set(k, (byEA.get(k) || 0) + 1);
    }
    const eaCodes = [...byEA.keys()].sort((a,b)=>String(a).localeCompare(String(b)));
    const eaLabels = eaCodes.map(labelEA);
    const eaVals = eaCodes.map(k => byEA.get(k));

    destroyIf(chartEA);
    chartEA = new Chart(document.getElementById('chartEA'), {
      type: 'bar',
      data: {
        labels: eaLabels,
        datasets: [{ label: 'Animales', data: eaVals, backgroundColor: chartPalette.bars.fill, borderColor: chartPalette.bars.stroke, borderWidth: 1 }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { ticks: { color: '#cbd5e1' }, grid: { color: 'rgba(148,163,184,.15)' } },
          y: { ticks: { color: '#cbd5e1' }, grid: { color: 'rgba(148,163,184,.15)' }, beginAtZero: true }
        },
        plugins: {
          legend: { display: false },
          tooltip: { callbacks: {
            label: (ctx) => ` ${ctx.parsed.y} animales`
          }}
        }
      }
    });
    document.getElementById('chartEANote').textContent = `${eaLabels.length} categor√≠as`;

    // Edad hist (1 a√±o)
    const ages = rows.map(r => r.EdadAnios).filter(v => typeof v === 'number' && v > 0);
    let minA = 0, maxA = 0;
    if (ages.length) {
      minA = Math.floor(Math.min(...ages));
      maxA = Math.ceil(Math.max(...ages));
    }
    const bins = [];
    const labels = [];
    for (let a=minA; a<=maxA; a++) {
      labels.push(`${a}-${a+1}`);
      bins.push(0);
    }
    for (const v of ages) {
      const idx = Math.min(Math.max(Math.floor(v) - minA, 0), bins.length-1);
      if (bins[idx] !== undefined) bins[idx] += 1;
    }

    destroyIf(chartEdad);
    chartEdad = new Chart(document.getElementById('chartEdad'), {
      type: 'bar',
      data: {
        labels,
        datasets: [{ label: 'Animales', data: bins, backgroundColor: chartPalette.green.fill, borderColor: chartPalette.green.stroke, borderWidth: 1.5 }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { ticks: { color: '#cbd5e1' }, grid: { color: 'rgba(148,163,184,.15)' } },
          y: { ticks: { color: '#cbd5e1' }, grid: { color: 'rgba(148,163,184,.15)' }, beginAtZero: true }
        },
        plugins: { legend: { display: false } }
      }
    });

    // FPP by month (line) ‚Äî solo con fecha v√°lida
    const byMonth = new Map();
    for (const r of rows) {
      const mk = monthKey(r.FPP);
      if (!mk) continue;
      byMonth.set(mk, (byMonth.get(mk) || 0) + 1);
    }
    const mLabels = [...byMonth.keys()].sort();
    const mVals = mLabels.map(k => byMonth.get(k));

    destroyIf(chartFPP);
    chartFPP = new Chart(document.getElementById('chartFPP'), {
      type: 'line',
      data: {
        labels: mLabels,
        datasets: [{ label: 'Partos esperados', data: mVals, tension: 0.3, pointRadius: 3, borderColor: chartPalette.orange.stroke, backgroundColor: chartPalette.orange.fill, fill: true }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { ticks: { color: '#cbd5e1' }, grid: { color: 'rgba(148,163,184,.15)' } },
          y: { ticks: { color: '#cbd5e1' }, grid: { color: 'rgba(148,163,184,.15)' }, beginAtZero: true }
        },
        plugins: { legend: { display: false } }
      }
    });
  }

  // =========================
  // KPIs + Table
  // =========================
  function updateKPIs(rows) {
    const total = rows.length;
    const totalAll = RAW.length;

    const pren = rows.filter(r => (r.EstadoReprod || '').toLowerCase() === 'pre√±ada').length;
    const pPren = pct(pren, total);

    const ages = rows.map(r => r.EdadAnios).filter(v => typeof v === 'number' && v > 0);
    const avgAge = ages.length ? (ages.reduce((a,b)=>a+b,0) / ages.length) : null;

    const dab = rows.map(r => r.DAb).filter(v => typeof v === 'number' && v > 0);
    const avgDab = dab.length ? (dab.reduce((a,b)=>a+b,0) / dab.length) : null;

    document.getElementById('kpiTotal').textContent = total.toString();
    document.getElementById('kpiTotalHint').textContent = `De un total general de ${totalAll} animales`;

    document.getElementById('kpiPren').textContent = `${pPren.toFixed(1)}%`;
    document.getElementById('kpiPrenHint').textContent = `${pren} pre√±adas en el filtro actual`;

    document.getElementById('kpiEdad').textContent = avgAge === null ? '‚Äî' : fmt1(avgAge);
    document.getElementById('kpiDab').textContent = avgDab === null ? '‚Äî' : fmt0(avgDab);

    const crias = rows.map(r => r.C).filter(v => typeof v === 'number' && !Number.isNaN(v));
    const totalCrias = crias.length ? crias.reduce((a,b)=>a+b,0) : null;

    const partos = rows.map(r => r.P).filter(v => typeof v === 'number' && !Number.isNaN(v));
    const totalPartos = partos.length ? partos.reduce((a,b)=>a+b,0) : null;

    const abortos = rows.map(r => r.Abortos).filter(v => typeof v === 'number' && !Number.isNaN(v));
    const totalAbortos = abortos.length ? abortos.reduce((a,b)=>a+b,0) : null;

    const proxPartos = rows.filter(r => String(r.FPP || '').trim() !== '').length;

    const tpre = rows.map(r => String(r.TPre√±ez || r.TPre || r.TPreN || '').trim().toUpperCase());
    const tpreMN = tpre.filter(v => v === 'MN').length;
    const tpreIATF = tpre.filter(v => v === 'IATF').length;

    const elC = document.getElementById('kpiCrias');
    if (elC) elC.textContent = totalCrias === null ? '‚Äî' : fmt0(totalCrias);

    const elP = document.getElementById('kpiPartos');
    if (elP) elP.textContent = totalPartos === null ? '‚Äî' : fmt0(totalPartos);

    const elA = document.getElementById('kpiAbortos');
    if (elA) elA.textContent = totalAbortos === null ? '‚Äî' : fmt0(totalAbortos);

    const elPP = document.getElementById('kpiProxPartos');
    if (elPP) elPP.textContent = fmt0(proxPartos);

    const elMN = document.getElementById('kpiTPreMN');
    if (elMN) elMN.textContent = fmt0(tpreMN);
    const elI = document.getElementById('kpiTPreIATF');
    if (elI) elI.textContent = fmt0(tpreIATF);

    // Gestaci√≥n (prom.) ‚Äî ignora 0
    const gest = rows.map(r => r.Gest).filter(v => typeof v === 'number' && v > 0);
    const avgGest = gest.length ? (gest.reduce((a,b)=>a+b,0) / gest.length) : null;
    const elG = document.getElementById('kpiGest');
    if (elG) elG.textContent = avgGest === null ? '‚Äî' : fmt0(avgGest);

    // Tipo de Pre√±ez (Top)
    const tp = rows.map(r => (r.TPre√±ez || '').trim()).filter(v => v);
    let top = '';
    let topN = 0;
    if (tp.length) {
      const map = new Map();
      for (const v of tp) map.set(v, (map.get(v) || 0) + 1);
      let best = null;
      for (const [k, n] of map.entries()) {
        if (best === null || n > best[1] || (n === best[1] && String(k).localeCompare(String(best[0])) < 0)) {
          best = [k, n];
        }
      }
      if (best) { top = best[0]; topN = best[1]; }
    }
    const elT = document.getElementById('kpiTPre');
    const elTH = document.getElementById('kpiTPreHint');
    if (elT) elT.textContent = top ? top : '‚Äî';
    if (elTH) elTH.textContent = top ? `${topN} en el filtro actual` : 'Sin dato';
  }

  function updateTable(rows) {
    const sorted = sortRows(rows);
    const tb = document.getElementById('tBody');
    tb.innerHTML = '';

    const pageSize = parseInt((pageSizeEl && pageSizeEl.value) ? pageSizeEl.value : '50', 10) || 50;
    const totalPages = Math.max(1, Math.ceil(sorted.length / pageSize));
    if (PAGE > totalPages) PAGE = totalPages;
    if (PAGE < 1) PAGE = 1;

    const start = (PAGE - 1) * pageSize;
    const view = sorted.slice(start, start + pageSize);

    for (const r of view) {
      const tr = document.createElement('tr');
      tr.className = 'hover:bg-slate-950/30';
      
      tr.innerHTML = `
        <td class="px-3 py-2 whitespace-nowrap">${r.Numero}</td>
        <td class="px-3 py-2 whitespace-nowrap">${r.Nombre || ''}</td>
        <td class="px-3 py-2 whitespace-nowrap">${r.EA || ''}</td>
        <td class="px-3 py-2 whitespace-nowrap">${r.EstadoReprod || ''}</td>
        <td class="px-3 py-2 whitespace-nowrap text-right">${r.Gest ?? ''}</td>
        <td class="px-3 py-2 whitespace-nowrap">${r.TPre√±ez || ''}</td>
        <td class="px-3 py-2 whitespace-nowrap">${r.EdadTexto || ''}</td>
        <td class="px-3 py-2 whitespace-nowrap">${r.FPre√± || ''}</td>
        <td class="px-3 py-2 whitespace-nowrap">${r.FPP || ''}</td>
        <td class="px-3 py-2 whitespace-nowrap text-right">${r.P ?? ''}</td>
        <td class="px-3 py-2 whitespace-nowrap text-right">${r.C ?? ''}</td>        <td class="px-3 py-2 whitespace-nowrap text-right">${r.DAb ?? ''}</td>
      `;
      tb.appendChild(tr);
    }

    const from = sorted.length ? (start + 1) : 0;
    const to = start + view.length;

    const tCountEl = document.getElementById('tCount');
    if (tCountEl) tCountEl.textContent = `Mostrando ${from}-${to} de ${sorted.length} registros (filtrados)`;

    if (pageInfoEl) pageInfoEl.textContent = `P√°gina ${PAGE} de ${totalPages}`;

    const setDisabled = (btn, disabled) => {
      if (!btn) return;
      btn.disabled = disabled;
      btn.classList.toggle('opacity-40', disabled);
      btn.classList.toggle('cursor-not-allowed', disabled);
    };

    setDisabled(pagePrevEl, PAGE <= 1);
    setDisabled(pageNextEl, PAGE >= totalPages);
  }

  function render() {
    const rows = applyFilters();
    updateKPIs(rows);
    buildCharts(rows);
    updateTable(rows);
  }

  // Events (inputs normales)
  [fEdadMin, fEdadMax, fSearch, tSort].forEach(el => {
    const rer = () => { PAGE = 1; render(); };
    el.addEventListener('input', rer);
    el.addEventListener('change', rer);
  });

  // Paginaci√≥n
  if (pagePrevEl) pagePrevEl.addEventListener('click', () => { if (PAGE > 1) { PAGE--; render(); } });
  if (pageNextEl) pageNextEl.addEventListener('click', () => { PAGE++; render(); });
  if (pageSizeEl) pageSizeEl.addEventListener('change', () => { PAGE = 1; render(); });

  // Reset
  document.getElementById('btnReset').addEventListener('click', () => {
    PAGE = 1;

    MS.Finca.selected.clear();
    MS.Estado.selected.clear();
    MS.EA.selected.clear();
    MS.TPre.selected.clear();
    msSync(MS.Finca);
    msSync(MS.Estado);
    msSync(MS.EA);
    msSync(MS.TPre);

    fEdadMin.value = '';
    fEdadMax.value = '';
    fSearch.value = '';
    tSort.value = 'EdadAnios_desc';
    render();
  });

  // =========================
  // CSV Upload (GANADERO SG)
  // =========================
  const csvFile = document.getElementById('csvFile');
  const csvStatus = document.getElementById('csvStatus');

  function setStatus(msg) { if (csvStatus) csvStatus.textContent = msg; }

  function fincaShortName(s) {
    const raw = String(s || '').trim();
    // Ej: 'ES-005 - LOS CARBONALES' -> 'Los Carbonales'
    const m = raw.match(/ES-\d+\s*-\s*(.+)$/i);
    const name = (m ? m[1] : raw).trim();
    // Title Case suave
    return name.toLowerCase().split(' ').filter(Boolean).map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
  }

  function canonKey(s) {
    return (s ?? '')
      .toString()
      .trim()
      .toLowerCase()
      .normalize('NFD').replace(/\p{Diacritic}/gu, '')
      .replace(/[^a-z0-9]+/g, '');
  }

  function parseDateFlexible(v) {
    if (v === null || v === undefined) return '';
    const s = String(v).trim();
    if (!s) return '';
    const compact = s.replace(/\s+/g,'');
    if (compact === '-' || compact === '--' || compact === '---') return '';
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
    if (m) {
      let d = parseInt(m[1], 10);
      let mo = parseInt(m[2], 10);
      let y = parseInt(m[3], 10);
      if (y < 100) y = 2000 + y;
      const iso = new Date(Date.UTC(y, mo - 1, d));
      if (!Number.isNaN(iso.getTime())) return iso.toISOString().slice(0,10);
    }
    return '';
  }

  function toNum(v) {
    if (v === null || v === undefined) return null;
    const s = String(v).trim();
    if (!s) return null;
    const compact = s.replace(/\s+/g,'');
    if (compact === '-' || compact === '--' || compact === '---') return null;
    const n = Number(s.replace(',', '.'));
    return Number.isFinite(n) ? n : null;
  }

  function mapCsvRow(row) {
    const dict = {};
    for (const [k, v] of Object.entries(row)) dict[canonKey(k)] = v;

    const pick = (...keys) => {
      for (const k of keys) {
        const ck = canonKey(k);
        if (ck in dict) return dict[ck];
      }
      return undefined;
    };

    return {
      Numero: String(pick('Numero','N√∫mero','N') ?? '').trim(),
      Nombre: String(pick('Nombre') ?? '').trim(),
      EdadMeses: toNum(pick('EdadMeses','E.Mes','EMes','E Mes')),
      EdadAnios: toNum(pick('EdadAnios','E. A√±os','E.A√±os','EA√±os','E Anos','E. Anos','A√±os','Anios')),
      EdadTexto: String(pick('EdadTexto','Edad A√±o - Mes','Edad Ano - Mes') ?? '').trim(),
      EA: String(pick('EA') ?? '').trim(),
      DPar: toNum(pick('DPar')),
      C: toNum(pick('#C','C','#c')),
      P: toNum(pick('#P','P','#p')),
      Abortos: toNum(pick('# Abortos','Abortos')),
      FUltPar: parseDateFlexible(pick('F.√ölt.Par','F.Ult.Par','FUltPar','F. Ult. Par','F.√ölt Par')),
      Gest: toNum(pick('Gest.','Gest','Gestacion','Gestaci√≥n')),
      TPre√±ez: String(pick('TPre√±ez','Tipo de Pre√±ez','TipoPre√±ez') ?? '').trim(),
      FPre√±: parseDateFlexible(pick('F. Pre√±','FPre√±','FPre√±ada')),
      EstadoReprod: String(pick('Estado reprod.','Estado reprod','EstadoReprod') ?? '').trim(),
      DAb: toNum(pick('D.Ab','DAb')),
      FPP: parseDateFlexible(pick('F. P. P','FPP')),
      UIEP: toNum(pick('UIEP')),
      DEL: toNum(pick('DEL'))
    };
  }

  
  // =========================
  // Multi-CSV Upload (varios archivos)
  // =========================
  function parseCSVText(file, text) {
    // devuelve { rows, meta } o lanza error
    text = String(text || '');
    text = text.replace(/^\uFEFF+/, ''); // BOM
    text = text.replace(/^\uFEFF+/, '');

    const lines = text.split(/\r\n|\n|\r/);

    // detector robusto de encabezados (score por columnas)
    const want = ['no.', 'numero', 'n√∫mero', 'nombre', 'e.mes', 'e. a√±os', 'edad a√±o - mes', 'ea', 'estado reprod', 'tpre√±ez', 'gest.', 'f. p. p'];
    const scoreLine = (L) => {
      const low = String(L || '').toLowerCase();
      let s = 0;
      for (const w of want) if (low.includes(w)) s += 1;
      // penaliza l√≠neas "N√∫mero = ..." descriptivas
      if (low.includes('= n√∫mero del animal') || low.includes('numero =')) s -= 3;
      return s;
    };

    let headerIdx = -1;
    let bestScore = -999;
    for (let i = 0; i < Math.min(lines.length, 80); i++) {
      const sc = scoreLine(lines[i]);
      if (sc > bestScore) { bestScore = sc; headerIdx = i; }
    }
    if (bestScore < 3) headerIdx = -1;
    if (headerIdx === -1) {
      // fallback viejo
      headerIdx = lines.findIndex(L => /N[√∫u]mero/i.test(L) && /Nombre/i.test(L) && /E\.?Mes/i.test(L));
    }
    if (headerIdx === -1) throw new Error('No encontr√© la fila de encabezados (N√∫mero;Nombre;E.Mes‚Ä¶).');

    const headerLine = lines[headerIdx] || '';
    const semi = (headerLine.match(/;/g) || []).length;
    const comma = (headerLine.match(/,/g) || []).length;
    const delimiter = semi >= comma ? ';' : ',';

    // meta desde pre√°mbulo
    let actualizado = '';
    let impresion = '';
    let finca = '';
    for (const L of lines.slice(0, headerIdx)) {
      const mA = L.match(/Actualizado\s*a:\s*([^;]+)/i);
      if (mA) actualizado = mA[1].trim();
      const mI = L.match(/Impresi[√≥o]n:\s*([^;]+)/i);
      if (mI) impresion = mI[1].trim();
      if (!finca && /ES-\d+\s*-\s*/i.test(L)) finca = L.split(';')[0].trim();
    }

    const dataText = lines.slice(headerIdx).join('\n');

    const parsed = Papa.parse(dataText, {
      header: true,
      skipEmptyLines: true,
      delimiter
    });

    if (parsed.errors && parsed.errors.length) {
      // No abortamos por warnings, pero si es grave el parse
      // (PapaParse suele llenar errors por l√≠neas raras; aqu√≠ lo ignoramos)
    }

    const raw = Array.isArray(parsed.data) ? parsed.data : [];
    const rows = raw
      .filter(r => r && Object.values(r).some(v => String(v ?? '').trim() !== ''))
      .map(mapCsvRow)
      .filter(r => (r.Numero || r.Nombre) && !String(r.Numero || '').toLowerCase().includes('total animales'));

    const fincaName = fincaShortName(finca || file.name.replace(/\.[^.]+$/,'') || '');
    rows.forEach(r => { r.Finca = fincaName; if (r.TPre√±ez === undefined) r.TPre√±ez = ''; });

    return {
      rows,
      meta: {
        fincaRaw: finca || '',
        fincaName,
        actualizado,
        impresion
      }
    };
  }

  async function loadCSVFiles(files) {
    if (!files || !files.length) return;

    setStatus(`Leyendo ${files.length} archivo(s)‚Ä¶`);

    // Reset filtros para evitar "0" por filtros previos
    MS.Finca.selected.clear();
    MS.Estado.selected.clear();
    MS.EA.selected.clear();
    MS.TPre.selected.clear();
    fEdadMin.value = '';
    fEdadMax.value = '';
    fSearch.value = '';
    tSort.value = 'EdadAnios_desc';
    PAGE = 1;

    const allRows = [];
    const metas = [];

    // lectura secuencial para evitar condiciones de carrera
    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      try {
        const text = await file.text();
        const out = parseCSVText(file, text);
        if (out.rows && out.rows.length) allRows.push(...out.rows);
        metas.push({ fileName: file.name, ...out.meta });
        setStatus(`Cargando (${i+1}/${files.length}): ${file.name}‚Ä¶`);
      } catch (err) {
        console.error(err);
        setStatus(`Error en ${file.name}: ${err?.message || 'No se pudo leer'}`);
        // sigue con los dem√°s
      }
    }

    if (!allRows.length) {
      setStatus('No se detectaron filas v√°lidas en los CSV.');
      return;
    }

    RAW = allRows;
    initFilters();

  // Filtro por defecto: Las Cuchillas
  const defaultFinca = 'Las Cuchillas';
  if (MS.Finca && MS.Finca.options && MS.Finca.options.includes(defaultFinca)) {
    MS.Finca.selected = new Set([defaultFinca]);
    msSync(MS.Finca);
  }
    render();

    // meta visible: si son varios, mostrar resumen
    const fincasUniq = uniqSorted(metas.map(m => m.fincaName).filter(Boolean));
    META = {
      titulo: fincasUniq.length ? fincasUniq.join(' / ') : '',
      fuente: `Archivos: ${files.length}`,
      actualizado: metas.find(m => m.actualizado)?.actualizado ? `Actualizado a: ${metas.find(m => m.actualizado).actualizado}` : '',
      impresion: metas.find(m => m.impresion)?.impresion ? `Impresi√≥n: ${metas.find(m => m.impresion).impresion}` : ''
    };
    if (metaEl) metaEl.textContent = formatMeta(META) || metaEl.textContent;

    setStatus(`Cargados ${files.length} archivo(s) ‚Äî ${allRows.length} registros`);
  }

function loadCSVFile(file) {
    if (!file) return;
    setStatus(`Leyendo: ${file.name} ‚Ä¶`);

    const reader = new FileReader();
    reader.onerror = () => setStatus('Error leyendo el archivo.');
    reader.onload = () => {
      try {
        let text = String(reader.result || '');
        text = text.replace(/^\uFEFF+/, ''); // BOM
        text = text.replace(/^\uFEFF+/, '');

        const lines = text.split(/\r\n|\n|\r/);

        // encontrar la fila real de encabezados (robusto)
        // Elegimos la l√≠nea que "parece" encabezado por score de columnas esperadas + cantidad de delimitadores
        let headerIdx = -1;
        let bestScore = -1;

        const scoreHeaderLine = (L) => {
          const s = String(L || '');
          const semi = (s.match(/;/g) || []).length;
          const comma = (s.match(/,/g) || []).length;
          const delims = Math.max(semi, comma);

          // tokens t√≠picos de encabezado en reportes GANADERO SG
          const hasNumero = /N[√∫u]mero/i.test(s);
          const hasNombre = /Nombre/i.test(s);
          const hasEMes = /E\.?\s*Mes/i.test(s);
          const hasEA = /(^|[;,\s])EA([;,\s]|$)/i.test(s);
          const hasEstadoReprod = /Estado\s*reprod/i.test(s);
          const hasDAb = /D\.?\s*Ab/i.test(s) || /D\.?\s*Abiertos/i.test(s);
          const hasGest = /Gest\.?/i.test(s) || /Gestaci[√≥o]n/i.test(s);
          const hasTPre = /T\s*Pre√±|TPre√±|TPre√±ez|Tipo\s*de\s*Pre√±/i.test(s);
          const hasNo = /^(\s*No\.|\s*#)/i.test(s);

          // score: prioriza que contenga Estado reprod. y que tenga varias columnas
          let score = 0;
          if (hasNumero) score += 2;
          if (hasNombre) score += 2;
          if (hasEMes) score += 2;
          if (hasEA) score += 1;
          if (hasEstadoReprod) score += 3;
          if (hasDAb) score += 1;
          if (hasGest) score += 1;
          if (hasTPre) score += 1;
          if (hasNo) score += 1;

          // penaliza l√≠neas con pocos delimitadores
          if (delims < 6) score -= 3;

          return { score, delims };
        };

        for (let i = 0; i < lines.length; i++) {
          const L = lines[i] || '';
          const { score, delims } = scoreHeaderLine(L);
          if (score > bestScore) {
            bestScore = score;
            headerIdx = i;
          }
        }

        // umbral m√≠nimo
        if (headerIdx === -1 || bestScore < 5) {
          setStatus('No encontr√© la fila de encabezados (N√∫mero;Nombre;E.Mes‚Ä¶ Estado reprod.).');
          return;
        }

        const headerLine = lines[headerIdx] || '';
        const semi = (headerLine.match(/;/g) || []).length;
        const comma = (headerLine.match(/,/g) || []).length;
        const delimiter = semi >= comma ? ';' : ',';

        // meta desde pre√°mbulo
        let actualizado = '';
        let impresion = '';
        let finca = '';
        for (const L of lines.slice(0, headerIdx)) {
          const mA = L.match(/Actualizado\s*a:\s*([^;]+)/i);
          if (mA) actualizado = mA[1].trim();
          const mI = L.match(/Impresi[√≥o]n:\s*([^;]+)/i);
          if (mI) impresion = mI[1].trim();
          if (!finca && /ES-\d+\s*-\s*/i.test(L)) finca = L.split(';')[0].trim();
        }

        const dataText = lines.slice(headerIdx).join('\n');

        Papa.parse(dataText, {
          header: true,
          skipEmptyLines: true,
          delimiter,
          complete: (res) => {
            const raw = Array.isArray(res.data) ? res.data : [];
            const rows = raw
              .filter(r => r && Object.values(r).some(v => String(v ?? '').trim() !== ''))
              .map(mapCsvRow)
              .filter(r => (r.Numero || r.Nombre) && !String(r.Numero || '').toLowerCase().includes('total animales'));

            if (!rows.length) { setStatus('No se detectaron filas v√°lidas en el CSV.'); return; }

            const fincaName = fincaShortName(finca || file.name.replace(/\.[^.]+$/,'') || '');
            rows.forEach(r => { r.Finca = fincaName; if (r.TPre√±ez === undefined) r.TPre√±ez = ''; });

            // set data
            RAW = rows;

            // reset filtros (para evitar 0 por filtros previos)
            MS.Finca.selected.clear();
            MS.Estado.selected.clear();
            MS.EA.selected.clear();
            MS.TPre.selected.clear();
            fEdadMin.value = '';
            fEdadMax.value = '';
            fSearch.value = '';
            tSort.value = 'EdadAnios_desc';

            PAGE = 1;
            initFilters();

  // Filtro por defecto: Las Cuchillas
  const defaultFinca = 'Las Cuchillas';
  if (MS.Finca && MS.Finca.options && MS.Finca.options.includes(defaultFinca)) {
    MS.Finca.selected = new Set([defaultFinca]);
    msSync(MS.Finca);
  }
            render();

            // meta visible
            META = {
              titulo: finca || '',
              fuente: `Archivo: ${file.name}`,
              actualizado: actualizado ? `Actualizado a: ${actualizado}` : '',
              impresion: impresion ? `Impresi√≥n: ${impresion}` : ''
            };
            if (metaEl) metaEl.textContent = formatMeta(META) || metaEl.textContent;

            setStatus(`Cargado: ${file.name} ‚Äî ${rows.length} registros`);
          },
          error: (err) => {
            console.error(err);
            setStatus('Error parseando el CSV.');
          }
        });
      } catch (e) {
        console.error(e);
        setStatus('Error procesando el archivo CSV.');
      }
    };

    reader.readAsText(file, 'utf-8');
  }

  if (csvFile) {
    csvFile.addEventListener('change', (e) => {
      const files = e.target.files ? Array.from(e.target.files) : [];
      loadCSVFiles(files);
    });
  }

  // =========================
  // Export HTML (incluye datos)
  // =========================
  document.getElementById('btnExportHTML').addEventListener('click', () => {
    const state = {
      data: RAW,
      filters: {
        Finca: [...MS.Finca.selected],
        EstadoReprod: [...MS.Estado.selected],
        EA: [...MS.EA.selected],
        TPre: [...MS.TPre.selected],
        q: fSearch.value.trim(),
        EdadMin: fEdadMin.value,
        EdadMax: fEdadMax.value,
        sort: tSort.value,
        pageSize: (pageSizeEl && pageSizeEl.value) ? pageSizeEl.value : '50'
      },
      meta: {
        ...META,
        exportedAt: new Date().toISOString(),
        title: document.title
      }
    };

    const docHtml = '<!DOCTYPE html>\n' + document.documentElement.outerHTML;
    const inject = `\n<script>\nwindow.__EXPORTED_STATE__ = ${JSON.stringify(state)};\n<\/script>\n`;

    const m = docHtml.match(/<body[^>]*>/i);
    let out = docHtml;
    if (m && typeof m.index === 'number') {
      const i = m.index + m[0].length;
      out = docHtml.slice(0, i) + inject + docHtml.slice(i);
    } else {
      out = inject + docHtml;
    }

    const blob = new Blob([out], { type: 'text/html;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `dashboard_palpacion_las_cuchillas_export_${new Date().toISOString().slice(0,10)}.html`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(a.href), 1500);
  });

  // =========================
  // Init + restore state
  // =========================
  if (window.__EXPORTED_STATE__ && window.__EXPORTED_STATE__.filters) {
    const s = window.__EXPORTED_STATE__.filters;

    if (Array.isArray(s.Finca)) {
      MS.Finca.selected = new Set(s.Finca.map(v => String(v)));
    } else if (typeof s.Finca === 'string' && s.Finca.trim()) {
      MS.Finca.selected = new Set([s.Finca.trim()]);
    }

    if (Array.isArray(s.TPre)) {
      MS.TPre.selected = new Set(s.TPre.map(v => String(v)));
    } else if (typeof s.TPre === 'string' && s.TPre.trim()) {
      MS.TPre.selected = new Set([s.TPre.trim()]);
    }


    // soporte arrays (multi) y legacy string
    if (Array.isArray(s.EstadoReprod)) {
      MS.Estado.selected = new Set(s.EstadoReprod.map(v => String(v)));
    } else if (typeof s.EstadoReprod === 'string' && s.EstadoReprod.trim()) {
      MS.Estado.selected = new Set([s.EstadoReprod.trim()]);
    }

    if (Array.isArray(s.EA)) {
      MS.EA.selected = new Set(s.EA.map(v => String(v)));
    } else if (typeof s.EA === 'string' && s.EA.trim()) {
      MS.EA.selected = new Set([s.EA.trim()]);
    }

    if (typeof s.q === 'string') fSearch.value = s.q;
    if (typeof s.EdadMin === 'string') fEdadMin.value = s.EdadMin;
    if (typeof s.EdadMax === 'string') fEdadMax.value = s.EdadMax;
    if (typeof s.sort === 'string') tSort.value = s.sort;
    if (typeof s.pageSize === 'string' && pageSizeEl) pageSizeEl.value = s.pageSize;
  }

  initFilters();

  // Filtro por defecto: Las Cuchillas
  const defaultFinca = 'Las Cuchillas';
  if (MS.Finca && MS.Finca.options && MS.Finca.options.includes(defaultFinca)) {
    MS.Finca.selected = new Set([defaultFinca]);
    msSync(MS.Finca);
  }
  render();
</script>
</body>
</html>
