<!DOCTYPE html>
<html lang="es"><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Informe Ganadería PLATOR S.A.</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
    .sidebar-item.active { background-color: rgba(255,255,255,0.10); color: white; border-left: 4px solid #60a5fa; }
    .drop-zone { border: 2px dashed #334155; transition: all 0.3s ease; background-color: rgba(255,255,255,0.02); }
    .drop-zone.over { border-color: #60a5fa; background-color: rgba(96, 165, 250, 0.12); }
    .btn-action { transition: all 0.2s ease; }
    .btn-action:active { transform: scale(0.95); }

    /* Sidebar scrollbar (elegante, combina con azul oscuro) */
    .sidebar-scroll { scrollbar-width: thin; scrollbar-color: rgba(96,165,250,0.55) rgba(255,255,255,0.06); }
    .sidebar-scroll::-webkit-scrollbar { width: 10px; }
    .sidebar-scroll::-webkit-scrollbar-track { background: rgba(255,255,255,0.06); border-radius: 9999px; }
    .sidebar-scroll::-webkit-scrollbar-thumb { background: rgba(96,165,250,0.45); border-radius: 9999px; border: 2px solid rgba(2,6,23,0.55); }
    .sidebar-scroll::-webkit-scrollbar-thumb:hover { background: rgba(96,165,250,0.65); }

    
    /* Tarjetas / paneles: más profundidad, menos “blanco plano” */
    #dashboardContent .bg-white.rounded-2xl,
    #dashboardContent .bg-white.rounded-xl,
    #dashboardContent .bg-white.rounded-lg {
      border-color: rgba(148, 163, 184, 0.50) !important; /* slate */
      box-shadow:
        0 10px 28px -18px rgba(15, 23, 42, 0.50),
        0 2px 8px rgba(15, 23, 42, 0.06);
      background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(248,250,252,0.96));
    }

    @media print { .no-print { display: none; } }
  
/* Animación al cambiar de sección */
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(6px); }
  to   { opacity: 1; transform: translateY(0); }
}
.section-fade-in {
  animation: fadeInUp 320ms ease-out both;
}



/* Animación suave para tarjetas de gráficos */
@keyframes chartIn {
  from { opacity: 0; transform: translateY(10px) scale(0.985); }
  to   { opacity: 1; transform: translateY(0) scale(1); }
}
.chart-pop {
  animation: chartIn 520ms cubic-bezier(.2,.8,.2,1) both;
}
</style>
<style>*, ::before, ::after{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }::backdrop{--tw-border-spacing-x:0;--tw-border-spacing-y:0;--tw-translate-x:0;--tw-translate-y:0;--tw-rotate:0;--tw-skew-x:0;--tw-skew-y:0;--tw-scale-x:1;--tw-scale-y:1;--tw-pan-x: ;--tw-pan-y: ;--tw-pinch-zoom: ;--tw-scroll-snap-strictness:proximity;--tw-gradient-from-position: ;--tw-gradient-via-position: ;--tw-gradient-to-position: ;--tw-ordinal: ;--tw-slashed-zero: ;--tw-numeric-figure: ;--tw-numeric-spacing: ;--tw-numeric-fraction: ;--tw-ring-inset: ;--tw-ring-offset-width:0px;--tw-ring-offset-color:#fff;--tw-ring-color:rgb(59 130 246 / 0.5);--tw-ring-offset-shadow:0 0 #0000;--tw-ring-shadow:0 0 #0000;--tw-shadow:0 0 #0000;--tw-shadow-colored:0 0 #0000;--tw-blur: ;--tw-brightness: ;--tw-contrast: ;--tw-grayscale: ;--tw-hue-rotate: ;--tw-invert: ;--tw-saturate: ;--tw-sepia: ;--tw-drop-shadow: ;--tw-backdrop-blur: ;--tw-backdrop-brightness: ;--tw-backdrop-contrast: ;--tw-backdrop-grayscale: ;--tw-backdrop-hue-rotate: ;--tw-backdrop-invert: ;--tw-backdrop-opacity: ;--tw-backdrop-saturate: ;--tw-backdrop-sepia: ;--tw-contain-size: ;--tw-contain-layout: ;--tw-contain-paint: ;--tw-contain-style: }/* ! tailwindcss v3.4.17 | MIT License | https://tailwindcss.com */*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}::after,::before{--tw-content:''}:host,html{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,pre,samp{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-feature-settings:normal;font-variation-settings:normal;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}button,input,optgroup,select,textarea{font-family:inherit;font-feature-settings:inherit;font-variation-settings:inherit;font-size:100%;font-weight:inherit;line-height:inherit;letter-spacing:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}button,input:where([type=button]),input:where([type=reset]),input:where([type=submit]){-webkit-appearance:button;background-color:transparent;background-image:none}:-moz-focusring{outline:auto}:-moz-ui-invalid{box-shadow:none}progress{vertical-align:baseline}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}fieldset{margin:0;padding:0}legend{padding:0}menu,ol,ul{list-style:none;margin:0;padding:0}dialog{padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]:where(:not([hidden=until-found])){display:none}.pointer-events-none{pointer-events:none}.mb-1{margin-bottom:0.25rem}.mb-2{margin-bottom:0.5rem}.mb-4{margin-bottom:1rem}.mb-8{margin-bottom:2rem}.mr-3{margin-right:0.75rem}.mt-1{margin-top:0.25rem}.mt-3{margin-top:0.75rem}.mt-auto{margin-top:auto}.mb-3{margin-bottom:0.75rem}.mt-2{margin-top:0.5rem}.flex{display:flex}.grid{display:grid}.hidden{display:none}.h-16{height:4rem}.h-4{height:1rem}.h-5{height:1.25rem}.h-72{height:18rem}.h-screen{height:100vh}.h-\[360px\]{height:360px}.h-\[320px\]{height:320px}.h-\[380px\]{height:380px}.w-16{width:4rem}.w-4{width:1rem}.w-5{width:1.25rem}.w-72{width:18rem}.w-full{width:100%}.min-w-\[180px\]{min-width:180px}.min-w-\[220px\]{min-width:220px}.min-w-full{min-width:100%}.flex-1{flex:1 1 0%}.cursor-pointer{cursor:pointer}.grid-cols-1{grid-template-columns:repeat(1, minmax(0, 1fr))}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-start{align-items:flex-start}.items-end{align-items:flex-end}.items-center{align-items:center}.justify-center{justify-content:center}.justify-between{justify-content:space-between}.gap-1{gap:0.25rem}.gap-2{gap:0.5rem}.gap-3{gap:0.75rem}.gap-4{gap:1rem}.gap-6{gap:1.5rem}.space-y-2 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(0.5rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(0.5rem * var(--tw-space-y-reverse))}.space-y-6 > :not([hidden]) ~ :not([hidden]){--tw-space-y-reverse:0;margin-top:calc(1.5rem * calc(1 - var(--tw-space-y-reverse)));margin-bottom:calc(1.5rem * var(--tw-space-y-reverse))}.divide-y > :not([hidden]) ~ :not([hidden]){--tw-divide-y-reverse:0;border-top-width:calc(1px * calc(1 - var(--tw-divide-y-reverse)));border-bottom-width:calc(1px * var(--tw-divide-y-reverse))}.overflow-hidden{overflow:hidden}.overflow-x-auto{overflow-x:auto}.overflow-y-auto{overflow-y:auto}.rounded-full{border-radius:9999px}.rounded-lg{border-radius:0.5rem}.rounded-xl{border-radius:0.75rem}.rounded-2xl{border-radius:1rem}.border{border-width:1px}.border-b{border-bottom-width:1px}.border-r{border-right-width:1px}.border-t{border-top-width:1px}.border-slate-200{--tw-border-opacity:1;border-color:rgb(226 232 240 / var(--tw-border-opacity, 1))}.border-slate-800{--tw-border-opacity:1;border-color:rgb(30 41 59 / var(--tw-border-opacity, 1))}.border-slate-800\/60{border-color:rgb(30 41 59 / 0.6)}.border-slate-200\/70{border-color:rgb(226 232 240 / 0.7)}.border-slate-100{--tw-border-opacity:1;border-color:rgb(241 245 249 / var(--tw-border-opacity, 1))}.bg-blue-600{--tw-bg-opacity:1;background-color:rgb(37 99 235 / var(--tw-bg-opacity, 1))}.bg-slate-50{--tw-bg-opacity:1;background-color:rgb(248 250 252 / var(--tw-bg-opacity, 1))}.bg-slate-950\/30{background-color:rgb(2 6 23 / 0.3)}.bg-transparent{background-color:transparent}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255 / var(--tw-bg-opacity, 1))}.bg-gradient-to-b{background-image:linear-gradient(to bottom, var(--tw-gradient-stops))}.bg-gradient-to-br{background-image:linear-gradient(to bottom right, var(--tw-gradient-stops))}.from-slate-50{--tw-gradient-from:#f8fafc var(--tw-gradient-from-position);--tw-gradient-to:rgb(248 250 252 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.from-slate-900{--tw-gradient-from:#0f172a var(--tw-gradient-from-position);--tw-gradient-to:rgb(15 23 42 / 0) var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), var(--tw-gradient-to)}.via-blue-50{--tw-gradient-to:rgb(239 246 255 / 0)  var(--tw-gradient-to-position);--tw-gradient-stops:var(--tw-gradient-from), #eff6ff var(--tw-gradient-via-position), var(--tw-gradient-to)}.to-slate-100{--tw-gradient-to:#f1f5f9 var(--tw-gradient-to-position)}.to-slate-950{--tw-gradient-to:#020617 var(--tw-gradient-to-position)}.p-4{padding:1rem}.p-6{padding:1.5rem}.p-8{padding:2rem}.p-5{padding:1.25rem}.px-3{padding-left:0.75rem;padding-right:0.75rem}.px-4{padding-left:1rem;padding-right:1rem}.px-6{padding-left:1.5rem;padding-right:1.5rem}.py-1{padding-top:0.25rem;padding-bottom:0.25rem}.py-2{padding-top:0.5rem;padding-bottom:0.5rem}.py-3{padding-top:0.75rem;padding-bottom:0.75rem}.px-2{padding-left:0.5rem;padding-right:0.5rem}.pt-2{padding-top:0.5rem}.pb-8{padding-bottom:2rem}.text-left{text-align:left}.text-center{text-align:center}.text-right{text-align:right}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-\[10px\]{font-size:10px}.text-sm{font-size:0.875rem;line-height:1.25rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-xs{font-size:0.75rem;line-height:1rem}.text-2xl{font-size:1.5rem;line-height:2rem}.font-bold{font-weight:700}.font-medium{font-weight:500}.font-semibold{font-weight:600}.uppercase{text-transform:uppercase}.leading-relaxed{line-height:1.625}.tracking-tight{letter-spacing:-0.025em}.tracking-widest{letter-spacing:0.1em}.tracking-wide{letter-spacing:0.025em}.text-blue-400{--tw-text-opacity:1;color:rgb(96 165 250 / var(--tw-text-opacity, 1))}.text-blue-600{--tw-text-opacity:1;color:rgb(37 99 235 / var(--tw-text-opacity, 1))}.text-slate-100{--tw-text-opacity:1;color:rgb(241 245 249 / var(--tw-text-opacity, 1))}.text-slate-200{--tw-text-opacity:1;color:rgb(226 232 240 / var(--tw-text-opacity, 1))}.text-slate-300{--tw-text-opacity:1;color:rgb(203 213 225 / var(--tw-text-opacity, 1))}.text-slate-400{--tw-text-opacity:1;color:rgb(148 163 184 / var(--tw-text-opacity, 1))}.text-slate-400\/80{color:rgb(148 163 184 / 0.8)}.text-slate-500{--tw-text-opacity:1;color:rgb(100 116 139 / var(--tw-text-opacity, 1))}.text-slate-800{--tw-text-opacity:1;color:rgb(30 41 59 / var(--tw-text-opacity, 1))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity, 1))}.text-emerald-600{--tw-text-opacity:1;color:rgb(5 150 105 / var(--tw-text-opacity, 1))}.text-rose-600{--tw-text-opacity:1;color:rgb(225 29 72 / var(--tw-text-opacity, 1))}.text-slate-700{--tw-text-opacity:1;color:rgb(51 65 85 / var(--tw-text-opacity, 1))}.opacity-20{opacity:0.2}.opacity-50{opacity:0.5}.shadow-lg{--tw-shadow:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-sm{--tw-shadow:0 1px 2px 0 rgb(0 0 0 / 0.05);--tw-shadow-colored:0 1px 2px 0 var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow)}.shadow-blue-200{--tw-shadow-color:#bfdbfe;--tw-shadow:var(--tw-shadow-colored)}.outline-none{outline:2px solid transparent;outline-offset:2px}.transition-colors{transition-property:color, background-color, border-color, fill, stroke, -webkit-text-decoration-color;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke;transition-property:color, background-color, border-color, text-decoration-color, fill, stroke, -webkit-text-decoration-color;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.hover\:border-slate-700:hover{--tw-border-opacity:1;border-color:rgb(51 65 85 / var(--tw-border-opacity, 1))}.hover\:bg-blue-700:hover{--tw-bg-opacity:1;background-color:rgb(29 78 216 / var(--tw-bg-opacity, 1))}.hover\:bg-white\/5:hover{background-color:rgb(255 255 255 / 0.05)}.hover\:bg-slate-50:hover{--tw-bg-opacity:1;background-color:rgb(248 250 252 / var(--tw-bg-opacity, 1))}.hover\:underline:hover{-webkit-text-decoration-line:underline;text-decoration-line:underline}.focus\:ring-2:focus{--tw-ring-offset-shadow:var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);--tw-ring-shadow:var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);box-shadow:var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000)}.focus\:ring-blue-500:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(59 130 246 / var(--tw-ring-opacity, 1))}@media (min-width: 768px){.md\:grid-cols-3{grid-template-columns:repeat(3, minmax(0, 1fr))}.md\:grid-cols-2{grid-template-columns:repeat(2, minmax(0, 1fr))}}@media (min-width: 1024px){.lg\:grid-cols-2{grid-template-columns:repeat(2, minmax(0, 1fr))}}@media (min-width: 1280px){.xl\:grid-cols-2{grid-template-columns:repeat(2, minmax(0, 1fr))}.xl\:grid-cols-4{grid-template-columns:repeat(4, minmax(0, 1fr))}}</style></head>

<body class="flex h-screen overflow-hidden bg-gradient-to-br from-slate-50 via-blue-50 to-slate-100">

  <!-- SIDEBAR -->
  <aside class="w-72 bg-gradient-to-b from-slate-900 to-slate-950 border-r border-slate-800 flex flex-col no-print">
    <div class="p-6 border-b border-slate-800">
      <h1 class="text-xl font-bold text-slate-100 tracking-tight">Informe Ganadería <span class="text-blue-400">PLATOR S.A.</span></h1>
      <p class="text-xs text-slate-300 mt-1"></p>
    </div>

    <nav class="flex-1 p-4 space-y-2 overflow-y-auto sidebar-scroll">
  <div class="pt-2"><p class="text-[10px] font-bold text-slate-400/80 uppercase tracking-widest px-3 mb-2">Módulos</p></div>
  <button id="nav-inventario_general" onclick="switchModule('inventario_general')" class="sidebar-item w-full flex items-center px-4 py-3 text-sm font-medium rounded-lg bg-transparent border border-slate-800/60 text-slate-200 hover:bg-white/5 hover:border-slate-700 transition-colors">
        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7h18M3 12h18M3 17h18"></path>
        </svg>
        INVENTARIO X CATEGORÍA
      </button>
  <button id="nav-flujo_ganado_categoria" onclick="switchModule('flujo_ganado_categoria')" class="sidebar-item w-full flex items-center px-4 py-3 text-sm font-medium rounded-lg bg-transparent border border-slate-800/60 text-slate-200 hover:bg-white/5 hover:border-slate-700 transition-colors">
        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16M7 6v12"></path>
        </svg>
        FLUJO DE GANADO POR CATEGORÍA
      </button>
  <button id="nav-inventario_movimiento" onclick="switchModule('inventario_movimiento')" class="sidebar-item w-full flex items-center px-4 py-3 text-sm font-medium rounded-lg bg-transparent border border-slate-800/60 text-slate-200 hover:bg-white/5 hover:border-slate-700 transition-colors">
        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v6h6M20 20v-6h-6M5 19a9 9 0 0114-14"></path>
        </svg>
        INVENTARIO: ENTRADAS Y SALIDAS
      </button>
  <button id="nav-ventas" onclick="switchModule('ventas')" class="sidebar-item w-full flex items-center px-4 py-3 text-sm font-medium rounded-lg bg-transparent border border-slate-800/60 text-slate-200 hover:bg-white/5 hover:border-slate-700 transition-colors">
        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 1.343-3 3v1H7a1 1 0 000 2h2v1c0 1.657 1.343 3 3 3s3-1.343 3-3v-1h2a1 1 0 100-2h-2v-1c0-1.657-1.343-3-3-3z"></path>
        </svg>
        VENTAS 2026
      </button>
  <div class="pt-2"><p class="text-[10px] font-bold text-slate-400/80 uppercase tracking-widest px-3 mb-2">Reproducción</p></div>
  <button id="nav-nacimientos" onclick="switchModule('nacimientos')" class="sidebar-item w-full flex items-center px-4 py-3 text-sm font-medium rounded-lg bg-transparent border border-slate-800/60 text-slate-200 hover:bg-white/5 hover:border-slate-700 transition-colors">
        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v12m6-6H6"></path>
        </svg>
        NACIMIENTOS 2026
      </button>
  <button id="nav-proyeccion_partos" onclick="switchModule('proyeccion_partos')" class="sidebar-item w-full flex items-center px-4 py-3 text-sm font-medium rounded-lg bg-transparent border border-slate-800/60 text-slate-200 hover:bg-white/5 hover:border-slate-700 transition-colors">
        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3M4 11h16M6 21h12a2 2 0 002-2V7a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
        </svg>
        PROYECCIÓN DE PARTOS
      </button>
  <button id="nav-destete" onclick="switchModule('destete')" class="sidebar-item w-full flex items-center px-4 py-3 text-sm font-medium rounded-lg bg-transparent border border-slate-800/60 text-slate-200 hover:bg-white/5 hover:border-slate-700 transition-colors active">
        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-3.866 0-7 1.79-7 4v4h14v-4c0-2.21-3.134-4-7-4zm0 0V4m0 0H9m3 0h3"></path>
        </svg>
        DESTETE DE TERNEROS
      </button>
  <div class="pt-2"><p class="text-[10px] font-bold text-slate-400/80 uppercase tracking-widest px-3 mb-2">Mortalidad</p></div>
  <button id="nav-muertes" onclick="switchModule('muertes')" class="sidebar-item w-full flex items-center px-4 py-3 text-sm font-medium rounded-lg bg-transparent border border-slate-800/60 text-slate-200 hover:bg-white/5 hover:border-slate-700 transition-colors">
        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5z"></path>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l6.16-3.422A12.083 12.083 0 0121 17.5a12.083 12.083 0 01-9 3.5 12.083 12.083 0 01-9-3.5 12.083 12.083 0 012.84-6.922L12 14z"></path>
        </svg>
        MUERTES 2026
      </button>
</nav>

    <div class="p-4 border-t border-slate-800 bg-slate-950/30">
      <div id="dropZone" class="drop-zone p-4 rounded-xl text-center cursor-pointer">
        <p class="text-xs font-semibold text-slate-200">Actualizar Datos</p>
        <p class="text-[10px] text-slate-400/80 mt-1">Sube archivos CSV (puedes subir varios)</p>
        <input type="file" id="fileInput" class="hidden" accept=".csv" multiple="">
      </div>
      <p class="text-[10px] text-slate-400 mt-3 leading-relaxed">
        Consejo: sube los 7 CSV juntos para habilitar todos los módulos. El dashboard detecta automáticamente cada reporte.
      </p>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="flex-1 overflow-y-auto p-8">
    <header class="mb-8 flex justify-between items-start">
      <div>
        <h2 id="mainTitle" class="text-3xl font-bold text-slate-800">Destete de Terneros</h2>
        <p id="mainSubtitle" class="text-slate-500">Peso de nacimiento vs destete (por mes / sexo)</p>
      </div>
      <div class="flex flex-col items-end gap-3 no-print">
        <div id="lastUpdate" class="text-xs text-slate-400 bg-white px-3 py-1 rounded-full border border-slate-200">Actualizado: 13/2/2026, 8:39:47</div>
        <button id="saveBtn" class="btn-action bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold text-sm shadow-lg shadow-blue-200 flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
          </svg>
          Exportar Dashboard
        </button>
      </div>
    </header>

    <!-- DASHBOARD GRID -->
    <div id="dashboardContent" class="space-y-6 opacity-50 pointer-events-none section-fade-in">

      <!-- FILTERS BAR -->
      <div class="bg-white p-4 rounded-xl border border-slate-200 flex flex-wrap gap-4 items-center no-print">
        <div id="fincaFilterWrap" class="flex flex-col gap-1 hidden">
          <label class="text-[10px] font-bold text-slate-400 uppercase">Filtrar por Finca/Zona</label>
          <select id="fincaFilter" class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500 min-w-[220px]"><option value="all">Todas</option><option value="El Castillo">El Castillo</option><option value="Las Cuchillas">Las Cuchillas</option><option value="Las Guayabas">Las Guayabas</option><option value="Los Carbonales">Los Carbonales</option><option value="Los Chaguites">Los Chaguites</option><option value="Monte Fresco">Monte Fresco</option><option value="PRIMERO MAYO">PRIMERO MAYO</option></select>
        </div>

        
        <div id="categoriaFilterWrap" class="flex flex-col gap-1 hidden">
          <label class="text-[10px] font-bold text-slate-400 uppercase">Categoría</label>
          <select id="categoriaFilter" class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500 min-w-[220px]">
            <option value="all">Todas</option>
            <option value="HEMBRAS">Hembras</option>
            <option value="MACHOS">Machos</option>
            <option value="CAFE">Venta de Café</option>
          </select>
        </div>

        <div id="yearFilters" class="flex gap-4 hidden">
          <div class="flex flex-col gap-1">
            <label class="text-[10px] font-bold text-slate-400 uppercase">Año Inicio</label>
            <select id="yearStartFilter" class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500"><option value="2025">2025</option><option value="2026">2026</option></select>
          </div>
          <div class="flex flex-col gap-1">
            <label class="text-[10px] font-bold text-slate-400 uppercase">Año Fin</label>
            <select id="yearEndFilter" class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500"><option value="2025">2025</option><option value="2026">2026</option></select>
          </div></div>

        <div id="monthFilterWrap" class="flex flex-col gap-1 hidden">
          <label class="text-[10px] font-bold text-slate-400 uppercase">Mes</label>
          <select id="monthFilter" class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500 min-w-[180px]"><option value="all">Todos</option><option value="Enero">Enero</option><option value="Febrero">Febrero</option><option value="Marzo">Marzo</option><option value="Abril">Abril</option><option value="Mayo">Mayo</option><option value="Junio">Junio</option><option value="Julio">Julio</option><option value="Agosto">Agosto</option><option value="Septiembre">Septiembre</option><option value="Octubre">Octubre</option><option value="Noviembre">Noviembre</option><option value="Diciembre">Diciembre</option></select>
        </div>

        <div id="sexoFilterWrap" class="flex flex-col gap-1">
          <label class="text-[10px] font-bold text-slate-400 uppercase">Sexo</label>
          <select id="sexoFilter" class="bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-blue-500 min-w-[180px]">
            <option value="todos">Todos</option>
            <option value="machos">Machos</option>
            <option value="hembras">Hembras</option>
          </select>
        </div>



        <button id="resetFilters" class="mt-auto mb-1 text-blue-600 text-xs font-semibold hover:underline">Restablecer filtros</button>
      </div>

      <!-- KPI CARDS -->
      <div id="kpiContainer" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>

      <!-- SECTION CONTENT (para módulos que renderizan todo en un solo contenedor) -->
      <div id="sectionContent" class="space-y-6"><p class="text-center text-slate-400">No hay datos disponibles para mostrar.</p></div>

      <!-- CHARTS SECTION -->
      <div id="chartsContainer" class="space-y-6"></div>
    </div>

    <!-- PLACEHOLDER -->
    <div id="noDataState" class="flex flex-col items-center justify-center h-72 text-slate-400 no-print">
      <svg class="w-16 h-16 mb-4 opacity-20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
      </svg>
      <p id="placeholderText" class="text-center px-6">Sube el archivo CSV de “Destete de Terneros” para comenzar.</p>
    </div>
  </main>

  <script id="dataContainer">window.APP_DATA = {"destete":[],"destete_meta":{"totalTerneros":0,"pesoDesteteProm":0,"pesoNacimProm":0},"ventas":[{"finca":"General","anio":2026,"mes":"Enero","tipo":"HEMBRAS","descripcion":"Vaquillas","cantidad":16,"unidad":"Cbzs","kilos":4461,"precio_kg":83,"importe":370263},{"finca":"General","anio":2026,"mes":"Enero","tipo":"HEMBRAS","descripcion":"Vaquillas","cantidad":5,"unidad":"Cbzs","kilos":1452,"precio_kg":83,"importe":120540},{"finca":"General","anio":2026,"mes":"Enero","tipo":"HEMBRAS","descripcion":"Vaquillas","cantidad":4,"unidad":"Cbzs","kilos":942,"precio_kg":83,"importe":78186},{"finca":"General","anio":2026,"mes":"Enero","tipo":"HEMBRAS","descripcion":"Vaquillas","cantidad":10,"unidad":"Cbzs","kilos":2746,"precio_kg":83,"importe":227918},{"finca":"General","anio":2026,"mes":"Enero","tipo":"HEMBRAS","descripcion":"Vaquillas","cantidad":28,"unidad":"Cbzs","kilos":6832,"precio_kg":83,"importe":567056},{"finca":"General","anio":2026,"mes":"Enero","tipo":"CAFE","descripcion":"Café Pergamino","cantidad":362,"unidad":"Libras","kilos":0,"precio_kg":50.26,"importe":18194}],"flujo_ganado_categoria":[{"finca":"General","anio":2025,"grupo":"HATO REPRODUCTIVO","codigo":"1","categoria":"Vacas Paridas","inicial":681,"nacimientos":0,"compras":0,"muertes":0,"ventas":0,"transf_salida":0,"transf_entrada":49,"final":730},{"finca":"General","anio":2025,"grupo":"HATO REPRODUCTIVO","codigo":"2","categoria":"Vacas Secas","inicial":324,"nacimientos":0,"compras":0,"muertes":0,"ventas":0,"transf_salida":49,"transf_entrada":0,"final":275},{"finca":"General","anio":2025,"grupo":"HATO REPRODUCTIVO","codigo":"3","categoria":"Novilla Vientre","inicial":281,"nacimientos":0,"compras":0,"muertes":1,"ventas":0,"transf_salida":0,"transf_entrada":0,"final":280},{"finca":"General","anio":2025,"grupo":"HATO REPRODUCTIVO","codigo":"4","categoria":"Hembras Descarte","inicial":0,"nacimientos":0,"compras":0,"muertes":0,"ventas":0,"transf_salida":0,"transf_entrada":0,"final":0},{"finca":"General","anio":2025,"grupo":"HATO REPRODUCTIVO","codigo":"SUB - TOTAL","categoria":"SUB - TOTAL","inicial":1286,"nacimientos":0,"compras":0,"muertes":1,"ventas":0,"transf_salida":49,"transf_entrada":49,"final":1285},{"finca":"General","anio":2025,"grupo":"GANADO BOVINO MENOR","codigo":"5","categoria":"Crías Machos","inicial":292,"nacimientos":32,"compras":0,"muertes":0,"ventas":0,"transf_salida":0,"transf_entrada":0,"final":324},{"finca":"General","anio":2025,"grupo":"GANADO BOVINO MENOR","codigo":"6","categoria":"Crías Hembras","inicial":388,"nacimientos":17,"compras":0,"muertes":0,"ventas":0,"transf_salida":0,"transf_entrada":1,"final":406},{"finca":"General","anio":2025,"grupo":"GANADO BOVINO MENOR","codigo":"7","categoria":"Hembras Levante","inicial":458,"nacimientos":0,"compras":0,"muertes":1,"ventas":63,"transf_salida":0,"transf_entrada":0,"final":394},{"finca":"General","anio":2025,"grupo":"GANADO BOVINO MENOR","codigo":"SUB - TOTAL","categoria":"SUB - TOTAL","inicial":1138,"nacimientos":49,"compras":0,"muertes":1,"ventas":63,"transf_salida":0,"transf_entrada":1,"final":1124},{"finca":"General","anio":2025,"grupo":"GANADO MACHOS","codigo":"8","categoria":"Novillos","inicial":43,"nacimientos":0,"compras":0,"muertes":0,"ventas":0,"transf_salida":0,"transf_entrada":4,"final":47},{"finca":"General","anio":2025,"grupo":"GANADO MACHOS","codigo":"9","categoria":"Novillos Comprados","inicial":0,"nacimientos":0,"compras":0,"muertes":0,"ventas":0,"transf_salida":0,"transf_entrada":0,"final":0},{"finca":"General","anio":2025,"grupo":"GANADO MACHOS","codigo":"10","categoria":"Toros /Reproductores","inicial":72,"nacimientos":0,"compras":0,"muertes":0,"ventas":0,"transf_salida":0,"transf_entrada":0,"final":72},{"finca":"General","anio":2025,"grupo":"GANADO MACHOS","codigo":"11","categoria":"Toretes /Reproductores","inicial":9,"nacimientos":0,"compras":0,"muertes":0,"ventas":0,"transf_salida":0,"transf_entrada":0,"final":9},{"finca":"General","anio":2025,"grupo":"GANADO MACHOS","codigo":"12","categoria":"Bueyes","inicial":14,"nacimientos":0,"compras":0,"muertes":0,"ventas":0,"transf_salida":0,"transf_entrada":0,"final":14},{"finca":"General","anio":2025,"grupo":"GANADO MACHOS","codigo":"SUB - TOTAL","categoria":"SUB - TOTAL","inicial":138,"nacimientos":0,"compras":0,"muertes":0,"ventas":0,"transf_salida":0,"transf_entrada":4,"final":142},{"finca":"General","anio":2025,"grupo":"GANADO MACHOS","codigo":"TOTAL GENERAL","categoria":"TOTAL GENERAL","inicial":2562,"nacimientos":49,"compras":0,"muertes":2,"ventas":63,"transf_salida":49,"transf_entrada":54,"final":2551}],"inventario_movimiento":[{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Vacas Paridas","tipo":"Inventario Inicial","valor":3},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Vacas Secas","tipo":"Inventario Inicial","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Novilla Vientre","tipo":"Inventario Inicial","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Crías Machos","tipo":"Inventario Inicial","valor":1},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Crías Hembras","tipo":"Inventario Inicial","valor":2},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Hembras Levante","tipo":"Inventario Inicial","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Novillos Desarrollo","tipo":"Inventario Inicial","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Toros","tipo":"Inventario Inicial","valor":1},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Toretes","tipo":"Inventario Inicial","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Bueyes","tipo":"Inventario Inicial","valor":2},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Existencia Final","tipo":"Inventario Inicial","valor":9},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Vacas Paridas","tipo":"Compras","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Vacas Secas","tipo":"Compras","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Novilla Vientre","tipo":"Compras","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Crías Machos","tipo":"Compras","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Crías Hembras","tipo":"Compras","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Hembras Levante","tipo":"Compras","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Novillos Desarrollo","tipo":"Compras","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Toros","tipo":"Compras","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Toretes","tipo":"Compras","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Bueyes","tipo":"Compras","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Existencia Final","tipo":"Compras","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Vacas Paridas","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Vacas Secas","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Novilla Vientre","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Crías Machos","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Crías Hembras","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Hembras Levante","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Novillos Desarrollo","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Toros","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Toretes","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Bueyes","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Existencia Final","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Vacas Paridas","tipo":"Entradas","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Vacas Secas","tipo":"Entradas","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Novilla Vientre","tipo":"Entradas","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Crías Machos","tipo":"Entradas","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Crías Hembras","tipo":"Entradas","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Hembras Levante","tipo":"Entradas","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Novillos Desarrollo","tipo":"Entradas","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Toros","tipo":"Entradas","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Toretes","tipo":"Entradas","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Bueyes","tipo":"Entradas","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Existencia Final","tipo":"Entradas","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Vacas Paridas","tipo":"Ventas","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Vacas Secas","tipo":"Ventas","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Novilla Vientre","tipo":"Ventas","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Crías Machos","tipo":"Ventas","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Crías Hembras","tipo":"Ventas","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Hembras Levante","tipo":"Ventas","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Novillos Desarrollo","tipo":"Ventas","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Toros","tipo":"Ventas","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Toretes","tipo":"Ventas","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Bueyes","tipo":"Ventas","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Existencia Final","tipo":"Ventas","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Vacas Paridas","tipo":"Muertes","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Vacas Secas","tipo":"Muertes","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Novilla Vientre","tipo":"Muertes","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Crías Machos","tipo":"Muertes","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Crías Hembras","tipo":"Muertes","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Hembras Levante","tipo":"Muertes","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Novillos Desarrollo","tipo":"Muertes","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Toros","tipo":"Muertes","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Toretes","tipo":"Muertes","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Bueyes","tipo":"Muertes","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Existencia Final","tipo":"Muertes","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Vacas Paridas","tipo":"Saladas","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Vacas Secas","tipo":"Saladas","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Novilla Vientre","tipo":"Saladas","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Crías Machos","tipo":"Saladas","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Crías Hembras","tipo":"Saladas","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Hembras Levante","tipo":"Saladas","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Novillos Desarrollo","tipo":"Saladas","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Toros","tipo":"Saladas","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Toretes","tipo":"Saladas","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Bueyes","tipo":"Saladas","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Existencia Final","tipo":"Saladas","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Vacas Paridas","tipo":"Inventario Final","valor":3},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Vacas Secas","tipo":"Inventario Final","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Novilla Vientre","tipo":"Inventario Final","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Crías Machos","tipo":"Inventario Final","valor":1},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Crías Hembras","tipo":"Inventario Final","valor":2},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Hembras Levante","tipo":"Inventario Final","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Novillos Desarrollo","tipo":"Inventario Final","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Toros","tipo":"Inventario Final","valor":1},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Toretes","tipo":"Inventario Final","valor":0},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Bueyes","tipo":"Inventario Final","valor":2},{"anio":2026,"finca":"El C A S T I Ll O","categoria":"Existencia Final","tipo":"Inventario Final","valor":9},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Vacas Paridas","tipo":"Inventario Inicial","valor":64},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Vacas Secas","tipo":"Inventario Inicial","valor":12},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Novilla Vientre","tipo":"Inventario Inicial","valor":29},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Crías Machos","tipo":"Inventario Inicial","valor":22},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Crías Hembras","tipo":"Inventario Inicial","valor":42},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Hembras Levante","tipo":"Inventario Inicial","valor":43},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Novillos Desarrollo","tipo":"Inventario Inicial","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Toros","tipo":"Inventario Inicial","valor":5},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Toretes","tipo":"Inventario Inicial","valor":1},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Bueyes","tipo":"Inventario Inicial","valor":2},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Existencia Final","tipo":"Inventario Inicial","valor":220},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Vacas Paridas","tipo":"Compras","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Vacas Secas","tipo":"Compras","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Novilla Vientre","tipo":"Compras","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Crías Machos","tipo":"Compras","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Crías Hembras","tipo":"Compras","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Hembras Levante","tipo":"Compras","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Novillos Desarrollo","tipo":"Compras","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Toros","tipo":"Compras","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Toretes","tipo":"Compras","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Bueyes","tipo":"Compras","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Existencia Final","tipo":"Compras","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Vacas Paridas","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Vacas Secas","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Novilla Vientre","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Crías Machos","tipo":"Nacimiento","valor":3},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Crías Hembras","tipo":"Nacimiento","valor":1},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Hembras Levante","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Novillos Desarrollo","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Toros","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Toretes","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Bueyes","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Existencia Final","tipo":"Nacimiento","valor":4},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Vacas Paridas","tipo":"Entradas","valor":4},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Vacas Secas","tipo":"Entradas","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Novilla Vientre","tipo":"Entradas","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Crías Machos","tipo":"Entradas","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Crías Hembras","tipo":"Entradas","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Hembras Levante","tipo":"Entradas","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Novillos Desarrollo","tipo":"Entradas","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Toros","tipo":"Entradas","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Toretes","tipo":"Entradas","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Bueyes","tipo":"Entradas","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Existencia Final","tipo":"Entradas","valor":4},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Vacas Paridas","tipo":"Ventas","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Vacas Secas","tipo":"Ventas","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Novilla Vientre","tipo":"Ventas","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Crías Machos","tipo":"Ventas","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Crías Hembras","tipo":"Ventas","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Hembras Levante","tipo":"Ventas","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Novillos Desarrollo","tipo":"Ventas","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Toros","tipo":"Ventas","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Toretes","tipo":"Ventas","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Bueyes","tipo":"Ventas","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Existencia Final","tipo":"Ventas","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Vacas Paridas","tipo":"Muertes","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Vacas Secas","tipo":"Muertes","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Novilla Vientre","tipo":"Muertes","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Crías Machos","tipo":"Muertes","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Crías Hembras","tipo":"Muertes","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Hembras Levante","tipo":"Muertes","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Novillos Desarrollo","tipo":"Muertes","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Toros","tipo":"Muertes","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Toretes","tipo":"Muertes","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Bueyes","tipo":"Muertes","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Existencia Final","tipo":"Muertes","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Vacas Paridas","tipo":"Saladas","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Vacas Secas","tipo":"Saladas","valor":4},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Novilla Vientre","tipo":"Saladas","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Crías Machos","tipo":"Saladas","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Crías Hembras","tipo":"Saladas","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Hembras Levante","tipo":"Saladas","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Novillos Desarrollo","tipo":"Saladas","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Toros","tipo":"Saladas","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Toretes","tipo":"Saladas","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Bueyes","tipo":"Saladas","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Existencia Final","tipo":"Saladas","valor":4},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Vacas Paridas","tipo":"Inventario Final","valor":68},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Vacas Secas","tipo":"Inventario Final","valor":8},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Novilla Vientre","tipo":"Inventario Final","valor":29},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Crías Machos","tipo":"Inventario Final","valor":25},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Crías Hembras","tipo":"Inventario Final","valor":43},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Hembras Levante","tipo":"Inventario Final","valor":43},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Novillos Desarrollo","tipo":"Inventario Final","valor":0},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Toros","tipo":"Inventario Final","valor":5},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Toretes","tipo":"Inventario Final","valor":1},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Bueyes","tipo":"Inventario Final","valor":2},{"anio":2026,"finca":"Las C U C H I Ll A S","categoria":"Existencia Final","tipo":"Inventario Final","valor":224},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Vacas Paridas","tipo":"Inventario Inicial","valor":2},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Vacas Secas","tipo":"Inventario Inicial","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Novilla Vientre","tipo":"Inventario Inicial","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Crías Machos","tipo":"Inventario Inicial","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Crías Hembras","tipo":"Inventario Inicial","valor":2},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Hembras Levante","tipo":"Inventario Inicial","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Novillos Desarrollo","tipo":"Inventario Inicial","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Toros","tipo":"Inventario Inicial","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Toretes","tipo":"Inventario Inicial","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Bueyes","tipo":"Inventario Inicial","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Existencia Final","tipo":"Inventario Inicial","valor":4},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Vacas Paridas","tipo":"Compras","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Vacas Secas","tipo":"Compras","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Novilla Vientre","tipo":"Compras","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Crías Machos","tipo":"Compras","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Crías Hembras","tipo":"Compras","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Hembras Levante","tipo":"Compras","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Novillos Desarrollo","tipo":"Compras","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Toros","tipo":"Compras","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Toretes","tipo":"Compras","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Bueyes","tipo":"Compras","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Existencia Final","tipo":"Compras","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Vacas Paridas","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Vacas Secas","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Novilla Vientre","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Crías Machos","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Crías Hembras","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Hembras Levante","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Novillos Desarrollo","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Toros","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Toretes","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Bueyes","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Existencia Final","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Vacas Paridas","tipo":"Entradas","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Vacas Secas","tipo":"Entradas","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Novilla Vientre","tipo":"Entradas","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Crías Machos","tipo":"Entradas","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Crías Hembras","tipo":"Entradas","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Hembras Levante","tipo":"Entradas","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Novillos Desarrollo","tipo":"Entradas","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Toros","tipo":"Entradas","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Toretes","tipo":"Entradas","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Bueyes","tipo":"Entradas","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Existencia Final","tipo":"Entradas","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Vacas Paridas","tipo":"Ventas","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Vacas Secas","tipo":"Ventas","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Novilla Vientre","tipo":"Ventas","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Crías Machos","tipo":"Ventas","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Crías Hembras","tipo":"Ventas","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Hembras Levante","tipo":"Ventas","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Novillos Desarrollo","tipo":"Ventas","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Toros","tipo":"Ventas","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Toretes","tipo":"Ventas","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Bueyes","tipo":"Ventas","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Existencia Final","tipo":"Ventas","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Vacas Paridas","tipo":"Muertes","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Vacas Secas","tipo":"Muertes","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Novilla Vientre","tipo":"Muertes","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Crías Machos","tipo":"Muertes","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Crías Hembras","tipo":"Muertes","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Hembras Levante","tipo":"Muertes","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Novillos Desarrollo","tipo":"Muertes","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Toros","tipo":"Muertes","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Toretes","tipo":"Muertes","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Bueyes","tipo":"Muertes","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Existencia Final","tipo":"Muertes","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Vacas Paridas","tipo":"Salidas","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Vacas Secas","tipo":"Salidas","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Novilla Vientre","tipo":"Salidas","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Crías Machos","tipo":"Salidas","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Crías Hembras","tipo":"Salidas","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Hembras Levante","tipo":"Salidas","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Novillos Desarrollo","tipo":"Salidas","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Toros","tipo":"Salidas","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Toretes","tipo":"Salidas","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Bueyes","tipo":"Salidas","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Existencia Final","tipo":"Salidas","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Vacas Paridas","tipo":"Inventario Final","valor":2},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Vacas Secas","tipo":"Inventario Final","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Novilla Vientre","tipo":"Inventario Final","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Crías Machos","tipo":"Inventario Final","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Crías Hembras","tipo":"Inventario Final","valor":2},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Hembras Levante","tipo":"Inventario Final","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Novillos Desarrollo","tipo":"Inventario Final","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Toros","tipo":"Inventario Final","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Toretes","tipo":"Inventario Final","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Bueyes","tipo":"Inventario Final","valor":0},{"anio":2026,"finca":"Las G U A Y A B A S","categoria":"Existencia Final","tipo":"Inventario Final","valor":4},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Vacas Paridas","tipo":"Inventario Inicial","valor":126},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Vacas Secas","tipo":"Inventario Inicial","valor":54},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Novilla Vientre","tipo":"Inventario Inicial","valor":56},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Crías Machos","tipo":"Inventario Inicial","valor":54},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Crías Hembras","tipo":"Inventario Inicial","valor":72},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Hembras Levante","tipo":"Inventario Inicial","valor":140},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Novillos Desarrollo","tipo":"Inventario Inicial","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Toros","tipo":"Inventario Inicial","valor":26},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Toretes","tipo":"Inventario Inicial","valor":3},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Bueyes","tipo":"Inventario Inicial","valor":4},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Existencia Final","tipo":"Inventario Inicial","valor":535},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Vacas Paridas","tipo":"Compras","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Vacas Secas","tipo":"Compras","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Novilla Vientre","tipo":"Compras","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Crías Machos","tipo":"Compras","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Crías Hembras","tipo":"Compras","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Hembras Levante","tipo":"Compras","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Novillos Desarrollo","tipo":"Compras","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Toros","tipo":"Compras","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Toretes","tipo":"Compras","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Bueyes","tipo":"Compras","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Existencia Final","tipo":"Compras","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Vacas Paridas","tipo":"Nacimiento","valor":5},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Vacas Secas","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Novilla Vientre","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Crías Machos","tipo":"Nacimiento","valor":4},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Crías Hembras","tipo":"Nacimiento","valor":1},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Hembras Levante","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Novillos Desarrollo","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Toros","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Toretes","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Bueyes","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Existencia Final","tipo":"Nacimiento","valor":10},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Vacas Paridas","tipo":"Entradas","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Vacas Secas","tipo":"Entradas","valor":2},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Novilla Vientre","tipo":"Entradas","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Crías Machos","tipo":"Entradas","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Crías Hembras","tipo":"Entradas","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Hembras Levante","tipo":"Entradas","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Novillos Desarrollo","tipo":"Entradas","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Toros","tipo":"Entradas","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Toretes","tipo":"Entradas","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Bueyes","tipo":"Entradas","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Existencia Final","tipo":"Entradas","valor":2},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Vacas Paridas","tipo":"Ventas","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Vacas Secas","tipo":"Ventas","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Novilla Vientre","tipo":"Ventas","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Crías Machos","tipo":"Ventas","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Crías Hembras","tipo":"Ventas","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Hembras Levante","tipo":"Ventas","valor":4},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Novillos Desarrollo","tipo":"Ventas","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Toros","tipo":"Ventas","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Toretes","tipo":"Ventas","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Bueyes","tipo":"Ventas","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Existencia Final","tipo":"Ventas","valor":4},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Vacas Paridas","tipo":"Muertes","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Vacas Secas","tipo":"Muertes","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Novilla Vientre","tipo":"Muertes","valor":1},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Crías Machos","tipo":"Muertes","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Crías Hembras","tipo":"Muertes","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Hembras Levante","tipo":"Muertes","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Novillos Desarrollo","tipo":"Muertes","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Toros","tipo":"Muertes","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Toretes","tipo":"Muertes","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Bueyes","tipo":"Muertes","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Existencia Final","tipo":"Muertes","valor":1},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Vacas Paridas","tipo":"Salidas","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Vacas Secas","tipo":"Salidas","valor":5},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Novilla Vientre","tipo":"Salidas","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Crías Machos","tipo":"Salidas","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Crías Hembras","tipo":"Salidas","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Hembras Levante","tipo":"Salidas","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Novillos Desarrollo","tipo":"Salidas","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Toros","tipo":"Salidas","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Toretes","tipo":"Salidas","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Bueyes","tipo":"Salidas","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Existencia Final","tipo":"Salidas","valor":5},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Vacas Paridas","tipo":"Inventario Final","valor":131},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Vacas Secas","tipo":"Inventario Final","valor":51},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Novilla Vientre","tipo":"Inventario Final","valor":55},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Crías Machos","tipo":"Inventario Final","valor":58},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Crías Hembras","tipo":"Inventario Final","valor":73},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Hembras Levante","tipo":"Inventario Final","valor":136},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Novillos Desarrollo","tipo":"Inventario Final","valor":0},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Toros","tipo":"Inventario Final","valor":26},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Toretes","tipo":"Inventario Final","valor":3},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Bueyes","tipo":"Inventario Final","valor":4},{"anio":2026,"finca":"Los C A B O N A L E S","categoria":"Existencia Final","tipo":"Inventario Final","valor":537},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Vacas Paridas","tipo":"Inventario Inicial","valor":12},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Vacas Secas","tipo":"Inventario Inicial","valor":2},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Novilla Vientre","tipo":"Inventario Inicial","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Crías Machos","tipo":"Inventario Inicial","valor":5},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Crías Hembras","tipo":"Inventario Inicial","valor":6},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Hembras Levante","tipo":"Inventario Inicial","valor":1},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Novillos Desarrollo","tipo":"Inventario Inicial","valor":12},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Toros","tipo":"Inventario Inicial","valor":1},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Toretes","tipo":"Inventario Inicial","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Bueyes","tipo":"Inventario Inicial","valor":4},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Existencia Final","tipo":"Inventario Inicial","valor":43},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Vacas Paridas","tipo":"Compras","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Vacas Secas","tipo":"Compras","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Novilla Vientre","tipo":"Compras","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Crías Machos","tipo":"Compras","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Crías Hembras","tipo":"Compras","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Hembras Levante","tipo":"Compras","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Novillos Desarrollo","tipo":"Compras","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Toros","tipo":"Compras","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Toretes","tipo":"Compras","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Bueyes","tipo":"Compras","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Existencia Final","tipo":"Compras","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Vacas Paridas","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Vacas Secas","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Novilla Vientre","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Crías Machos","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Crías Hembras","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Hembras Levante","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Novillos Desarrollo","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Toros","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Toretes","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Bueyes","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Existencia Final","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Vacas Paridas","tipo":"Entradas","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Vacas Secas","tipo":"Entradas","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Novilla Vientre","tipo":"Entradas","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Crías Machos","tipo":"Entradas","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Crías Hembras","tipo":"Entradas","valor":1},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Hembras Levante","tipo":"Entradas","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Novillos Desarrollo","tipo":"Entradas","valor":4},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Toros","tipo":"Entradas","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Toretes","tipo":"Entradas","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Bueyes","tipo":"Entradas","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Existencia Final","tipo":"Entradas","valor":5},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Vacas Paridas","tipo":"Ventas","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Vacas Secas","tipo":"Ventas","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Novilla Vientre","tipo":"Ventas","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Crías Machos","tipo":"Ventas","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Crías Hembras","tipo":"Ventas","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Hembras Levante","tipo":"Ventas","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Novillos Desarrollo","tipo":"Ventas","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Toros","tipo":"Ventas","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Toretes","tipo":"Ventas","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Bueyes","tipo":"Ventas","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Existencia Final","tipo":"Ventas","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Vacas Paridas","tipo":"Muertes","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Vacas Secas","tipo":"Muertes","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Novilla Vientre","tipo":"Muertes","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Crías Machos","tipo":"Muertes","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Crías Hembras","tipo":"Muertes","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Hembras Levante","tipo":"Muertes","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Novillos Desarrollo","tipo":"Muertes","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Toros","tipo":"Muertes","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Toretes","tipo":"Muertes","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Bueyes","tipo":"Muertes","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Existencia Final","tipo":"Muertes","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Vacas Paridas","tipo":"Saladas","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Vacas Secas","tipo":"Saladas","valor":2},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Novilla Vientre","tipo":"Saladas","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Crías Machos","tipo":"Saladas","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Crías Hembras","tipo":"Saladas","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Hembras Levante","tipo":"Saladas","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Novillos Desarrollo","tipo":"Saladas","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Toros","tipo":"Saladas","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Toretes","tipo":"Saladas","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Bueyes","tipo":"Saladas","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Existencia Final","tipo":"Saladas","valor":2},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Vacas Paridas","tipo":"Inventario Final","valor":12},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Vacas Secas","tipo":"Inventario Final","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Novilla Vientre","tipo":"Inventario Final","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Crías Machos","tipo":"Inventario Final","valor":5},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Crías Hembras","tipo":"Inventario Final","valor":7},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Hembras Levante","tipo":"Inventario Final","valor":1},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Novillos Desarrollo","tipo":"Inventario Final","valor":16},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Toros","tipo":"Inventario Final","valor":1},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Toretes","tipo":"Inventario Final","valor":0},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Bueyes","tipo":"Inventario Final","valor":4},{"anio":2026,"finca":"Los C H A G U I T E S","categoria":"Existencia Final","tipo":"Inventario Final","valor":46},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Vacas Paridas","tipo":"Inventario Inicial","valor":90},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Vacas Secas","tipo":"Inventario Inicial","valor":78},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Novilla Vientre","tipo":"Inventario Inicial","valor":53},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Crías Machos","tipo":"Inventario Inicial","valor":46},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Crías Hembras","tipo":"Inventario Inicial","valor":44},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Hembras Levante","tipo":"Inventario Inicial","valor":120},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Novillos Desarrollo","tipo":"Inventario Inicial","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Toros","tipo":"Inventario Inicial","valor":14},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Toretes","tipo":"Inventario Inicial","valor":5},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Bueyes","tipo":"Inventario Inicial","valor":2},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Existencia Final","tipo":"Inventario Inicial","valor":452},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Vacas Paridas","tipo":"Compras","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Vacas Secas","tipo":"Compras","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Novilla Vientre","tipo":"Compras","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Crías Machos","tipo":"Compras","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Crías Hembras","tipo":"Compras","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Hembras Levante","tipo":"Compras","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Novillos Desarrollo","tipo":"Compras","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Toros","tipo":"Compras","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Toretes","tipo":"Compras","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Bueyes","tipo":"Compras","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Existencia Final","tipo":"Compras","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Vacas Paridas","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Vacas Secas","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Novilla Vientre","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Crías Machos","tipo":"Nacimiento","valor":1},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Crías Hembras","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Hembras Levante","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Novillos Desarrollo","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Toros","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Toretes","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Bueyes","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Existencia Final","tipo":"Nacimiento","valor":1},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Vacas Paridas","tipo":"Entradas","valor":1},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Vacas Secas","tipo":"Entradas","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Novilla Vientre","tipo":"Entradas","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Crías Machos","tipo":"Entradas","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Crías Hembras","tipo":"Entradas","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Hembras Levante","tipo":"Entradas","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Novillos Desarrollo","tipo":"Entradas","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Toros","tipo":"Entradas","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Toretes","tipo":"Entradas","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Bueyes","tipo":"Entradas","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Existencia Final","tipo":"Entradas","valor":1},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Vacas Paridas","tipo":"Ventas","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Vacas Secas","tipo":"Ventas","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Novilla Vientre","tipo":"Ventas","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Crías Machos","tipo":"Ventas","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Crías Hembras","tipo":"Ventas","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Hembras Levante","tipo":"Ventas","valor":28},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Novillos Desarrollo","tipo":"Ventas","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Toros","tipo":"Ventas","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Toretes","tipo":"Ventas","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Bueyes","tipo":"Ventas","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Existencia Final","tipo":"Ventas","valor":28},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Vacas Paridas","tipo":"Muertes","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Vacas Secas","tipo":"Muertes","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Novilla Vientre","tipo":"Muertes","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Crías Machos","tipo":"Muertes","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Crías Hembras","tipo":"Muertes","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Hembras Levante","tipo":"Muertes","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Novillos Desarrollo","tipo":"Muertes","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Toros","tipo":"Muertes","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Toretes","tipo":"Muertes","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Bueyes","tipo":"Muertes","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Existencia Final","tipo":"Muertes","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Vacas Paridas","tipo":"Saladas","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Vacas Secas","tipo":"Saladas","valor":1},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Novilla Vientre","tipo":"Saladas","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Crías Machos","tipo":"Saladas","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Crías Hembras","tipo":"Saladas","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Hembras Levante","tipo":"Saladas","valor":1},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Novillos Desarrollo","tipo":"Saladas","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Toros","tipo":"Saladas","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Toretes","tipo":"Saladas","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Bueyes","tipo":"Saladas","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Existencia Final","tipo":"Saladas","valor":2},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Vacas Paridas","tipo":"Inventario Final","valor":91},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Vacas Secas","tipo":"Inventario Final","valor":77},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Novilla Vientre","tipo":"Inventario Final","valor":53},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Crías Machos","tipo":"Inventario Final","valor":47},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Crías Hembras","tipo":"Inventario Final","valor":44},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Hembras Levante","tipo":"Inventario Final","valor":91},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Novillos Desarrollo","tipo":"Inventario Final","valor":0},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Toros","tipo":"Inventario Final","valor":14},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Toretes","tipo":"Inventario Final","valor":5},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Bueyes","tipo":"Inventario Final","valor":2},{"anio":2026,"finca":"De M O N T E F R E S C O","categoria":"Existencia Final","tipo":"Inventario Final","valor":424},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Vacas Paridas","tipo":"Inventario Inicial","valor":384},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Vacas Secas","tipo":"Inventario Inicial","valor":178},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Novilla Vientre","tipo":"Inventario Inicial","valor":143},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Crías Machos","tipo":"Inventario Inicial","valor":164},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Crías Hembras","tipo":"Inventario Inicial","valor":220},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Hembras Levante","tipo":"Inventario Inicial","valor":154},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Novillos Desarrollo","tipo":"Inventario Inicial","valor":31},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Toros","tipo":"Inventario Inicial","valor":25},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Toretes","tipo":"Inventario Inicial","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Bueyes","tipo":"Inventario Inicial","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Existencia Final","tipo":"Inventario Inicial","valor":1299},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Vacas Paridas","tipo":"Compras","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Vacas Secas","tipo":"Compras","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Novilla Vientre","tipo":"Compras","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Crías Machos","tipo":"Compras","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Crías Hembras","tipo":"Compras","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Hembras Levante","tipo":"Compras","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Novillos Desarrollo","tipo":"Compras","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Toros","tipo":"Compras","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Toretes","tipo":"Compras","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Bueyes","tipo":"Compras","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Existencia Final","tipo":"Compras","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Vacas Paridas","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Vacas Secas","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Novilla Vientre","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Crías Machos","tipo":"Nacimiento","valor":24},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Crías Hembras","tipo":"Nacimiento","valor":15},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Hembras Levante","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Novillos Desarrollo","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Toros","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Toretes","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Bueyes","tipo":"Nacimiento","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Existencia Final","tipo":"Nacimiento","valor":39},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Vacas Paridas","tipo":"Entradas","valor":39},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Vacas Secas","tipo":"Entradas","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Novilla Vientre","tipo":"Entradas","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Crías Machos","tipo":"Entradas","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Crías Hembras","tipo":"Entradas","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Hembras Levante","tipo":"Entradas","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Novillos Desarrollo","tipo":"Entradas","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Toros","tipo":"Entradas","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Toretes","tipo":"Entradas","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Bueyes","tipo":"Entradas","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Existencia Final","tipo":"Entradas","valor":39},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Vacas Paridas","tipo":"Ventas","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Vacas Secas","tipo":"Ventas","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Novilla Vientre","tipo":"Ventas","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Crías Machos","tipo":"Ventas","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Crías Hembras","tipo":"Ventas","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Hembras Levante","tipo":"Ventas","valor":31},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Novillos Desarrollo","tipo":"Ventas","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Toros","tipo":"Ventas","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Toretes","tipo":"Ventas","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Bueyes","tipo":"Ventas","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Existencia Final","tipo":"Ventas","valor":31},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Vacas Paridas","tipo":"Muertes","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Vacas Secas","tipo":"Muertes","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Novilla Vientre","tipo":"Muertes","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Crías Machos","tipo":"Muertes","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Crías Hembras","tipo":"Muertes","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Hembras Levante","tipo":"Muertes","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Novillos Desarrollo","tipo":"Muertes","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Toros","tipo":"Muertes","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Toretes","tipo":"Muertes","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Bueyes","tipo":"Muertes","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Existencia Final","tipo":"Muertes","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Vacas Paridas","tipo":"Saladas","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Vacas Secas","tipo":"Saladas","valor":39},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Novilla Vientre","tipo":"Saladas","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Crías Machos","tipo":"Saladas","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Crías Hembras","tipo":"Saladas","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Hembras Levante","tipo":"Saladas","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Novillos Desarrollo","tipo":"Saladas","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Toros","tipo":"Saladas","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Toretes","tipo":"Saladas","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Bueyes","tipo":"Saladas","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Existencia Final","tipo":"Saladas","valor":39},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Vacas Paridas","tipo":"Inventario Final","valor":423},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Vacas Secas","tipo":"Inventario Final","valor":139},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Novilla Vientre","tipo":"Inventario Final","valor":143},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Crías Machos","tipo":"Inventario Final","valor":188},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Crías Hembras","tipo":"Inventario Final","valor":235},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Hembras Levante","tipo":"Inventario Final","valor":123},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Novillos Desarrollo","tipo":"Inventario Final","valor":31},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Toros","tipo":"Inventario Final","valor":25},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Toretes","tipo":"Inventario Final","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Bueyes","tipo":"Inventario Final","valor":0},{"anio":2026,"finca":"El C O R O J A L J A L A P A","categoria":"Existencia Final","tipo":"Inventario Final","valor":1307}],"proyeccion_partos":[{"finca":"Estelí /Jalapa","anio":2026,"mes":"Enero","hato":1283,"pct":0,"manual":0,"eco":0,"partos":0,"vacas":0,"novillas":0},{"finca":"Estelí /Jalapa","anio":2026,"mes":"Febrero","hato":1201,"pct":0,"manual":0,"eco":0,"partos":0,"vacas":0,"novillas":0},{"finca":"Estelí /Jalapa","anio":2026,"mes":"Marzo","hato":1336,"pct":0,"manual":0,"eco":0,"partos":0,"vacas":0,"novillas":0},{"finca":"Estelí /Jalapa","anio":2026,"mes":"Abril","hato":1285,"pct":0,"manual":0,"eco":0,"partos":0,"vacas":0,"novillas":0},{"finca":"Estelí /Jalapa","anio":2026,"mes":"Mayo","hato":1291,"pct":0,"manual":0,"eco":0,"partos":0,"vacas":0,"novillas":0},{"finca":"Estelí /Jalapa","anio":2026,"mes":"Junio","hato":1266,"pct":0,"manual":0,"eco":0,"partos":0,"vacas":0,"novillas":0},{"finca":"Estelí /Jalapa","anio":2026,"mes":"Julio","hato":1274,"pct":0,"manual":0,"eco":0,"partos":0,"vacas":0,"novillas":0},{"finca":"Estelí /Jalapa","anio":2026,"mes":"Agosto","hato":1285,"pct":0,"manual":0,"eco":0,"partos":0,"vacas":0,"novillas":0},{"finca":"Estelí /Jalapa","anio":2026,"mes":"Septiembre","hato":1297,"pct":0,"manual":0,"eco":0,"partos":0,"vacas":0,"novillas":0},{"finca":"Estelí /Jalapa","anio":2026,"mes":"Octubre","hato":1297,"pct":0,"manual":0,"eco":0,"partos":0,"vacas":0,"novillas":0},{"finca":"Estelí /Jalapa","anio":2026,"mes":"Noviembre","hato":1297,"pct":0,"manual":0,"eco":0,"partos":0,"vacas":0,"novillas":0},{"finca":"Estelí /Jalapa","anio":2026,"mes":"Diciembre","hato":1297,"pct":0,"manual":0,"eco":0,"partos":0,"vacas":0,"novillas":0}],"inventario_general":[{"finca":"ESTELI","anio":2026,"categoria":"-Novillos","existencia_inicial":12,"compras":0,"nacimientos":0,"traslado_entradas":4,"ventas":0,"muertes":0,"traslado_salidas":0,"existencia_final":16},{"finca":"ESTELI","anio":2026,"categoria":"-Cría Machos","existencia_inicial":128,"compras":0,"nacimientos":8,"traslado_entradas":4,"ventas":0,"muertes":0,"traslado_salidas":4,"existencia_final":136},{"finca":"ESTELI","anio":2026,"categoria":"-Reproductores","existencia_inicial":47,"compras":0,"nacimientos":0,"traslado_entradas":0,"ventas":0,"muertes":0,"traslado_salidas":0,"existencia_final":47},{"finca":"ESTELI","anio":2026,"categoria":"-Toretes Reproduct","existencia_inicial":9,"compras":0,"nacimientos":0,"traslado_entradas":0,"ventas":0,"muertes":0,"traslado_salidas":0,"existencia_final":9},{"finca":"ESTELI","anio":2026,"categoria":"-Bueyes","existencia_inicial":14,"compras":0,"nacimientos":0,"traslado_entradas":0,"ventas":0,"muertes":0,"traslado_salidas":0,"existencia_final":14},{"finca":"ESTELI","anio":2026,"categoria":"-Vacas Paridas","existencia_inicial":297,"compras":0,"nacimientos":0,"traslado_entradas":24,"ventas":0,"muertes":0,"traslado_salidas":14,"existencia_final":307},{"finca":"ESTELI","anio":2026,"categoria":"-Vacas Secas","existencia_inicial":146,"compras":0,"nacimientos":0,"traslado_entradas":2,"ventas":0,"muertes":0,"traslado_salidas":12,"existencia_final":136},{"finca":"ESTELI","anio":2026,"categoria":"-Nov. Vientre","existencia_inicial":138,"compras":0,"nacimientos":0,"traslado_entradas":0,"ventas":0,"muertes":1,"traslado_salidas":0,"existencia_final":137},{"finca":"ESTELI","anio":2026,"categoria":"-Crías Hembras","existencia_inicial":168,"compras":0,"nacimientos":2,"traslado_entradas":11,"ventas":0,"muertes":0,"traslado_salidas":10,"existencia_final":171},{"finca":"ESTELI","anio":2026,"categoria":"-Hembras Levante","existencia_inicial":304,"compras":0,"nacimientos":0,"traslado_entradas":0,"ventas":32,"muertes":1,"traslado_salidas":0,"existencia_final":271},{"finca":"ESTELI","anio":2026,"categoria":"TOTAL","existencia_inicial":1263,"compras":0,"nacimientos":10,"traslado_entradas":45,"ventas":32,"muertes":2,"traslado_salidas":40,"existencia_final":1244},{"finca":"JALAPA","anio":2026,"categoria":"-Novillos","existencia_inicial":31,"compras":0,"nacimientos":0,"traslado_entradas":0,"ventas":0,"muertes":0,"traslado_salidas":0,"existencia_final":31},{"finca":"JALAPA","anio":2026,"categoria":"-Cría Machos","existencia_inicial":164,"compras":0,"nacimientos":24,"traslado_entradas":0,"ventas":0,"muertes":0,"traslado_salidas":0,"existencia_final":188},{"finca":"JALAPA","anio":2026,"categoria":"-Reproductores","existencia_inicial":25,"compras":0,"nacimientos":0,"traslado_entradas":0,"ventas":0,"muertes":0,"traslado_salidas":0,"existencia_final":25},{"finca":"JALAPA","anio":2026,"categoria":"-Vacas Paridas","existencia_inicial":384,"compras":0,"nacimientos":0,"traslado_entradas":39,"ventas":0,"muertes":0,"traslado_salidas":0,"existencia_final":423},{"finca":"JALAPA","anio":2026,"categoria":"-Vacas Secas","existencia_inicial":178,"compras":0,"nacimientos":0,"traslado_entradas":0,"ventas":0,"muertes":0,"traslado_salidas":39,"existencia_final":139},{"finca":"JALAPA","anio":2026,"categoria":"-Nov. Vientre","existencia_inicial":143,"compras":0,"nacimientos":0,"traslado_entradas":0,"ventas":0,"muertes":0,"traslado_salidas":0,"existencia_final":143},{"finca":"JALAPA","anio":2026,"categoria":"-Crías Hembras","existencia_inicial":220,"compras":0,"nacimientos":15,"traslado_entradas":0,"ventas":0,"muertes":0,"traslado_salidas":0,"existencia_final":235},{"finca":"JALAPA","anio":2026,"categoria":"-Hembras Levante","existencia_inicial":154,"compras":0,"nacimientos":0,"traslado_entradas":0,"ventas":31,"muertes":0,"traslado_salidas":0,"existencia_final":123},{"finca":"JALAPA","anio":2026,"categoria":"TOTAL","existencia_inicial":1299,"compras":0,"nacimientos":39,"traslado_entradas":39,"ventas":31,"muertes":0,"traslado_salidas":39,"existencia_final":1307}],"muertes":[{"finca":"F  I  N  C  A","anio":2025,"masa_ganadera":0,"crias_machos":0,"crias_hembras":0,"adultos":0,"muertes":0,"porcentaje":0},{"finca":"F  I  N  C  A","anio":2026,"masa_ganadera":0,"crias_machos":0,"crias_hembras":0,"adultos":0,"muertes":0,"porcentaje":0},{"finca":"El Castillo","anio":2025,"masa_ganadera":210,"crias_machos":0,"crias_hembras":0,"adultos":0,"muertes":0,"porcentaje":0},{"finca":"El Castillo","anio":2026,"masa_ganadera":9,"crias_machos":0,"crias_hembras":0,"adultos":0,"muertes":0,"porcentaje":0},{"finca":"Las Cuchillas","anio":2025,"masa_ganadera":132,"crias_machos":0,"crias_hembras":0,"adultos":2,"muertes":2,"porcentaje":2},{"finca":"Las Cuchillas","anio":2026,"masa_ganadera":224,"crias_machos":0,"crias_hembras":0,"adultos":0,"muertes":0,"porcentaje":0},{"finca":"Las Guayabas","anio":2025,"masa_ganadera":177,"crias_machos":0,"crias_hembras":0,"adultos":0,"muertes":0,"porcentaje":0},{"finca":"Las Guayabas","anio":2026,"masa_ganadera":4,"crias_machos":0,"crias_hembras":0,"adultos":0,"muertes":0,"porcentaje":0},{"finca":"Los Carbonales","anio":2025,"masa_ganadera":334,"crias_machos":0,"crias_hembras":1,"adultos":0,"muertes":1,"porcentaje":0},{"finca":"Los Carbonales","anio":2026,"masa_ganadera":537,"crias_machos":0,"crias_hembras":0,"adultos":1,"muertes":1,"porcentaje":0},{"finca":"Los Chaguites","anio":2025,"masa_ganadera":80,"crias_machos":0,"crias_hembras":0,"adultos":0,"muertes":0,"porcentaje":0},{"finca":"Los Chaguites","anio":2026,"masa_ganadera":46,"crias_machos":0,"crias_hembras":0,"adultos":0,"muertes":0,"porcentaje":0},{"finca":"Monte Fresco","anio":2025,"masa_ganadera":359,"crias_machos":0,"crias_hembras":0,"adultos":0,"muertes":0,"porcentaje":0},{"finca":"Monte Fresco","anio":2026,"masa_ganadera":424,"crias_machos":0,"crias_hembras":0,"adultos":1,"muertes":1,"porcentaje":0},{"finca":"PRIMERO MAYO","anio":2025,"masa_ganadera":1305,"crias_machos":1,"crias_hembras":1,"adultos":1,"muertes":3,"porcentaje":0},{"finca":"PRIMERO MAYO","anio":2026,"masa_ganadera":1307,"crias_machos":0,"crias_hembras":0,"adultos":0,"muertes":0,"porcentaje":0}],"nacimientos":[{"finca":"El Castillo","anio":2025,"hato_ganadero":142,"machos":0,"hembras":0,"nacimientos":0,"porcentaje":0},{"finca":"El Castillo","anio":2026,"hato_ganadero":3,"machos":0,"hembras":0,"nacimientos":0,"porcentaje":0},{"finca":"Las Cuchillas","anio":2025,"hato_ganadero":58,"machos":0,"hembras":1,"nacimientos":1,"porcentaje":2},{"finca":"Las Cuchillas","anio":2026,"hato_ganadero":104,"machos":3,"hembras":1,"nacimientos":4,"porcentaje":4},{"finca":"Las Guayabas","anio":2025,"hato_ganadero":4,"machos":0,"hembras":0,"nacimientos":0,"porcentaje":0},{"finca":"Las Guayabas","anio":2026,"hato_ganadero":2,"machos":0,"hembras":0,"nacimientos":0,"porcentaje":0},{"finca":"Los Carbonales","anio":2025,"hato_ganadero":181,"machos":2,"hembras":3,"nacimientos":5,"porcentaje":3},{"finca":"Los Carbonales","anio":2026,"hato_ganadero":236,"machos":4,"hembras":1,"nacimientos":5,"porcentaje":2},{"finca":"Los Chaguites","anio":2025,"hato_ganadero":9,"machos":0,"hembras":0,"nacimientos":0,"porcentaje":0},{"finca":"Los Chaguites","anio":2026,"hato_ganadero":14,"machos":0,"hembras":0,"nacimientos":0,"porcentaje":0},{"finca":"Monte Fresco","anio":2025,"hato_ganadero":187,"machos":8,"hembras":8,"nacimientos":16,"porcentaje":9},{"finca":"Monte Fresco","anio":2026,"hato_ganadero":221,"machos":1,"hembras":0,"nacimientos":1,"porcentaje":0},{"finca":"PRIMERO MAYO","anio":2025,"hato_ganadero":667,"machos":24,"hembras":22,"nacimientos":46,"porcentaje":7},{"finca":"PRIMERO MAYO","anio":2026,"hato_ganadero":705,"machos":24,"hembras":15,"nacimientos":39,"porcentaje":6}]}; window.CURRENT_MODULE = 'destete';</script>

  <script>
    // =========================
    // Helpers / Utils
    // =========================
    const MONTHS_FULL = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
    const MONTHS_ABBR = ['ENERO','FEBRERO','MARZO','ABRIL','MAYO','JUNIO','JULIO','AGOSTO','SEPT.','OCTUBRE','NOV.','DIC.'];

    // Formato numérico (miles: "," | decimales: ".")
    const LOCALE = 'en-US';
    if (window.Chart && Chart.defaults) {
      Chart.defaults.locale = LOCALE;

      // Animaciones globales (bonitas y suaves) para TODOS los gráficos
      Chart.defaults.animation.duration = 900;
      Chart.defaults.animation.easing = 'easeOutQuart';
      Chart.defaults.animation.delay = (ctx) => {
        if (ctx.type !== 'data') return 0;
        const i = (ctx.dataIndex || 0);
        // pequeño "stagger" sin hacer lento cuando hay muchos puntos
        return (i < 24) ? i * 12 : 0;
      };
      Chart.defaults.transitions.active.animation.duration = 350;
      Chart.defaults.transitions.resize.animation.duration = 450;
    }


    const MODULES = {
  inventario_general: {
    title: 'Inventario x Categoría',
    subtitle: 'Existencia y movimientos por categoría (Inicial / Entradas / Salidas / Final)',
    showFinca: true,
    showYear: true,
  },
  flujo_ganado_categoria: {
    title: 'Flujo de Ganado x Categoría',
    subtitle: 'Entradas, salidas y balance por categoría',
    showFinca: true,
    showYear: true,
  },
  inventario_movimiento: {
    title: 'Inventario Entradas y Salidas',
    subtitle: 'Detalle de entradas y salidas por categoría',
    showFinca: true,
    showYear: true,
  },
  nacimientos: {
    title: 'Nacimientos 2026',
    subtitle: 'Comparativo 2025 vs 2026 por finca',
    showFinca: true,
    showYear: true,
  },
  muertes: {
    title: 'Muertes 2026',
    subtitle: 'Comparativo 2025 vs 2026 por finca',
    showFinca: true,
    showYear: true,
  },
  destete: {
    title: 'Destete de Terneros',
    subtitle: 'Peso de nacimiento vs destete (por mes / sexo)',
    showFinca: false,
    showYear: false,
  },
  proyeccion_partos: {
    title: 'Proyección de Partos',
    subtitle: 'Proyección mensual (Preñeces / Concebidas / Partos / Destete)',
    showFinca: false,
    showYear: false,
  },
  ventas: {
    title: 'Ventas 2026',
    subtitle: 'Ventas (ganado y otros) — ingresos, kilos y cantidad por mes',
    showFinca: false,
    showYear: true,
  },
};

    const KNOWN_FINCAS = [
      { key: 'CASTILLO', name: 'El Castillo' },
      { key: 'CUCHILLAS', name: 'Las Cuchillas' },
      { key: 'GUAYABAS', name: 'Las Guayabas' },
      { key: 'CARBONALES', name: 'Los Carbonales' },
      { key: 'CABONALES', name: 'Los Carbonales' }, // typo frecuente
      { key: 'CHAGUITES', name: 'Los Chaguites' },
      { key: 'MONTEFRESCO', name: 'Monte Fresco' },
      { key: 'COROJALJALAPA', name: 'El Corojal Jalapa' },
      { key: 'ELCOROJALJALAPA', name: 'El Corojal Jalapa' },
      { key: 'JALAPA', name: 'El Corojal Jalapa' },
      // zonas
      { key: 'ESTELI', name: 'Estelí' },
      { key: 'ESTELÍ', name: 'Estelí' },
      { key: 'GENERAL', name: 'General' }
    ];

    function stripAccents(s) {
      try {
        return (s || '').normalize('NFD').replace(/[\u0300-\u036f]/g, '');
      } catch (e) {
        return (s || '');
      }
    }

    function normKey(s) {
      return stripAccents((s || ''))
        .toUpperCase()
        .replace(/\ufeff/g, '')
        .replace(/[^A-Z0-9]/g, ''); // solo letras/dígitos
    }

    function normalizeFincaName(raw) {
      const key = normKey(raw);
      for (const a of KNOWN_FINCAS) {
        if (key.includes(a.key)) return a.name;
      }
      // fallback suave
      return (raw || '').replace(/\ufeff/g, '').replace(/\s+/g, ' ').trim() || 'Desconocida';
    }

    function parseYearFromText(text) {
      const digits = (text || '').replace(/\D/g, '');
      const m = digits.match(/(19|20)\d{2}/);
      return m ? parseInt(m[0]) : null;
    }

    function parseDateYears(text) {
      // extrae años de fechas tipo dd/mm/yyyy
      const years = [];
      const re = /(\d{1,2})\/(\d{1,2})\/((19|20)\d{2})/g;
      let m;
      while ((m = re.exec(text || '')) !== null) {
        years.push(parseInt(m[3]));
      }
      return years;
    }

function toNumber(v) {
  const raw = (v ?? '').toString().replace(/\ufeff/g, '').trim();
  if (!raw) return 0;

  let s = raw.replace(/\s+/g, '');
  // porcentaje
  s = s.replace(/%/g, '');

  // mantener solo dígitos y separadores comunes
  s = s.replace(/[^0-9,\.\-]/g, '');
  if (!s || s === '-' || s === '.' || s === ',') return 0;

  const hasComma = s.includes(',');
  const hasDot = s.includes('.');

  if (hasComma && hasDot) {
    const lastComma = s.lastIndexOf(',');
    const lastDot = s.lastIndexOf('.');
    if (lastComma > lastDot) {
      // 1.234,56 -> 1234.56
      s = s.replace(/\./g, '').replace(/,/g, '.');
    } else {
      // 1,234.56 -> 1234.56
      s = s.replace(/,/g, '');
    }
  } else if (hasComma && !hasDot) {
    const parts = s.split(',');
    if (parts.length > 2) {
      // 1,234,567 -> 1234567
      s = parts.join('');
    } else if (parts.length === 2) {
      const dec = parts[1] || '';
      // si son 3 dígitos exactos, probablemente miles: 1,234
      if (dec.length === 3 && parts[0].length >= 1) {
        s = parts[0] + dec;
      } else {
        // decimal comma
        s = parts[0] + '.' + dec;
      }
    }
  } else if (!hasComma && hasDot) {
    const parts = s.split('.');
    if (parts.length > 2) {
      // 1.234.567,89 (sin coma) o 1.234.567 -> quitar miles
      const last = parts.pop();
      s = parts.join('') + '.' + last;
    }
  }

  const n = parseFloat(s);
  return Number.isFinite(n) ? n : 0;
}
function toNumberNullable(v) {
  const raw = (v ?? '').toString().replace(/\ufeff/g, '').trim();
  if (!raw) return null;

  let s = raw.replace(/\s+/g, '');
  if (s === '-' || s === 'NA' || s === 'N/A') return null;

  s = s.replace(/%/g, '');
  s = s.replace(/[^0-9,\.\-]/g, '');
  if (!s || s === '-' || s === '.' || s === ',') return null;

  const hasComma = s.includes(',');
  const hasDot = s.includes('.');

  if (hasComma && hasDot) {
    const lastComma = s.lastIndexOf(',');
    const lastDot = s.lastIndexOf('.');
    if (lastComma > lastDot) {
      s = s.replace(/\./g, '').replace(/,/g, '.');
    } else {
      s = s.replace(/,/g, '');
    }
  } else if (hasComma && !hasDot) {
    const parts = s.split(',');
    if (parts.length > 2) {
      s = parts.join('');
    } else if (parts.length === 2) {
      const dec = parts[1] || '';
      if (dec.length === 3 && parts[0].length >= 1) {
        s = parts[0] + dec;
      } else {
        s = parts[0] + '.' + dec;
      }
    }
  } else if (!hasComma && hasDot) {
    const parts = s.split('.');
    if (parts.length > 2) {
      const last = parts.pop();
      s = parts.join('') + '.' + last;
    }
  }

  const n = parseFloat(s);
  return Number.isFinite(n) ? n : null;
}
    function monthIndex(m) {
      const mm = stripAccents((m || '').toString()).toLowerCase().trim();
      const map = {
        'ene':0,'enero':0,'enero.':0,
        'feb':1,'febrero':1,
        'mar':2,'marzo':2,
        'abr':3,'abril':3,
        'may':4,'mayo':4,
        'jun':5,'junio':5,
        'jul':6,'julio':6,
        'ago':7,'agosto':7,
        'sep':8,'sept':8,'sept.':8,'septiembre':8,
        'oct':9,'octubre':9,
        'nov':10,'nov.':10,'noviembre':10,
        'dic':11,'dic.':11,'diciembre':11
      };
      const k = mm.replace(/\s+/g,'');
      return (k in map) ? map[k] : -1;
    }

    function normalizeMonthToFull(m) {
      const idx = monthIndex(m);
      return idx >= 0 ? MONTHS_FULL[idx] : (m || '').toString().trim();
    }

    function humanJoin(arr, conj='y') {
      const a = (arr || []).map(x => (x ?? '').toString()).map(x => x.trim()).filter(x => x !== '');
      if (a.length === 0) return '';
      if (a.length === 1) return a[0];
      if (a.length === 2) return a[0] + ' ' + conj + ' ' + a[1];
      return a.slice(0, -1).join(', ') + ' ' + conj + ' ' + a[a.length - 1];
    }

    function fmtNum(n, decimals=0) {
      const num = Number(n || 0);
      return num.toLocaleString(LOCALE, { maximumFractionDigits: decimals, minimumFractionDigits: decimals });
    }

    function fmtPct(n, decimals=2) {
      const num = Number(n || 0);
      return `${num.toLocaleString(LOCALE, { maximumFractionDigits: decimals, minimumFractionDigits: decimals })}%`;
    }

    function genDistinctColors(n, alpha=0.85) {
      const out = [];
      const count = Math.max(1, parseInt(n || 0));
      for (let i = 0; i < count; i++) {
        const hue = Math.round((360 * i) / count);
        out.push(`hsla(${hue}, 70%, 55%, ${alpha})`);
      }
      return out;
    }

    function uniq(arr) {
      return [...new Set(arr)];
    }

    function groupBy(arr, keyFn) {
      const m = {};
      arr.forEach(x => {
        const k = keyFn(x);
        (m[k] = m[k] || []).push(x);
      });
      return m;
    }

    

    // Placeholder para módulos que usan #sectionContent
    function renderNoDataState() {
      const sectionContent = document.getElementById('sectionContent');
      if (sectionContent) {
        sectionContent.classList.remove('hidden');
        sectionContent.innerHTML = '<p class="text-center text-slate-400">No hay datos disponibles para mostrar.</p>';
      }
    }

    // =========================
    // State / Elements
    // =========================
    let charts = {};

// Limpia UI y destruye gráficos para evitar que queden tarjetas/gráficos de otro módulo
function resetView() {
  // destruir charts existentes
  try {
    if (charts && typeof charts === 'object') {
      Object.keys(charts).forEach(k => {
        try { charts[k] && charts[k].destroy && charts[k].destroy(); } catch(e) {}
      });
    }
  } catch(e) {}
  charts = {};

  // limpiar contenedores
  if (kpiContainer) kpiContainer.innerHTML = '';
  if (chartsContainer) chartsContainer.innerHTML = '';
  if (sectionContent) sectionContent.innerHTML = '';
}

// Pequeña animación visual al cambiar de sección
function animateSection() {
  const host = document.getElementById('dashboardContent') || sectionContent || document.body;
  if (!host) return;
  host.classList.remove('section-fade-in');
  // reflow para reiniciar animación
  void host.offsetWidth;
  host.classList.add('section-fade-in');
}



// Animación "bonita" para las tarjetas que contienen gráficos (stagger)
function animateChartsIn() {
  const sectionContentEl = document.getElementById('sectionContent');
  const chartsContainerEl = document.getElementById('chartsContainer');
  const host = (sectionContentEl && !sectionContentEl.classList.contains('hidden')) ? sectionContentEl : chartsContainerEl;
  if (!host) return;

  const canvases = Array.from(host.querySelectorAll('canvas'));
  const seen = new Set();
  let idx = 0;

  canvases.forEach(cv => {
    const card = cv.closest('.bg-white') || cv.closest('.rounded-2xl') || cv.parentElement;
    if (!card || seen.has(card)) return;
    seen.add(card);

    // reiniciar animación
    card.classList.remove('chart-pop');
    card.style.animationDelay = `${Math.min(idx, 10) * 70}ms`;
    void card.offsetWidth;
    card.classList.add('chart-pop');
    idx++;
  });
}


    // Cache de elementos clave (evita ReferenceError en renderDashboard)
    const kpiContainer = document.getElementById('kpiContainer');
    const chartsContainer = document.getElementById('chartsContainer');


    window.UI_STATE = window.UI_STATE || {};

    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const dashboardContent = document.getElementById('dashboardContent');
    const noDataState = document.getElementById('noDataState');
    const saveBtn = document.getElementById('saveBtn');
    const fincaFilterWrap = document.getElementById('fincaFilterWrap');
    const fincaFilter = document.getElementById('fincaFilter');
    const categoriaFilterWrap = document.getElementById('categoriaFilterWrap');
    const categoriaFilter = document.getElementById('categoriaFilter');
    const monthFilterWrap = document.getElementById('monthFilterWrap');
    const monthFilter = document.getElementById('monthFilter');
    const sexoFilterWrap = document.getElementById('sexoFilterWrap');
    const sexoFilter = document.getElementById('sexoFilter');
    const yearStartFilter = document.getElementById('yearStartFilter');
    const yearEndFilter = document.getElementById('yearEndFilter');
    const yearFiltersDiv = document.getElementById('yearFilters');
    const resetFilters = document.getElementById('resetFilters');

    window.onload = () => {
      setupDragAndDrop();
      setupFilters();
      setupExport();
      if (hasAnyDataLoaded()) {
        switchModule(window.CURRENT_MODULE);
      }
    };

    function hasAnyDataLoaded() {
      return Object.keys(window.APP_DATA).some(k => Array.isArray(window.APP_DATA[k]) && window.APP_DATA[k].length);
    }

    function setHeaderForModule(mod) {
      const meta = MODULES[mod] || { title: 'Dashboard', subtitle: '' };
      document.getElementById('mainTitle').innerText = meta.title;
      document.getElementById('mainSubtitle').innerText = meta.subtitle;

      // show/hide filters per module
      const cfg = MODULES[mod] || {};
      if (cfg.showFinca === false) fincaFilterWrap.classList.add('hidden');
      else fincaFilterWrap.classList.remove('hidden');

      if (cfg.showYear === false) yearFiltersDiv.classList.add('hidden');
      else yearFiltersDiv.classList.remove('hidden');

      // Mes: se decide dinámicamente en populateFilters (según si el módulo tiene columna de mes)
      if (monthFilterWrap) monthFilterWrap.classList.add('hidden');

      // Sexo (solo Destete)
      if (sexoFilterWrap && sexoFilter) {
        if (mod === 'destete') {
          sexoFilterWrap.classList.remove('hidden');
        } else {
          sexoFilterWrap.classList.add('hidden');
          sexoFilter.value = 'todos';
        }
      }
    }

    
    function updateCategoriaFilterVisibility(mod) {
      if (!categoriaFilterWrap) return;
      if (mod === 'ventas') {
        categoriaFilterWrap.classList.remove('hidden');
      } else {
        categoriaFilterWrap.classList.add('hidden');
        if (categoriaFilter) categoriaFilter.value = 'all';
      }
    }

function switchModule(mod) {
      window.CURRENT_MODULE = mod;

      document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
      const navBtn = document.getElementById(`nav-${mod}`);
      if (navBtn) navBtn.classList.add('active');

      setHeaderForModule(mod);
      updateCategoriaFilterVisibility(mod);

      // limpiar UI al cambiar de sección
      resetView();

      if (window.APP_DATA[mod] && window.APP_DATA[mod].length > 0) {
        populateFilters();
        renderDashboard();
      } else {
        dashboardContent.classList.add('opacity-50', 'pointer-events-none');
        noDataState.classList.remove('hidden');
        // Asegura que NO queden tarjetas/gráficos viejos
        resetView();
        renderNoDataState();
        document.getElementById('placeholderText').innerText = `Sube el archivo CSV de “${(MODULES[mod]?.title || mod)}” para comenzar.`;
      }
      animateSection();
}

    function setupDragAndDrop() {
      dropZone.onclick = () => fileInput.click();
      fileInput.onchange = (e) => handleMultipleFiles(e.target.files);
      dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('over'); };
      dropZone.ondragleave = () => dropZone.classList.remove('over');
      dropZone.ondrop = (e) => {
        e.preventDefault();
        dropZone.classList.remove('over');
        handleMultipleFiles(e.dataTransfer.files);
      };
    }

    function setupFilters() {
      const update = () => renderDashboard();
      fincaFilter.onchange = update;
      yearStartFilter.onchange = update;
      yearEndFilter.onchange = update;
      if (monthFilter) monthFilter.onchange = update;
      if (sexoFilter) sexoFilter.onchange = update;
      if (categoriaFilter) categoriaFilter.onchange = update;
      resetFilters.onclick = () => { populateFilters(); if (sexoFilter) sexoFilter.value = 'todos'; if (categoriaFilter) categoriaFilter.value = 'all'; update(); };
    }

    // =========================
    // File detection & Parsing
    // =========================
function detectModuleFromContent(fileName, rows) {
  // 1) Prioridad: detección por nombre de archivo (normalizado)
  const byName = detectModuleFromFilename(fileName || '');
  if (byName) return byName;

  // 2) Respaldo: detección por contenido (primeras filas)
  try {
    const sample = (rows || []).slice(0, 30).map(r => (r || []).join(' ')).join(' ');
    const s = normalizeKey(sample).replace(/\s+/g, '').toUpperCase();
    if (!s) return null;

    if (s.includes('INVENTARIOSDEGANADOBOVINO') && s.includes('SEXO') && s.includes('CATEGORIA')) return 'inventario_general';
    if (s.includes('FLUJODEGANADOBOVINO')) return 'flujo_ganado_categoria';
    if (s.includes('INVENTARIODEMOVIMIENTODEGANADOBOVINO')) return 'inventario_movimiento';
    if (s.includes('INFORMEDENACIMIENTOS')) return 'nacimientos';
    if (s.includes('INFORMEDEMUERTES')) return 'muertes';
    if (s.includes('INFORMEDEDESTETE')) return 'destete';
    if (s.includes('PROYECCIONDEPARTOS') || s.includes('PROYECIONDEPARTOS')) return 'proyeccion_partos';
    if (s.includes('VENTASDEHEMBRAS') || s.includes('VENTASDEMACHOS') || (s.includes('VENTASDE') && s.includes('IMPORTE') && s.includes('FECHA'))) return 'ventas';

  } catch (e) {
    // silent
  }

  return null;
}
    function afterDataLoaded(mod) {
      // Actualizar filtros siempre que se procese cualquier CSV
      populateFilters();

      // Importante: refrescar la vista actual aunque el CSV cargado sea de otro módulo,
      // para salir del estado "Sube archivos CSV..." y mostrar los módulos con datos.
      if (hasAnyDataLoaded()) {
        renderDashboard();
        document.getElementById('lastUpdate').innerText = `Actualizado: ${new Date().toLocaleString()}`;
      }
    }

    function handleMultipleFiles(files) {
      if (!files || files.length === 0) return;

      Array.from(files).forEach(file => {
        Papa.parse(file, {
          delimiter: ";",
          skipEmptyLines: "greedy",
          quoteChar: '"',
          complete: (results) => {
            const rows = results.data;
            if (!rows || rows.length === 0) return;

            const content = rows
              .slice(0, 30)
              .map(r => (r || []).join(' '))
              .join(' ')
              .toUpperCase()
              .replace(/\ufeff/g, '');

            const mod = detectModuleFromContent(file.name, rows);
            console.log("Archivo:", file.name, "| módulo detectado:", mod);

            if (!mod) {
              console.warn("No se pudo detectar el tipo de CSV:", file.name);
              return;
            }

            try {
              if (mod === 'inventario_general') processInventarioGeneral(rows);
              else if (mod === 'hato_reproductivo') processHatoReproductivo(rows);
              else if (mod === 'flujo_ganado_categoria') processFlujoGanadoCategoria(rows);
              else if (mod === 'inventario_movimiento') processInventarioMovimiento(rows);
              else if (mod === 'nacimientos') processNacimientos(rows);
              else if (mod === 'nacimientos_mes') processNacimientosMes(rows);
              else if (mod === 'nacimientos_finca') processNacimientoFinca(rows);
              else if (mod === 'muertes') processMuertes(rows);
              else if (mod === 'muertes_mes') processMuertesMes(rows);
              else if (mod === 'muertes_fincas') processMuertesFincas(rows);
              else if (mod === 'lluvias') processLluvias(rows);
              else if (mod === 'pesajes') processPesajes(rows);
              else if (mod === 'hembras') processHembras(rows);
              else if (mod === 'proyeccion_partos') processProyeccionPartos(rows);
              else if (mod === 'destete') processDestete(rows);
                            else if (mod === 'ventas') processVentas(rows);
else if (mod === 'ventas_ganado') processVentasGanado(rows);
            } catch (e) {
              console.error("Error procesando", file.name, "=>", e);
              alert(`Error procesando ${file.name}: ${e.message || e}`);
              return;
            }

            afterDataLoaded(mod);
          }
        });
      });
    }

    // =========================
    // Processors (CSV -> APP_DATA)
    // =========================

function processInventarioGeneral(rows) {
  // CSV: "Inventario X Categoría"
  // Soporta el formato tipo "reporte" (encabezado en 2 filas: Existencia / Entradas / Salidas / Existencia)
  // y múltiples zonas (ej. "FINCAS DE ESTELI", "FINCAS DE JALAPA") en el mismo archivo.

  const out = [];

  // Detectar año (si aparece en el archivo)
  let detectedYear = null;
  try {
    const bigText = rows
      .slice(0, 80)
      .flat()
      .join(' ')
      .toString()
      .replace(/\ufeff/g, ' ')
      .toUpperCase();
    const ym = bigText.match(/\b(20\d{2})\b/);
    if (ym) detectedYear = parseInt(ym[1], 10);
  } catch (e) {}
  if (!detectedYear) detectedYear = new Date().getFullYear();

  const clean = (v) => (v ?? '').toString().replace(/\ufeff/g, '').trim();

  let currentZona = null;

  for (let i = 0; i < rows.length; i++) {
    const r = rows[i] || [];
    const rowText = clean(r.join(' '));
    const rowKey = normalizeKey(rowText);

    // 1) Detectar zona: "INVENTARIOS ... FINCAS DE ESTELI/JALAPA/..."
    const zonaMatch = rowKey.match(/FINCAS\s+DE\s+([A-Z]+)/);
    if (zonaMatch) {
      currentZona = zonaMatch[1];
      continue;
    }

    if (!currentZona) continue;

    // 2) Detectar encabezado (fila 1): "Sexo / Categoría"
    const isHeader1 =
      (normalizeKey(clean(r[0])) || '').includes('SEXO') &&
      (rowKey.includes('CATEGORIA') || rowKey.includes('CATEGORÍA'));

    if (!isHeader1) continue;

    // Encabezado fila 2 suele venir inmediatamente después
    const h1 = rows[i] || [];
    const h2 = rows[i + 1] || [];

    let major = h1.map(c => normalizeKey(clean(c)).replace(/\s+/g, '')); // EXISTENCIA / ENTRADA / SALIDAS / EXISTENCIA

    // En reportes, los títulos de sección (EXISTENCIA/ENTRADAS/SALIDAS) suelen venir en una sola celda y las demás quedan vacías.
    // Expandimos el último título no vacío hacia la derecha para poder mapear subcolumnas correctamente.
    for (let c = 1; c < major.length; c++) {
      if (!major[c] && major[c - 1]) major[c] = major[c - 1];
    }
    const sub = h2.map(c => normalizeKey(clean(c))); // INICIAL, NACIMIENTOS, COMPRAS, TRASLADO, VENTAS, MUERTOS, TRASLADO, FINAL

    const idx = {
      inicial: null,
      compras: null,
      nacimientos: null,
      entradas: null, // traslado entradas
      ventas: null,
      muertes: null,
      salidas: null,  // traslado salidas
      final: null
    };

    for (let c = 0; c < Math.max(major.length, sub.length); c++) {
      const maj = major[c] || '';
      const s = sub[c] || '';

      if (s === 'INICIAL' && maj.includes('EXISTENCIA')) idx.inicial = c;
      else if (s === 'FINAL' && maj.includes('EXISTENCIA')) idx.final = c;
      else if (s === 'COMPRAS' && (maj.includes('ENTR') || maj.includes('ENTRA'))) idx.compras = c;
      else if (s === 'NACIMIENTOS' && (maj.includes('ENTR') || maj.includes('ENTRA'))) idx.nacimientos = c;
      else if (s === 'VENTAS' && (maj.includes('SALID') || maj.includes('SALIDA'))) idx.ventas = c;
      else if (s === 'MUERTOS' && (maj.includes('SALID') || maj.includes('SALIDA'))) idx.muertes = c;
      else if (s === 'TRASLADO') {
        if (maj.includes('ENTR') || maj.includes('ENTRA')) idx.entradas = c;
        else if (maj.includes('SALID') || maj.includes('SALIDA')) idx.salidas = c;
      }
    }

    // Fallback (por si el CSV viene con encabezado en una sola fila)
    if (idx.inicial === null || idx.final === null) {
      const rowCells = (rows[i] || []).map(x => normalizeKey(clean(x)));
      const findIdx = (needle) => rowCells.findIndex(v => v === needle);
      const jIn = findIdx('INICIAL');
      const jFi = findIdx('FINAL');
      if (jIn >= 0) idx.inicial = jIn;
      if (jFi >= 0) idx.final = jFi;
    }

    // Avanza: saltar la fila 2 del encabezado si parece ser subencabezado
    const looksLikeSubHeader = sub.some(x => ['INICIAL','NACIMIENTOS','COMPRAS','VENTAS','MUERTOS','TRASLADO','FINAL'].includes(x));
    if (looksLikeSubHeader) i = i + 1;

    // 3) Consumir filas de datos hasta llegar a otra zona o a otro encabezado
    for (let j = i + 1; j < rows.length; j++) {
      const rr = rows[j] || [];
      const t = clean(rr.join(' '));
      const k = normalizeKey(t);

      // Corte por nueva zona o nuevo encabezado
      if (k.match(/FINCAS\s+DE\s+[A-Z]+/)) { i = j - 1; break; }
      if ((normalizeKey(clean(rr[0])) || '').includes('SEXO') && (k.includes('CATEGORIA') || k.includes('CATEGORÍA'))) { i = j - 1; break; }

      const categoriaRaw = clean(rr[0]).replace(/\s+/g, ' ').trim();
      if (!categoriaRaw) continue;

      const catKey = normalizeKey(categoriaRaw);

      // Omitir subtotales/grupos (pero conservar TOTAL)
      const isSubTotal = catKey.includes('SUB') && catKey.includes('TOTAL');
      if (isSubTotal) continue;

      // Armar registro (si falta un índice, toNumber(undefined)->0)
      const rec = {
        finca: currentZona,
        anio: detectedYear,
        categoria: categoriaRaw,
        existencia_inicial: toNumber(rr[idx.inicial]),
        compras: toNumber(rr[idx.compras]),
        nacimientos: toNumber(rr[idx.nacimientos]),
        traslado_entradas: toNumber(rr[idx.entradas]),
        ventas: toNumber(rr[idx.ventas]),
        muertes: toNumber(rr[idx.muertes]),
        traslado_salidas: toNumber(rr[idx.salidas]),
        existencia_final: toNumber(rr[idx.final]),
      };

      // Evitar doble conteo:
      // - Mantener SOLO el TOTAL global por zona (ESTELI/JALAPA/etc.)
      // - Ignorar totales por sexo (TOTAL MACHOS / TOTAL HEMBRAS)
      // - Ignorar el TOTAL combinado (ESTELI Y JALAPA) si aparece en el mismo archivo
      if (catKey.includes('ESTELI') && catKey.includes('JALAPA')) continue;

      const isSexTotal = catKey.startsWith('TOTAL') && (catKey.includes('MACH') || catKey.includes('HEMB'));
      if (isSexTotal) {
        // conservar texto original para tabla, pero NO se usará en KPIs (KPIs solo usan categoria === 'TOTAL')
        rec.categoria = categoriaRaw;
      } else if (catKey === 'TOTAL' || (catKey.startsWith('TOTAL') && !catKey.includes('MACH') && !catKey.includes('HEMB'))) {
        // este sí es el total global de la zona
        rec.categoria = 'TOTAL';
      }

      // Saltar encabezados de grupo (MACHOS/HEMBRAS...) si no traen números
      const sumAbs =
        Math.abs(rec.existencia_inicial) + Math.abs(rec.compras) + Math.abs(rec.nacimientos) +
        Math.abs(rec.traslado_entradas) + Math.abs(rec.ventas) + Math.abs(rec.muertes) +
        Math.abs(rec.traslado_salidas) + Math.abs(rec.existencia_final);

      if (sumAbs === 0 && rec.categoria !== 'TOTAL') continue;

      out.push(rec);
    }
  }

  // Nota: NO añadimos el "TOTAL ESTELI Y JALAPA" (global) para evitar doble conteo en KPIs.
  window.APP_DATA.inventario_general = out;
}


    function processHatoReproductivo(rows) {
      const out = [];
      let currentFinca = null;
      let months = [];
      let colMeta = [];

      rows.forEach(r => {
        if (!r || r.length === 0) return;
        const firstRaw = (r[0] ?? '').toString();
        const first = firstRaw.replace(/\ufeff/g,'').trim();
        const rowUpper = (r || []).join(' ').toUpperCase().replace(/\ufeff/g,'');

        // header meses
        if (first.toUpperCase().includes('HATO') && rowUpper.includes('ENERO') && rowUpper.includes('FEBRERO')) {
          const m = [];
          for (let i = 1; i <= 23; i += 2) {
            m.push(normalizeMonthToFull((r[i] ?? '').toString()));
          }
          months = m;
          return;
        }

        // header años
        if (first.toUpperCase().includes('POR') && rowUpper.includes('2024') && rowUpper.includes('2025')) {
          colMeta = [];
          for (let i = 1; i <= 24; i++) {
            const mes = months[Math.floor((i-1)/2)] || `Mes${Math.floor((i-1)/2)+1}`;
            const anio = parseInt((r[i] ?? '').toString().replace(/\D/g,'')) || null;
            colMeta.push({ mes, anio });
          }
          return;
        }

        // finca line (solo cuando inicia con "FINCA", no para "TOTAL FINCA ...")
        if (normKey(first).startsWith('FINCA')) {
          currentFinca = normalizeFincaName(firstRaw);
          return;
        }
// category rows
        if (!currentFinca || !colMeta.length) return;
        const hasNumbers = (r.slice(1,25) || []).some(x => (x ?? '').toString().trim() !== '');
        if (!hasNumbers || !first) return;

        let categoria = first.replace(/\s+/g,' ').trim();
        const catKey = normKey(categoria);

        if (catKey.includes('SUB') && catKey.includes('TOTAL')) categoria = 'TOTAL';
        // Algunos reportes traen "TOTAL FINCA J A L A P A" (o zona) en vez de "SUB > TOTAL"
        if (catKey.includes('TOTALFINCA') && !catKey.includes('TOTALGENERAL')) {
          categoria = 'TOTAL';
          currentFinca = normalizeFincaName(firstRaw);
        }
        if (catKey.includes('TOTALGENERAL')) { currentFinca = 'General'; categoria = 'TOTAL'; }
        if (catKey.includes('VARIACION')) categoria = 'VARIACION';

        for (let i = 0; i < colMeta.length; i++) {
          const v = toNumber(r[1+i]);
          const { mes, anio } = colMeta[i];
          if (anio == null) continue;
          out.push({
            finca: currentFinca,
            anio,
            mes: normalizeMonthToFull(mes),
            categoria,
            valor: v
          });
        }
      });

      window.APP_DATA.hato_reproductivo = out;
    }

    function processFlujoGanadoCategoria(rows) {
      const out = [];
      let group = null;

      // año: preferir fechas dd/mm/yyyy
      const firstBlock = rows.slice(0, 15).map(r => (r || []).join(' ')).join(' ');
      const dateYears = parseDateYears(firstBlock);
      let year = (dateYears && dateYears.length) ? Math.max(...dateYears) : null;
      if (!year) {
        year = parseYearFromText(firstBlock) || new Date().getFullYear();
      }

      rows.forEach(r => {
        if (!r || r.length < 3) return;
        const c0 = (r[0] ?? '').toString().replace(/\ufeff/g,'').trim();
        const c1 = (r[1] ?? '').toString().trim();
        const rowUpper = (r || []).join(' ').toUpperCase();

        if (!c0 && !c1) return;

        // group row
        if (!/^\d+$/.test(c0) && !c0.toUpperCase().startsWith('SUB') && !c0.toUpperCase().startsWith('TOTAL') && (c1 === '' || c1 == null)) {
          group = c0.replace(/\s+/g,' ').trim();
          return;
        }

        if (/^\d+$/.test(c0) || c0.toUpperCase().startsWith('SUB') || c0.toUpperCase().startsWith('TOTAL')) {
          const rec = {
            finca: 'General',
            anio: year,
            grupo: group || 'General',
            codigo: c0,
            categoria: (/^\d+$/.test(c0) ? c1 : c0).replace(/\s+/g,' ').trim(),
            inicial: toNumber(r[2]),
            nacimientos: toNumber(r[3]),
            compras: toNumber(r[4]),
            muertes: toNumber(r[5]),
            ventas: toNumber(r[6]),
            transf_salida: toNumber(r[7]),
            transf_entrada: toNumber(r[8]),
            final: toNumber(r[9])
          };
          out.push(rec);
        }
      });

      window.APP_DATA.flujo_ganado_categoria = out;
    }

    function processInventarioMovimiento(rows) {
      const out = [];
      const compact = (s) => stripAccents(s || '').toUpperCase().replace(/[^A-Z0-9]/g, '');

      // Año global (se toma del encabezado, por ejemplo: "AL DIA 2/1/2026")
      let globalYear = null;
      for (let i = 0; i < Math.min(25, rows.length); i++) {
        const y = parseYearFromText((rows[i] || []).join(' '));
        if (y) { globalYear = y; break; }
      }

      // Función para "reconstruir" nombres de finca cuando vienen con letras separadas:
      // "F  I  N  C  A      EL      C  A  S  T  I  LL  O" => "El Castillo"
      function cleanFincaName(raw) {
        let s = (raw || '').toString();
        // quitar la palabra FINCA aun si viene con espacios entre letras
        s = s.replace(/F\s*I\s*N\s*C\s*A/i, ' ').trim();
        // dividir por grupos de 2+ espacios (suelen separar palabras)
        const segments = s.split(/\s{2,}/).map(seg => seg.trim()).filter(Boolean);

        const stop = new Set(['EL','LA','LOS','LAS','DE','DEL','Y','SAN','SANTA']);
        const words = [];

        segments.forEach(seg => {
          const tokens = seg.split(/\s+/).filter(Boolean);
          let buf = '';

          tokens.forEach(t => {
            const tUp = stripAccents(t).toUpperCase();
            if (stop.has(tUp)) {
              if (buf) { words.push(buf); buf = ''; }
              words.push(tUp);
            } else if (/^[A-ZÑ]{1,2}$/.test(tUp)) {
              // letras sueltas (incluye "LL")
              buf += tUp;
            } else {
              if (buf) { words.push(buf); buf = ''; }
              words.push(tUp);
            }
          });

          if (buf) { words.push(buf); buf = ''; }
        });

        const normalized = words.join(' ').replace(/\s+/g, ' ').trim();
        if (!normalized) return '';

        // Title Case para una presentación más bonita
        return normalized.split(' ').map(w => w.charAt(0) + w.slice(1).toLowerCase()).join(' ');
      }

      const cats = [
        'Vacas Paridas','Vacas Secas','Novilla Vientre','Crías Machos','Crías Hembras',
        'Hembras Levante','Novillos Desarrollo','Toros','Toretes','Bueyes','Existencia Final'
      ];

      const movementTypes = [
        'Inventario Inicial','Compras','Nacimiento','Entradas','Ventas','Muertes',
        'Salidas','Saladas','Inventario Final'
      ];

      // Normalizar tipos para comparación robusta
      const typeMap = {};
      movementTypes.forEach(mt => { typeMap[normalizeKey(mt)] = mt; });

      let finca = null;

      rows.forEach((r) => {
        const c0 = (r[0] || '').toString();
        const rowKey = compact(c0);

        // Detectar inicio de bloque por finca (aunque venga "F I N C A ...")
        if (rowKey.includes('FINCA')) {
          const cleaned = cleanFincaName(c0);
          finca = cleaned || c0.trim();
          return;
        }

        if (!finca) return;

        const rawType = (r[0] || '').toString().trim();
        if (!rawType) return;

        const tKey = normalizeKey(rawType);
        const canonicalType = typeMap[tKey];
        if (!canonicalType) return;

        cats.forEach((cat, i) => {
          out.push({
            anio: globalYear,
            finca,
            categoria: cat,
            tipo: canonicalType,
            valor: toNumber(r[1 + i]),
          });
        });
      });

      window.APP_DATA.inventario_movimiento = out;
    }

function processNacimientos(rows) {
      const out = [];
      const compact = (s) => stripAccents(s || '').toUpperCase().replace(/[^A-Z0-9]/g, '');

      // Detectar años correctamente (evitar tomar el año del "MES ... 2026" como primer año)
      const parseYearsOrdered = (text) => {
        const matches = (text || '').match(/\b(20\d{2})\b/g) || [];
        const seen = new Set();
        const yrs = [];
        for (const t of matches) {
          const y = Number(t);
          if (Number.isFinite(y) && !seen.has(y)) { seen.add(y); yrs.push(y); }
        }
        return yrs;
      };

      let year1 = null;
      let year2 = null;

      // 1) Buscar una línea que contenga AMBOS años (p.ej. "... 2025 ... 2026 ...") y respetar el orden de aparición
      for (let i = 0; i < Math.min(30, rows.length); i++) {
        const txt = (rows[i] || []).join(' ');
        const yrs = parseYearsOrdered(txt);
        if (yrs.length >= 2) { year1 = yrs[0]; year2 = yrs[1]; break; }
      }

      // 2) Fallback: si solo aparece un año (p.ej. 2026), asumimos comparativo año-1 vs año
      if (!year1 && !year2) {
        const years = [];
        for (let i = 0; i < Math.min(20, rows.length); i++) {
          const y = parseYearFromText((rows[i] || []).join(' '));
          if (y && !years.includes(y)) years.push(y);
        }
        if (years.length >= 2) { year1 = years[0]; year2 = years[1]; }
        else if (years.length === 1) { year2 = years[0]; year1 = year2 - 1; }
      }

      // Asegurar que el primer bloque (izquierda) sea el año menor y el segundo (derecha) el mayor
      if (year1 && year2 && year1 > year2) { const tmp = year1; year1 = year2; year2 = tmp; }

      // Encontrar fila de encabezado donde la primera celda sea "FINCA" (aunque venga con letras separadas)
      let headerIdx = -1;
      for (let i = 0; i < Math.min(25, rows.length); i++) {
        const first = (rows[i]?.[0] ?? '').toString();
        if (compact(first).startsWith('FINCA')) { headerIdx = i; break; }
      }
      if (headerIdx < 0) { window.APP_DATA.nacimientos = out; return; }

      const y1 = year1 || year2 || null;
      const y2 = year2 || year1 || null;

      // Layout típico:
      // 0 FINCA | 1 HATO | 2 Macho | 3 Hembra | 4 Total | 5 % | 6 (vacío) | 7 HATO | 8 Macho | 9 Hembra | 10 Total | 11 % | 12 Variación
      const dataRows = rows.slice(headerIdx + 2);
      dataRows.forEach((r) => {
        const finca = (r[0] || '').toString().trim();
        if (!finca) return;

        const fkey = compact(finca);
        if (fkey.includes('TOTAL')) return;

        out.push({
          finca,
          anio: y1,
          hato_ganadero: toNumber(r[1]),
          machos: toNumber(r[2]),
          hembras: toNumber(r[3]),
          nacimientos: toNumber(r[4]),
          porcentaje: toNumber((r[5] || '').toString()),
        });

        out.push({
          finca,
          anio: y2,
          hato_ganadero: toNumber(r[7]),
          machos: toNumber(r[8]),
          hembras: toNumber(r[9]),
          nacimientos: toNumber(r[10]),
          porcentaje: toNumber((r[11] || '').toString()),
        });
      });

      window.APP_DATA.nacimientos = out;
    }

    function processNacimientosMes(rows) {
      const out = [];
      let headerIdx = -1;

      // detectar año
      const head = rows.slice(0, 10).map(r => (r||[]).join(' ')).join(' ');
      const yearMain = parseYearFromText(head) || 2025;

      for (let i = 0; i < Math.min(rows.length, 20); i++) {
        const first = (rows[i]?.[0] ?? '').toString();
        if (normKey(first).startsWith('FINCA')) { headerIdx = i; break; }
      }
      if (headerIdx < 0) return;

      const monthCols = MONTHS_ABBR.map(m => normalizeMonthToFull(m));

      const seen = new Set();
      for (let i = headerIdx + 1; i < rows.length; i++) {
        const r = rows[i];
        if (!r || r.length < 2) continue;
        let nameRaw = (r[0] ?? '').toString().replace(/\ufeff/g,'').trim();
        if (!nameRaw) continue;

        const nameKey = normKey(nameRaw);

        // ignorar filas vacías/lineas de relleno
        if (nameKey === '') continue;

        // diferencias no se cargan como serie
        if (nameKey.includes('DIFERENCIA')) continue;

        let anio = yearMain;
        let finca = normalizeFincaName(nameRaw);

        if (nameKey.includes('TOTALGENERAL2024') || (nameKey.includes('TOTALGENERAL') && nameKey.includes('2024'))) {
          anio = 2024;
          finca = 'TOTAL GENERAL';
        } else if (nameKey.includes('TOTALGENERAL')) {
          finca = 'TOTAL GENERAL';
        }

        for (let m = 0; m < 12; m++) {
          const val = toNumber(r[1+m]);
          const mes = monthCols[m];
          const sig = `${finca}|${anio}|${mes}|${val}`;
          if (seen.has(sig)) continue;
          seen.add(sig);
          out.push({ finca, anio, mes, nacimientos: val });
        }
      }

      window.APP_DATA.nacimientos_mes = out;
    }

    
    function processNacimientoFinca(rows) {
      const out = [];
      let headerIdx = -1;

      const head = rows.slice(0, 15).map(r => (r || []).join(' ')).join(' ');
      const yearMain = parseYearFromText(head) || 2025;

      // header meses (fila con ;ENERO;FEBRERO...)
      for (let i = 0; i < Math.min(rows.length, 60); i++) {
        const c1 = ((rows[i]?.[1] ?? '') + '').replace(/\ufeff/g,'').trim().toUpperCase();
        if (c1.startsWith('ENERO')) { headerIdx = i; break; }
      }
      if (headerIdx < 0) return;

      const monthCols = MONTHS_FULL;

      const read12Nums = (row, start) => {
        const arr = [];
        for (let i = 0; i < 12; i++) arr.push(toNumber(row?.[start + i]));
        return arr;
      };

      const read12Pct = (row, start) => {
        const arr = [];
        for (let i = 0; i < 12; i++) {
          const s = ((row?.[start + i] ?? '') + '').replace(/\ufeff/g,'').trim();
          if (!s) { arr.push(null); continue; }
          const cleaned = s.replace('%','').replace(/,/g,'').replace(/[^\d.-]/g,'');
          const v = parseFloat(cleaned);
          arr.push(isNaN(v) ? null : v);
        }
        return arr;
      };

      const hasPctCells = (row) => (row || []).some(c => ((c ?? '') + '').includes('%'));

      const cleanFinca = (raw) => {
        let s = (raw || '').replace(/\ufeff/g,'').trim();
        s = s.replace(/^FINCA\s+/i, '');
        s = s.replace(/^F\.\-\s*/i, '');
        s = s.replace(/^F\.\s*/i, '');
        s = s.replace(/^F\-\s*/i, '');
        s = s.replace(/^F\s*-\s*/i, '');
        s = s.replace(/^F\s*\.\s*-\s*/i, '');
        return s.trim();
      };

      // El archivo viene en bloques:
      // Hato Reproductivo -> Crías Machos -> Crías Hembras -> FINCA <nombre> (fila con %)
      // o bien: Hato -> Machos -> Hembras -> F.-<nombre> (fila con %)
      for (let i = headerIdx + 1; i < rows.length; i++) {
        const r = rows[i];
        if (!r || r.length < 2) continue;

        const firstRaw = ((r[0] ?? '') + '').replace(/\ufeff/g,'').trim();
        if (!firstRaw) continue;

        const k = normKey(firstRaw);

        // descartar filas que NO son fincas
        if (k.startsWith('HATOREPRODUCTIVO')) continue;
        if (k.startsWith('CRIAS')) continue;
        if (k.startsWith('NACIMIENTOZONA')) continue;
        if (k.startsWith('PORCENTAJE')) continue;
        if (k.startsWith('TOTAL')) continue;

        const looksLikeFinca = k.startsWith('FINCA') || (k.startsWith('F') && hasPctCells(r));
        if (!looksLikeFinca) continue;

        // buscamos las 3 filas anteriores (con tolerancia)
        let rHato = null, rMach = null, rHem = null;
        for (let back = 1; back <= 6; back++) {
          const rr = rows[i - back] || [];
          const kk = normKey((rr[0] ?? '') + '');
          if (!rHem && kk.includes('HEMBRA')) { rHem = rr; continue; }
          if (!rMach && kk.includes('MACHO')) { rMach = rr; continue; }
          if (!rHato && kk.includes('HATOREPRODUCTIVO')) { rHato = rr; continue; }
        }
        if (!rHato) rHato = rows[i - 3] || [];
        if (!rMach) rMach = rows[i - 2] || [];
        if (!rHem)  rHem  = rows[i - 1] || [];

        const kHato = normKey((rHato[0] ?? '') + '');
        const kMach = normKey((rMach[0] ?? '') + '');
        const kHem  = normKey((rHem[0] ?? '') + '');

        if (!kHato.includes('HATOREPRODUCTIVO')) continue;
        if (!kMach.includes('MACHO')) continue;
        if (!kHem.includes('HEMBRA')) continue;

        const finca = normalizeFincaName(cleanFinca(firstRaw));

        const hato = read12Nums(rHato, 1);
        const machos = read12Nums(rMach, 1);
        const hembras = read12Nums(rHem, 1);
        const pcts = read12Pct(r, 1);

        for (let m = 0; m < 12; m++) {
          const h = hato[m] || 0;
          const ma = machos[m] || 0;
          const he = hembras[m] || 0;
          const tot = ma + he;

          const tasaPct = (pcts[m] != null) ? pcts[m] : (h > 0 ? (tot / h) * 100 : 0);

          out.push({
            finca,
            anio: yearMain,
            mes: monthCols[m],
            hato: h,
            machos: ma,
            hembras: he,
            total: tot,
            tasaPct
          });
        }
      }

      window.APP_DATA.nacimientos_finca = out;
    }


function processMuertes(rows) {
      const out = [];
      const compact = (s) => stripAccents(s || '').toUpperCase().replace(/[^A-Z0-9]/g, '');
      // Encontrar la fila de encabezados (FINCA ... MUERTES).
      let headerIdx = -1;
      for (let i = 0; i < Math.min(60, rows.length); i++) {
        const rowText = (rows[i] || []).join(' ');
        const t = compact(rowText);
        if (t.includes('FINCA') && (t.includes('MUERT') || t.includes('MUERTE'))) {
          headerIdx = i;
          break;
        }
      }
      if (headerIdx < 0) headerIdx = 0;


      // Detectar años desde el encabezado (normalmente aparecen 2: 2025 y 2026)
// Nota: algunos reportes mencionan primero 2026 en líneas como "MES ENERO 2026", lo que invertía los años.
// Aquí los detectamos en orden y, si vienen invertidos, los corregimos.
      const yearsFound = [];
      const pushYear = (y) => { if (y && !yearsFound.includes(y)) yearsFound.push(y); };

      for (let i = 0; i < Math.min(40, rows.length); i++) {
        const line = (rows[i] || []).join(' ');
        const matches = (line || '').toString().match(/\b20\d{2}\b/g) || [];
        matches.forEach(m => pushYear(parseInt(m, 10)));
        if (yearsFound.length >= 2) break;
      }

      let y1 = null;
      let y2 = null;

      if (yearsFound.length >= 2) {
        y1 = yearsFound[0];
        y2 = yearsFound[1];
        if (y1 > y2) { const tmp = y1; y1 = y2; y2 = tmp; } // evitar inversión
      } else if (yearsFound.length === 1) {
        y2 = yearsFound[0];
        y1 = y2 - 1;
      } else {
        y2 = new Date().getFullYear();
        y1 = y2 - 1;
      }

      // Layout típico:
      // 0 FINCA | 1 Masa | 2 Crías Macho | 3 Crías Hembra | 4 Adultos | 5 Muertes | 6 % | 7 (sep) | 8 Masa | 9 Crías Macho | 10 Crías Hembra | 11 Adultos | 12 Muertes | 13 % | 14 Variación
      const dataRows = rows.slice(headerIdx + 2);
      dataRows.forEach((r) => {
        const finca = (r[0] || '').toString().trim();
        if (!finca) return;

        const fkey = compact(finca);
        if (fkey.includes('TOTAL')) return;

        const recA = {
          finca,
          anio: y1,
          masa_ganadera: toNumber(r[1]),
          crias_machos: toNumber(r[2]),
          crias_hembras: toNumber(r[3]),
          adultos: toNumber(r[4]),
          muertes: toNumber(r[5]),
          porcentaje: toNumber((r[6] || '').toString()),
        };

        const recB = {
          finca,
          anio: y2,
          masa_ganadera: toNumber(r[8]),
          crias_machos: toNumber(r[9]),
          crias_hembras: toNumber(r[10]),
          adultos: toNumber(r[11]),
          muertes: toNumber(r[12]),
          porcentaje: toNumber((r[13] || '').toString()),
        };

        out.push(recA, recB);
      });

      window.APP_DATA.muertes = out;
    }
    function processMuertesMes(rows) {
      const out = [];
      let headerIdx = -1;

      // detectar año desde la frase "A Ñ O - 2 0 2 5"
      const head = rows.slice(0, 15).map(r => (r||[]).join(' ')).join(' ');
      const yearMain = parseYearFromText(head) || 2025;

      // header donde col0 es "F  I  N  C  A"
      for (let i = 0; i < Math.min(rows.length, 30); i++) {
        const first = (rows[i]?.[0] ?? '').toString();
        if (normKey(first).startsWith('FINCA') && (rows[i]?.[14] ?? '').toString().toUpperCase().includes('CAUSAS')) { headerIdx = i; break; }
        // en algunos archivos, la cabecera tiene "F  I  N  C  A" sin "CAUSAS" exacto en col14 por col extra
        if (normKey(first).startsWith('FINCA') && (rows[i] || []).join(' ').toUpperCase().includes('CAUSAS')) { headerIdx = i; break; }
      }
      if (headerIdx < 0) return;

      const monthCols = MONTHS_ABBR.map(m => normalizeMonthToFull(m));
      const seen = new Set();

      for (let i = headerIdx + 1; i < rows.length; i++) {
        const r = rows[i];
        if (!r || r.length < 14) continue;

        let nameRaw = (r[0] ?? '').toString().replace(/\ufeff/g,'').trim();
        if (!nameRaw) continue;

        const key = normKey(nameRaw);

        if (key.includes('DIFERENCIA')) continue;

        let anio = yearMain;
        let finca = normalizeFincaName(nameRaw);

        if (key.includes('TOTALGENERAL2024') || (key.includes('TOTALGENERAL') && key.includes('2024'))) {
          anio = 2024;
          finca = 'TOTAL GENERAL';
        } else if (key.includes('TOTALGENERAL')) {
          finca = 'TOTAL GENERAL';
        }

        // causas (solo para fincas reales y año principal)
        let causas = '';
        if (anio === yearMain && finca !== 'TOTAL GENERAL') {
          // la columna de causas suele ser 14, pero puede variar si hay columnas vacías al final
          const joined = r.join(';');
          // intentamos tomar el campo que esté más al final y que tenga texto
          const candidates = r.slice(14).filter(x => (x ?? '').toString().trim() !== '');
          causas = (candidates[0] ?? r[14] ?? '').toString().trim();
        }

        for (let m = 0; m < 12; m++) {
          const val = toNumber(r[1+m]);
          const mes = monthCols[m];
          const sig = `${finca}|${anio}|${mes}|${val}`;
          if (seen.has(sig)) continue;
          seen.add(sig);

          out.push({ finca, anio, mes, muertes: val, causas });
        }
      }

      window.APP_DATA.muertes_mes = out;
    }

    function processMuertesFincas(rows) {
      const out = [];
      let headerIdx = -1;

      const head = rows.slice(0, 15).map(r => (r||[]).join(' ')).join(' ');
      const yearMain = parseYearFromText(head) || 2025;

      for (let i = 0; i < Math.min(rows.length, 40); i++) {
        if ((rows[i]?.[1] ?? '').toString().trim().toUpperCase().startsWith('ENERO')) { headerIdx = i; break; }
      }
      if (headerIdx < 0) return;

      const monthCols = MONTHS_ABBR.map(m => normalizeMonthToFull(m));

      const isKnown = (name) => {
        const k = normKey(name);
        return KNOWN_FINCAS.some(a => k.includes(a.key) && !['ESTELI','ESTELÍ','GENERAL'].includes(a.key));
      };

      for (let i = headerIdx + 1; i < rows.length - 3; i++) {
        const label = (rows[i]?.[0] ?? '').toString().replace(/\ufeff/g,'').trim();
        if (!label) continue;

        if (normKey(label).includes('TOTALDEMASAGANADERA')) {
          const masa = monthCols.map((_, idx) => toNumber(rows[i][1+idx]));
          const menor = monthCols.map((_, idx) => toNumber(rows[i+1][1+idx]));
          const adulto = monthCols.map((_, idx) => toNumber(rows[i+2][1+idx]));
          const fincaLabel = (rows[i+3]?.[0] ?? '').toString().replace(/\ufeff/g,'').trim();

          if (!isKnown(fincaLabel)) break;

          const finca = normalizeFincaName(fincaLabel);

          for (let m = 0; m < 12; m++) {
            out.push({
              finca,
              anio: yearMain,
              mes: monthCols[m],
              masa: masa[m],
              muertes_menor: menor[m],
              muertes_adulto: adulto[m],
              muertes_total: (menor[m] + adulto[m])
            });
          }

          i += 3;
        }
      }

      window.APP_DATA.muertes_fincas = out;
    }

    // =========================
    // Filters
    // =========================
    function populateFilters() {
      const mod = window.CURRENT_MODULE;
      const cfg = MODULES[mod] || {};
      const data = window.APP_DATA[mod];
      if (!data || data.length === 0) return;


      // --- Month filter (dinámico) ---
      if (monthFilterWrap && monthFilter) {
        // Reset + ocultar por defecto (se habilita solo si el módulo tiene campo "mes")
        monthFilterWrap.classList.add('hidden');
        monthFilter.innerHTML = '<option value="all">Todos</option>';
        monthFilter.value = 'all';

        const hasMes = data.some(d => d && typeof d.mes !== 'undefined' && (d.mes ?? '').toString().trim() !== '');
        if (hasMes) {
          const months = uniq(data.map(d => normalizeMonthToFull(d.mes)).filter(Boolean));
          months.sort((a,b) => monthIndex(a) - monthIndex(b));
          if (months.length) {
            monthFilterWrap.classList.remove('hidden');
            months.forEach(m => { monthFilter.innerHTML += `<option value="${m}">${m}</option>`; });
          }
        }
      }


      // Finca filter
      if (cfg.showFinca !== false) {
        const fincas = uniq(data.map(d => d.finca))
          .filter(f => f && f !== 'Desconocida')
          .filter(f => {
            const k = normKey(f);
            return k !== 'GENERAL' && k !== 'TOTALGENERAL' && k !== 'FINCA' && !(mod === 'hato_reproductivo' && k === 'ESTELI');
          })
          .sort();
        fincaFilter.innerHTML = '<option value="all">Todas</option>';
        fincas.forEach(f => { fincaFilter.innerHTML += `<option value="${f}">${f}</option>`; });
      } else {
        fincaFilter.value = 'all';
      }

      // Year filters
      if (cfg.showYear !== false) {
        const years = uniq(data.map(d => parseInt(d.anio))).filter(y => !isNaN(y)).sort((a,b) => a-b);
        if (years.length > 0) {
          [yearStartFilter, yearEndFilter].forEach(sel => {
            sel.innerHTML = '';
            years.forEach(y => sel.innerHTML += `<option value="${y}">${y}</option>`);
          });
          yearStartFilter.value = years[0];
          yearEndFilter.value = years[years.length - 1];
        } else {
          yearStartFilter.innerHTML = `<option value="0">0</option>`;
          yearEndFilter.innerHTML = `<option value="9999">9999</option>`;
        }
      }
    }

    

    // =========================
    // Procesadores adicionales (6 módulos)
    // =========================
    function processLluvias(rows) {
      const processed = [];
      let currentFinca = 'General';

      rows.forEach(row => {
        const col0 = (row?.[0] ?? '').toString().replace(/\ufeff/g, '').trim();
        if (!col0) return;

        const u = stripAccents(col0).toUpperCase();

        // saltar headers y subtotales
        if (u === 'AÑO' || u === 'DIAS' || u.includes('PLASENCIA') || u.startsWith('SUB')) return;

        // finca header (no numérico)
        if (!/^\d{4}$/.test(col0)) {
          if (u.includes('FINCA')) currentFinca = normalizeFincaName(col0);
          else currentFinca = normalizeFincaName(col0);
          return;
        }

        const meses = [];
        for (let i = 3; i <= 14; i++) meses.push(toNumberNullable(row[i]));

        processed.push({
          finca: normalizeFincaName(currentFinca),
          anio: parseInt(col0),
          acumulado: toNumber(row[15]),
          s1: toNumber(row[16]),
          s2: toNumber(row[17]),
          meses
        });
      });

      window.APP_DATA.lluvias = processed;
    }

    function processPesajes(rows) {
      const data = [];
      const fincasMapeo = [
        { idx: 2, name: 'El Castillo' },
        { idx: 4, name: 'Las Cuchillas' },
        { idx: 6, name: 'Las Guayabas' },
        { idx: 8, name: 'Los Carbonales' },
        { idx: 10, name: 'Los Chaguites' },
        { idx: 12, name: 'Monte Fresco' },
        { idx: 14, name: 'El Corojal Jalapa' }
      ];

      rows.forEach((r, i) => {
        const mes = normalizeMonthToFull((r?.[0] ?? '').toString().trim());
        const anioStr = (r?.[1] ?? '').toString().trim();
        if (i < 3 || !mes || !anioStr || isNaN(parseInt(anioStr))) return;

        fincasMapeo.forEach(f => {
          const reses = parseInt(toNumber(r[f.idx]) || 0);
          const kilos = toNumber(r[f.idx + 1]) || 0;
          if (reses > 0 || kilos > 0) data.push({ mes, anio: parseInt(anioStr), finca: f.name, reses, kilos });
        });
      });

      window.APP_DATA.pesajes = data;
    }

    function processHembras(rows) {
      const data = [];
      let currentFinca = 'Desconocida';

      rows.forEach((r) => {
        const rowStr = (r || []).join(' ').toUpperCase().replace(/\ufeff/g, '');
        if (rowStr.includes('F I N C A') || rowStr.includes('FINCA')) {
          let name = rowStr.replace(/F\s*I\s*N\s*C\s*A/g, ' ').replace(/\bFINCA\b/g, ' ').trim();
          name = name.replace(/[-:;]+/g, ' ').trim();
          if (name) currentFinca = normalizeFincaName(name);
          return;
        }

        const traza = ((r?.[1] ?? r?.[0]) ?? '').toString().trim();
        if (traza && traza.length > 4 && !isNaN(parseInt(traza))) {
          data.push({
            finca: currentFinca,
            trazabilidad: traza,
            edad: toNumber(r?.[2]),
            estado: (r?.[3] ?? '').toString().trim(),
            repro: (r?.[4] ?? '').toString().trim(),
            peso: toNumber(r?.[5]),
            partos: parseInt(toNumber(r?.[6]) || 0),
            abortos: parseInt(toNumber(r?.[7]) || 0),
            diasAbiertos: parseInt(toNumber(r?.[8]) || 0)
          });
        }
      });

      window.APP_DATA.hembras = data;
    }

    
function processDestete(rows) {
  // CSV: "DESTETE DE TERNEROS"
  // Mantiene los meses aunque existan ceros (para evitar que el módulo aparezca vacío).
  const out = [];
  let started = false;

  const monthSet = new Set([
    'ENERO','FEBRERO','MARZO','ABRIL','MAYO','JUNIO','JULIO','AGOSTO','SEPTIEMBRE','SETIEMBRE','OCTUBRE','NOVIEMBRE','DICIEMBRE'
  ]);

  for (let i = 0; i < rows.length; i++) {
    const r = (rows[i] || []).map(c => String(c ?? '').trim());
    const c0 = r[0] || '';
    const c0Key = normalizeKey(c0);

    if (!started) {
      if (c0Key === 'MES') {
        started = true;
      }
      continue;
    }

    if (!c0) continue;

    // cortar al llegar a totales/promedios
    if (c0Key.includes('TOTAL KGS') || c0Key.includes('PROMEDIO') || c0Key === 'TOTAL') {
      break;
    }

    // Solo meses válidos
    const mesKey = normalizeKey(c0);
    if (!monthSet.has(mesKey)) continue;

    const mes = c0.trim();

    const machosTotal = toNumber(r[1]);
    const machosPesoNacim = toNumber(r[2]);
    const machosPesoDestete = toNumber(r[3]);
    const machosIncrem = toNumber(r[4]);

    const hembrasTotal = toNumber(r[6]);
    const hembrasPesoNacim = toNumber(r[7]);
    const hembrasPesoDestete = toNumber(r[8]);
    const hembrasIncrem = toNumber(r[9]);

    const todosTotal = toNumber(r[11]);
    const todosPesoNacim = toNumber(r[12]);
    const todosPesoDestete = toNumber(r[13]);
    const todosIncrem = toNumber(r[14]);

    out.push({
      mes,
      machosTotal, machosPesoNacim, machosPesoDestete, machosIncrem,
      hembrasTotal, hembrasPesoNacim, hembrasPesoDestete, hembrasIncrem,
      todosTotal, todosPesoNacim, todosPesoDestete, todosIncrem,
      edadProm: toNumber(r[15]),
    });
  }

  // Metadatos resumidos (para la UI)
  const meta = out.reduce((acc, d) => {
    acc.totalTerneros += (d.todosTotal || 0);
    acc.pesoDesteteSum += (d.todosPesoDestete || 0) * (d.todosTotal || 0);
    acc.pesoNacimSum += (d.todosPesoNacim || 0) * (d.todosTotal || 0);
    return acc;
  }, { totalTerneros: 0, pesoDesteteSum: 0, pesoNacimSum: 0 });

  window.APP_DATA.destete = out;
  window.APP_DATA.destete_meta = {
    totalTerneros: meta.totalTerneros,
    pesoDesteteProm: meta.totalTerneros > 0 ? (meta.pesoDesteteSum / meta.totalTerneros) : 0,
    pesoNacimProm: meta.totalTerneros > 0 ? (meta.pesoNacimSum / meta.totalTerneros) : 0,
  };
}
    function processProyeccionPartos(rows) {
      const monthOrder = MONTHS_FULL;
      const isMonth = (m) => monthOrder.includes(normalizeMonthToFull((m || '').toString().trim()));

      let year = null;
      for (let i = 0; i < Math.min(rows.length, 8); i++) {
        const str = (rows[i] || []).join(' ').replace(/\ufeff/g, '');
        const m = str.match(/(19\d{2}|20\d{2})/);
        if (m) { year = parseInt(m[1]); break; }
      }
      if (!year) year = new Date().getFullYear();

      let finca = 'General';
      rows.forEach(r => {
        const c0 = (r?.[0] ?? '').toString().replace(/\ufeff/g, '').trim();
        if (stripAccents(c0).toUpperCase().startsWith('FINCA')) {
          finca = c0.replace(/finca/ig, '').replace(/[-:]/g, ' ').trim() || 'General';
        }
      });

      const out = [];
      rows.forEach(r => {
        if (!r || r.length < 2) return;
        const mes = normalizeMonthToFull((r[0] || '').toString().replace(/\ufeff/g, '').trim());
        if (!isMonth(mes)) return;

        out.push({
          finca,
          anio: year,
          mes,
          hato: toNumber(r[1]),
          pct: toNumber(((r[2] ?? '') + '').replace('%','')),
          manual: toNumber(r[3]),
          eco: toNumber(r[4]),
          partos: toNumber(r[5]),
          vacas: toNumber(r[6]),
          novillas: toNumber(r[7])
        });
      });

      out.sort((a, b) => monthOrder.indexOf(a.mes) - monthOrder.indexOf(b.mes));
      window.APP_DATA.proyeccion_partos = out;
    }

    function processVentasGanado(rows) {
      const out = [];
      const monthOrder = MONTHS_FULL;
      const isMonth = (m) => monthOrder.includes(normalizeMonthToFull((m || '').toString().trim()));

      rows.forEach(r => {
        if (!r || r.length < 2) return;
        const mes = normalizeMonthToFull((r[0] || '').toString().replace(/\ufeff/g,'').trim());
        const anioStr = (r[1] || '').toString().trim();
        if (!isMonth(mes) || isNaN(parseInt(anioStr))) return;

        const anio = parseInt(anioStr);

        const novRes = parseInt(toNumber(r[2]) || 0);
        const novKilos = toNumber(r[3]);
        const novPrecioKg = toNumber(r[5]);
        const novImporte = toNumber(r[7]);

        const vacRes = parseInt(toNumber(r[8]) || 0);
        const vacKilos = toNumber(r[9]);
        const vacPrecioKg = toNumber(r[11]);
        const vacImporte = toNumber(r[13]);

        const totalRes = novRes + vacRes;
        const totalKilos = (novKilos || 0) + (vacKilos || 0);
        const totalImp = (novImporte || 0) + (vacImporte || 0);
        const precioPromKg = totalKilos > 0 ? (totalImp / totalKilos) : 0;

        out.push({
          finca: 'General',
          anio,
          mes,
          novillos_reses: novRes,
          novillos_kilos: novKilos || 0,
          novillos_precio_kg: novPrecioKg || 0,
          novillos_importe: novImporte || 0,
          vacas_reses: vacRes,
          vacas_kilos: vacKilos || 0,
          vacas_precio_kg: vacPrecioKg || 0,
          vacas_importe: vacImporte || 0,
          total_reses: totalRes,
          total_kilos: totalKilos,
          total_importe: totalImp,
          precio_prom_kg: precioPromKg
        });
      });

      out.sort((a, b) => (a.anio - b.anio) || (monthOrder.indexOf(a.mes) - monthOrder.indexOf(b.mes)));
      window.APP_DATA.ventas_ganado = out;
    }

    // =========================
    // Ventas (Ventas-2026.csv)
    // Formato: reporte con secciones (HEMBRAS / MACHOS / CAFÉ) y filas por FECHA
    // =========================
    function processVentas(rows) {
      const data = [];
      let tipo = 'GANADO';
      const dateRe = /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/;

      const setTipoFromRow = (r) => {
        const t = ((r && r[0]) ? r[0] : (r && r[1]) ? r[1] : '').toString().toUpperCase();
        if (t.includes('VENTAS DE HEMBRAS')) tipo = 'HEMBRAS';
        else if (t.includes('VENTAS DE MACHOS')) tipo = 'MACHOS';
        else if (t.includes('VENTAS DE CAFE') || t.includes('VENTAS DE CAFÉ')) tipo = 'CAFE';
        else if (t.includes('TOTAL GENERAL DE VENTAS')) tipo = 'TOTAL';
      };

      rows.forEach(r => {
        if (!r || r.length === 0) return;

        // Detectar cambios de sección
        const rowJoined = (r || []).join(' ').toString().toUpperCase().replace(/\ufeff/g,'');
        if (rowJoined.includes('VENTAS DE HEMBRAS') || rowJoined.includes('VENTAS DE MACHOS') || rowJoined.includes('VENTAS DE CAFE') || rowJoined.includes('VENTAS DE CAFÉ') || rowJoined.includes('TOTAL GENERAL DE VENTAS')) {
          setTipoFromRow(r);
          return;
        }

        const fechaStr = (r[0] || '').toString().replace(/\ufeff/g,'').trim();
        const m = fechaStr.match(dateRe);
        if (!m) return;

        const dd = parseInt(m[1], 10), mm = parseInt(m[2], 10), yyyy = parseInt(m[3], 10);
        if (!yyyy || isNaN(yyyy) || mm < 1 || mm > 12) return;

        const mes = MONTHS_FULL[mm - 1];

        const descripcion = (r[1] || '').toString().trim() || 'Sin descripción';
        const cantidad = toNumber(r[2]) || 0;
        const unidad = (r[3] || '').toString().trim();

        const kilos = toNumber(r[4]) || 0;          // columna TOTAL (kilos en ganado)
        const precioKg = toNumber(r[6]) || 0;       // columna PRECIO (promedio)
        const importe = toNumber(r[8]) || 0;        // IMPORTE total

        // Para café usualmente no hay kilos; usamos TOTAL como 0 y dejamos cantidad/unidad
        data.push({
          finca: 'General',
          anio: yyyy,
          mes,
          tipo,
          descripcion,
          cantidad,
          unidad,
          kilos,
          precio_kg: precioKg,
          importe
        });
      });

      window.APP_DATA.ventas = data;
    }


// =========================
    // Rendering
    // =========================
    function renderDashboard() {
      const mod = window.CURRENT_MODULE;
      const cfg = MODULES[mod] || {};
      const raw = window.APP_DATA[mod];

      // IMPORTANT: siempre limpiar primero para que no queden tarjetas/gráficos del módulo anterior
      resetView();

      // Si no hay datos del módulo, deja un estado vacío (y evita que se vean datos viejos)
      if (!raw || raw.length === 0) {
        renderNoDataState();
        animateSection();
        return;
      }

      let filtered = raw;

      if (cfg.showFinca !== false) {
        const fv = fincaFilter.value;
        filtered = fv !== 'all' ? filtered.filter(d => d.finca === fv) : filtered;
      }

      if (cfg.showYear !== false) {
        const start = parseInt(yearStartFilter.value || "0");
        const end = parseInt(yearEndFilter.value || "9999");
        filtered = filtered.filter(d => {
          const y = parseInt(d.anio);
          return isNaN(y) ? true : (y >= start && y <= end);
        });
      }

      

      
      // --- Categoría (solo Ventas) ---
      if (mod === 'ventas' && categoriaFilterWrap && !categoriaFilterWrap.classList.contains('hidden') && categoriaFilter) {
        const cv = categoriaFilter.value;
        if (cv && cv !== 'all') {
          filtered = filtered.filter(d => (d.tipo || '').toString().toUpperCase() === cv);
        }
      }

// --- Month filter (si aplica) ---
      if (monthFilterWrap && monthFilter && !monthFilterWrap.classList.contains('hidden')) {
        const mv = monthFilter.value;
        if (mv && mv !== 'all') {
          filtered = filtered.filter(d => normalizeMonthToFull(d.mes) === mv);
        }
      }
if (!filtered || filtered.length === 0) {
        const msg = '<p class="col-span-3 text-center text-slate-400">No hay datos para los filtros seleccionados.</p>';
        if (mod === 'inventario_general' || mod === 'nacimientos' || mod === 'muertes') {
          const sectionContent = document.getElementById('sectionContent');
          if (sectionContent) {
            sectionContent.classList.remove('hidden');
            sectionContent.innerHTML = msg;
          }
        } else {
          document.getElementById('kpiContainer').innerHTML = msg;
          document.getElementById('chartsContainer').innerHTML = '';
        }
        return;
      }

      // enable UI
      noDataState.classList.add('hidden');
      dashboardContent.classList.remove('opacity-50', 'pointer-events-none');
      saveBtn.classList.remove('hidden');
      document.getElementById('lastUpdate').innerText = `Actualizado: ${new Date().toLocaleString()}`;

      // Toggle contenedores según módulo (algunos módulos renderizan en #sectionContent)
      const sectionContent = document.getElementById('sectionContent');
      if (sectionContent) {
        const usesSectionContent = (mod === 'inventario_general' || mod === 'nacimientos' || mod === 'muertes');
        if (usesSectionContent) {
          sectionContent.classList.remove('hidden');
          kpiContainer.classList.add('hidden');
          chartsContainer.classList.add('hidden');
        } else {
          sectionContent.classList.add('hidden');
          sectionContent.innerHTML = '';
          kpiContainer.classList.remove('hidden');
          chartsContainer.classList.remove('hidden');
        }
      }


      // destroy old charts
      Object.values(charts).forEach(c => { try { c.destroy(); } catch(e){} });
      charts = {};

      // reset KPI grid (default 3 columnas)
      kpiContainer.className = 'grid grid-cols-1 md:grid-cols-3 gap-6';

      if (mod === 'inventario_general') renderInventarioGeneralUI(filtered, raw);
      else if (mod === 'hato_reproductivo') renderHatoReproductivoUI(filtered, raw);
      else if (mod === 'flujo_ganado_categoria') renderFlujoUI(filtered, raw);
      else if (mod === 'inventario_movimiento') renderInventarioMovimientoUI(filtered, raw);
      else if (mod === 'nacimientos') renderNacimientosUI(filtered, raw);
      else if (mod === 'nacimientos_mes') renderNacimientosMesUI(filtered, raw);
      else if (mod === 'nacimientos_finca') renderNacimientoFincaUI(filtered, raw);
      else if (mod === 'muertes') renderMuertesUI(filtered, raw);
      else if (mod === 'muertes_mes') renderMuertesMesUI(filtered, raw);
      else if (mod === 'muertes_fincas') renderMuertesFincasUI(filtered, raw);
      else if (mod === 'lluvias') renderLluviasUI(filtered, raw);
      else if (mod === 'pesajes') renderPesajesUI(filtered, raw);
      else if (mod === 'hembras') renderHembrasUI(filtered, raw);
      else if (mod === 'proyeccion_partos') renderProyeccionPartosUI(filtered, raw);
      else if (mod === 'destete') renderDesteteUI(filtered, raw, (sexoFilter ? sexoFilter.value : 'todos'));
            else if (mod === 'ventas') renderVentasUI(filtered);
else if (mod === 'ventas_ganado') renderVentasGanadoUI(filtered, raw);
      else {
        document.getElementById('kpiContainer').innerHTML = '<p class="text-slate-400">Módulo sin render.</p>';
        document.getElementById('chartsContainer').innerHTML = '';
      }

      // Animación al cambiar de sección (texto/tarjetas/gráficos)
      animateSection();
      animateChartsIn();
    }

    // -------------------------
    // UI: Inventario General
    // -------------------------
function renderInventarioGeneralUI(data, allData) {
  // data ya viene filtrada por finca/años (ver renderDashboard)
  const content = document.getElementById('sectionContent');

  if (!Array.isArray(data) || data.length === 0) {
    renderNoDataState();
    return;
  }

  const yearSet = new Set();
  const fincaSet = new Set();

  for (const d of data) {
    if (d && d.anio) yearSet.add(d.anio);
    if (d && d.finca) fincaSet.add(d.finca);
  }

  const years = Array.from(yearSet).sort((a, b) => a - b);
  const yearLabel = years.length ? `Año: ${years.join(', ')}` : '';

  // Totales: usar fila "TOTAL" si existe (para evitar doble conteo de subcategorías)
  const isTotalRow = (cat) => normalizeKey(cat || '').replace(/\s+/g, ' ').trim() === 'TOTAL';

  const totals = {
    existencia_inicial: 0,
    compras: 0,
    nacimientos: 0,
    traslado_entradas: 0,
    ventas: 0,
    muertes: 0,
    traslado_salidas: 0,
    existencia_final: 0,
  };

  const totalRows = data.filter(d => isTotalRow(d.categoria));

  if (totalRows.length) {
    for (const d of totalRows) {
      totals.existencia_inicial += (d.existencia_inicial || 0);
      totals.compras += (d.compras || 0);
      totals.nacimientos += (d.nacimientos || 0);
      totals.traslado_entradas += (d.traslado_entradas || 0);
      totals.ventas += (d.ventas || 0);
      totals.muertes += (d.muertes || 0);
      totals.traslado_salidas += (d.traslado_salidas || 0);
      totals.existencia_final += (d.existencia_final || 0);
    }
  } else {
    // Respaldo: usar solo categorías que NO sean grupos típicos
    const skipCats = new Set(['HEMBRAS', 'MACHOS', 'TOTAL']);
    for (const d of data) {
      const ck = normalizeKey(d.categoria || '');
      if (ck === 'TOTAL' || skipCats.has(ck)) continue;
      totals.existencia_inicial += (d.existencia_inicial || 0);
      totals.compras += (d.compras || 0);
      totals.nacimientos += (d.nacimientos || 0);
      totals.traslado_entradas += (d.traslado_entradas || 0);
      totals.ventas += (d.ventas || 0);
      totals.muertes += (d.muertes || 0);
      totals.traslado_salidas += (d.traslado_salidas || 0);
      totals.existencia_final += (d.existencia_final || 0);
    }
  }

  const variacion = totals.existencia_final - totals.existencia_inicial;

  const kpis = [
    { label: 'Existencia Inicial', value: totals.existencia_inicial, icon: '🐄' },
    { label: 'Existencia Final', value: totals.existencia_final, icon: '📌' },
    { label: 'Variación', value: variacion, icon: variacion >= 0 ? '📈' : '📉' },
    { label: 'Nacimientos', value: totals.nacimientos, icon: '🍼' },
    { label: 'Muertes', value: totals.muertes, icon: '⚠️' },
    { label: 'Compras', value: totals.compras, icon: '🧾' },
    { label: 'Ventas', value: totals.ventas, icon: '💰' },
    { label: 'Crecimiento Neto (%)', value: (totals.existencia_inicial ? (variacion / totals.existencia_inicial) * 100 : 0), icon: (variacion >= 0 ? '📊' : '📉'), fmt: 'pct', },
  ];

  const kpiHtml = kpis.map(k => `
    <div class="bg-white rounded-xl p-5 shadow-sm border border-slate-200/70">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-xs uppercase tracking-wide text-slate-500">${k.label}</div>
          <div class="mt-1 text-2xl font-semibold text-slate-800">${k.fmt === 'pct' ? fmtPct(k.value, 1) : fmtNum(k.value)}</div>
        </div>
        <div class="text-2xl">${k.icon}</div>
      </div>
    </div>
  `).join('');

  // Categorías para gráfico (evitar TOTAL; y evitar doble conteo excluyendo grupos)
  const skipCats = new Set(['TOTAL', 'HEMBRAS', 'MACHOS']);
  const cats = Array.from(new Set(
    data
      .map(d => String(d.categoria || '').trim())
      .filter(c => c && !skipCats.has(normalizeKey(c)))
  ));

  // Orden: por existencia final total (desc)
  const catTotalsFinal = {};
  for (const d of data) {
    const c = String(d.categoria || '').trim();
    const ck = normalizeKey(c);
    if (!c || skipCats.has(ck)) continue;
    catTotalsFinal[c] = (catTotalsFinal[c] || 0) + (d.existencia_final || 0);
  }
  cats.sort((a, b) => (catTotalsFinal[b] || 0) - (catTotalsFinal[a] || 0));

  const fincas = Array.from(fincaSet).sort();

  // Dataset por finca (zona) -> existencia final por categoría
  const palette = [
    { bg: 'rgba(59, 130, 246, 0.55)', br: 'rgba(59, 130, 246, 1)' },   // blue
    { bg: 'rgba(16, 185, 129, 0.55)', br: 'rgba(16, 185, 129, 1)' },   // emerald
    { bg: 'rgba(168, 85, 247, 0.55)', br: 'rgba(168, 85, 247, 1)' },   // purple
    { bg: 'rgba(249, 115, 22, 0.55)', br: 'rgba(249, 115, 22, 1)' },   // orange
    { bg: 'rgba(14, 165, 233, 0.55)', br: 'rgba(14, 165, 233, 1)' },   // sky
    { bg: 'rgba(244, 63, 94, 0.55)', br: 'rgba(244, 63, 94, 1)' },     // rose
  ];

  const datasetsFinal = fincas.map((f, idx) => {
    const color = palette[idx % palette.length];
    const series = cats.map(cat => {
      const row = data.find(d => (d.finca === f) && (String(d.categoria || '').trim() === cat));
      return row ? (row.existencia_final || 0) : 0;
    });
    return {
      label: f,
      data: series,
      backgroundColor: color.bg,
      borderColor: color.br,
      borderWidth: 1
    };
  });

  // Tabla (agregada por categoría, usando filas detalladas y sumando por finca)
  const rowsByCat = cats.map(cat => {
    const recs = data.filter(d => String(d.categoria || '').trim() === cat);
    const s = recs.reduce((acc, d) => {
      acc.existencia_inicial += (d.existencia_inicial || 0);
      acc.compras += (d.compras || 0);
      acc.nacimientos += (d.nacimientos || 0);
      acc.traslado_entradas += (d.traslado_entradas || 0);
      acc.ventas += (d.ventas || 0);
      acc.muertes += (d.muertes || 0);
      acc.traslado_salidas += (d.traslado_salidas || 0);
      acc.existencia_final += (d.existencia_final || 0);
      return acc;
    }, { existencia_inicial:0, compras:0, nacimientos:0, traslado_entradas:0, ventas:0, muertes:0, traslado_salidas:0, existencia_final:0 });

    return {
      categoria: cat,
      ...s,
      variacion: (s.existencia_final - s.existencia_inicial)
    };
  });

  const tableHtml = `
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="text-xs uppercase text-slate-500 border-b">
          <tr>
            <th class="py-2 px-2 text-left">Categoría</th>
            <th class="py-2 px-2 text-right">Inicial</th>
            <th class="py-2 px-2 text-right">Compras</th>
            <th class="py-2 px-2 text-right">Nac.</th>
            <th class="py-2 px-2 text-right">Trasl. Ent.</th>
            <th class="py-2 px-2 text-right">Ventas</th>
            <th class="py-2 px-2 text-right">Muertes</th>
            <th class="py-2 px-2 text-right">Trasl. Sal.</th>
            <th class="py-2 px-2 text-right">Final</th>
            <th class="py-2 px-2 text-right">Var.</th>
          </tr>
        </thead>
        <tbody class="divide-y">
          ${rowsByCat.map(r => `
            <tr class="hover:bg-slate-50">
              <td class="py-2 px-2 font-medium text-slate-800">${r.categoria}</td>
              <td class="py-2 px-2 text-right">${fmtNum(r.existencia_inicial)}</td>
              <td class="py-2 px-2 text-right">${fmtNum(r.compras)}</td>
              <td class="py-2 px-2 text-right">${fmtNum(r.nacimientos)}</td>
              <td class="py-2 px-2 text-right">${fmtNum(r.traslado_entradas)}</td>
              <td class="py-2 px-2 text-right">${fmtNum(r.ventas)}</td>
              <td class="py-2 px-2 text-right">${fmtNum(r.muertes)}</td>
              <td class="py-2 px-2 text-right">${fmtNum(r.traslado_salidas)}</td>
              <td class="py-2 px-2 text-right font-semibold">${fmtNum(r.existencia_final)}</td>
              <td class="py-2 px-2 text-right ${r.variacion >= 0 ? 'text-emerald-600' : 'text-rose-600'}">${fmtNum(r.variacion)}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;

  content.innerHTML = `
    <div class="space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
        ${kpiHtml}
      </div>

      <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
        <div class="bg-white rounded-xl p-5 shadow-sm border border-slate-200/70">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold text-slate-800">Existencia Final por Categoría</h3>
            <div class="text-xs text-slate-500">${yearLabel}</div>
          </div>
          <div class="h-[360px]">
            <canvas id="igChartFinal"></canvas>
          </div>
          <div class="mt-2 text-xs text-slate-500">
            *Las categorías se ordenan por existencia final (mayor a menor). Se excluyen TOTAL / HEMBRAS / MACHOS para evitar doble conteo.
          </div>
        </div>

        <div class="bg-white rounded-xl p-5 shadow-sm border border-slate-200/70">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold text-slate-800">Entradas vs Salidas (Totales)</h3>
            <div class="text-xs text-slate-500">${yearLabel}</div>
          </div>
          <div class="h-[360px]">
            <canvas id="igChartMov"></canvas>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl p-5 shadow-sm border border-slate-200/70">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-semibold text-slate-800">Detalle de Movimientos por Categoría</h3>
          <div class="text-xs text-slate-500">${fincas.length ? `Zonas/Fincas: ${fincas.join(', ')}` : ''}</div>
        </div>
        ${tableHtml}
      </div>
    </div>
  `;

  // Chart 1: Existencia final por categoría (por finca/zona)
  const ctx1 = document.getElementById('igChartFinal');
  if (charts.igChartFinal) charts.igChartFinal.destroy();
  charts.igChartFinal = new Chart(ctx1, {
    type: 'bar',
    data: {
      labels: cats,
      datasets: datasetsFinal
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { position: 'bottom' } },
      scales: { y: { beginAtZero: true } }
    }
  });

  // Chart 2: entradas vs salidas (totales)
  const entradas = (totals.compras || 0) + (totals.nacimientos || 0) + (totals.traslado_entradas || 0);
  const salidas = (totals.ventas || 0) + (totals.muertes || 0) + (totals.traslado_salidas || 0);

  const ctx2 = document.getElementById('igChartMov');
  if (charts.igChartMov) charts.igChartMov.destroy();
  charts.igChartMov = new Chart(ctx2, {
    type: 'bar',
    data: {
      labels: ['Entradas', 'Salidas'],
      datasets: [{
        label: 'Cantidad',
        data: [entradas, salidas],
        backgroundColor: ['rgba(16, 185, 129, 0.55)', 'rgba(244, 63, 94, 0.55)'],
        borderColor: ['rgba(16, 185, 129, 1)', 'rgba(244, 63, 94, 1)'],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: true } }
    }
  });
}
    function renderHatoReproductivoUI(data, rawAll) {
      const fv = fincaFilter.value;
      const years = uniq(data.map(d => d.anio)).sort((a,b)=>a-b);
      const yMin = years[0], yMax = years[years.length-1];

      // Evitar doble conteo en “Todas”: separar fila TOTAL GENERAL del resto de fincas
      const isTG = (f) => ['TOTALGENERAL','GENERAL'].includes(normKey(f));
      const baseAll = data.filter(d => d.categoria !== 'VARIACION');
      const baseTG = baseAll.filter(d => isTG(d.finca));
      const baseFincas = baseAll.filter(d => !isTG(d.finca));
      const base = baseAll;

      // Series del TOTAL (por mes)
      const totalSeriesFor = (anio, finca=null) => {
        const arr = Array(12).fill(0);
        const src = finca
          ? baseAll.filter(d => d.finca === finca)
          : ((fv === 'all' && baseTG.length) ? baseTG : baseFincas);

        src
          .filter(d => d.anio === anio && d.categoria === 'TOTAL')
          .forEach(d => { const idx = monthIndex(d.mes); if (idx>=0) arr[idx] += d.valor; });
        return arr;
      };

      // KPI: total último mes y share vacas paridas
      const seriesMax = (fv==='all') ? totalSeriesFor(yMax, null) : totalSeriesFor(yMax, fv);
      const lastIdx = (() => { for (let i=11;i>=0;i--) if (seriesMax[i]!==0) return i; return 11; })();
      const lastMonth = MONTHS_FULL[lastIdx];

      const totalLast = seriesMax[lastIdx] || 0;
      const prevTotalLast = (yMin && yMin!==yMax)
        ? ((fv==='all') ? totalSeriesFor(yMin, null)[lastIdx] : totalSeriesFor(yMin, fv)[lastIdx])
        : null;

      const diff = (prevTotalLast != null) ? (totalLast - prevTotalLast) : null;

      // vacas paridas share
      const vacasParidas = (() => {
        let s=0;
        base
          .filter(d => d.anio===yMax && d.mes===lastMonth && d.categoria.toUpperCase().includes('VACAS PARIDAS') && (fv==='all' ? true : d.finca===fv))
          .forEach(d => s += d.valor);
        return s;
      })();

      const shareParidas = totalLast>0 ? (vacasParidas/totalLast)*100 : 0;

      // top finca (si all)
      let topFinca = null;
      if (fv==='all') {
        const fincas = uniq(baseFincas.filter(d => d.categoria==='TOTAL' && d.anio===yMax && d.mes===lastMonth).map(d => d.finca));
        const agg = {};
        fincas.forEach(f => agg[f]=0);
        baseFincas
          .filter(d => d.categoria==='TOTAL' && d.anio===yMax && d.mes===lastMonth)
          .forEach(d => agg[d.finca] += d.valor);
        topFinca = Object.keys(agg).length ? Object.keys(agg).reduce((a,b)=>agg[a]>agg[b]?a:b) : null;
      }

      document.getElementById('kpiContainer').innerHTML = `
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">Total Hato (${lastMonth} ${yMax})</p>
          <h3 class="text-2xl font-bold text-slate-800 mt-1">${fmtNum(totalLast,0)}</h3>
          <p class="text-xs text-slate-400 mt-1">${fv==='all' ? 'Consolidado (todas las fincas)' : `Finca: ${fv}`}</p>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">Variación vs ${yMin || yMax}</p>
          <h3 class="text-2xl font-bold ${diff != null && diff >= 0 ? 'text-green-600' : 'text-rose-600'} mt-1">
            ${diff == null ? '—' : (diff >= 0 ? '+' : '') + fmtNum(diff,0)}
          </h3>
          <p class="text-xs text-slate-400 mt-1">${diff == null ? 'Comparativo no disponible' : `Corte: ${lastMonth}`}</p>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">Participación Vacas Paridas</p>
          <h3 class="text-2xl font-bold text-blue-600 mt-1">${fmtPct(shareParidas,2)}</h3>
          <p class="text-xs text-slate-400 mt-1">${fv==='all' && topFinca ? `Top finca (corte): ${topFinca}` : 'Sobre el total del corte'}</p>
        </div>
      `;

      document.getElementById('chartsContainer').innerHTML = `
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <h4 class="font-bold text-slate-700 mb-2">Evolución del Total (por Año)</h4>
          <p class="text-xs text-slate-400 mb-4">Serie basada en categoría “SUB > TOTAL”.</p>
          <div class="h-[360px]"><canvas id="hr1"></canvas></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <h4 class="font-bold text-slate-700 mb-2">Composición (${lastMonth} ${yMax})</h4>
            <p class="text-xs text-slate-400 mb-4">Vacas Paridas/Secas, Novillas, Vaquillas.</p>
            <div class="h-[360px]"><canvas id="hr2"></canvas></div>
          </div>

          <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <h4 class="font-bold text-slate-700 mb-2">${fv==='all' ? `Ranking de Fincas (${yMax})` : `Distribución por Mes (${yMax})`}</h4>
            <p class="text-xs text-slate-400 mb-4">${fv==='all' ? 'Promedio anual del total.' : 'Total mensual del año seleccionado.'}</p>
            <div class="h-[360px]"><canvas id="hr3"></canvas></div>
          </div>
        </div>
      `;

      // Chart hr1: line by year
      const datasets = years.map(y => ({
        label: `${fv==='all' ? 'Consolidado' : fv} (${y})`,
        data: totalSeriesFor(y, fv==='all'?null:fv),
        borderWidth: 2.5,
        tension: 0.3
      }));

      charts.hr1 = new Chart(document.getElementById('hr1'), {
        type: 'line',
        data: { labels: MONTHS_FULL, datasets },
        options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } } }
      });

      // Chart hr2: composition pie
      const compCats = ['Vacas Paridas','Vacas Secas','Novillas de Vientre','Vaquillas de Levante'];
      const compVals = compCats.map(cn => {
        let s=0;
        base
          .filter(d => d.anio===yMax && d.mes===lastMonth && normKey(d.categoria).includes(normKey(cn)) && (fv==='all'?true:d.finca===fv))
          .forEach(d => s += d.valor);
        return s;
      });

      charts.hr2 = new Chart(document.getElementById('hr2'), {
        type: 'doughnut',
        data: { labels: compCats, datasets: [{ data: compVals }] },
        options: { responsive:true, maintainAspectRatio:false, cutout:'65%', plugins:{ legend:{ position:'bottom' } } }
      });

      // Chart hr3
      if (fv === 'all') {
        const fincas = uniq(baseFincas.filter(d => d.categoria==='TOTAL' && d.anio===yMax).map(d => d.finca)).filter(f => normKey(f) !== 'ESTELI').sort();
                const pairs = fincas.map(f => {
          const sum = baseFincas
            .filter(d => d.finca===f && d.anio===yMax && d.categoria==='TOTAL')
            .reduce((a,b)=>a + (b.valor||0), 0);
          return { f, v: sum };
        }).sort((a,b)=>b.v-a.v);

        charts.hr3 = new Chart(document.getElementById('hr3'), {
          type: 'bar',
          data: { labels: pairs.map(p=>p.f), datasets: [{ label: 'Total (Suma)', data: pairs.map(p=>p.v), borderRadius: 8 }] },
          options: { responsive:true, maintainAspectRatio:false, indexAxis:'y', plugins:{ legend:{ display:false } } }
        });
      } else {
        charts.hr3 = new Chart(document.getElementById('hr3'), {
          type: 'bar',
          data: { labels: MONTHS_FULL, datasets: [{ label: `Total (${yMax})`, data: totalSeriesFor(yMax, fv), borderRadius: 8 }] },
          options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } } }
        });
      }
    }

    // -------------------------
    // UI: Flujo x Categoría
    // -------------------------
    function renderFlujoUI(data, rawAll) {
      // data incluye finca='General'
      const year = uniq(data.map(d=>d.anio))[0] || '';
      const detail = data.filter(d => /^\d+$/.test(d.codigo)); // líneas con número
      const totalRow = data.find(d => (d.codigo || '').toUpperCase().includes('TOTAL GENERAL')) || null;

      const totalInicial = totalRow ? totalRow.inicial : detail.reduce((a,b)=>a+b.inicial,0);
      const totalFinal = totalRow ? totalRow.final : detail.reduce((a,b)=>a+b.final,0);
      const diff = totalFinal - totalInicial;

      const totalMuertes = totalRow ? totalRow.muertes : detail.reduce((a,b)=>a+b.muertes,0);
      const totalVentas = totalRow ? totalRow.ventas : detail.reduce((a,b)=>a+b.ventas,0);

      document.getElementById('kpiContainer').innerHTML = `
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">Existencia Inicial</p>
          <h3 class="text-2xl font-bold text-slate-800 mt-1">${fmtNum(totalInicial,0)}</h3>
          <p class="text-xs text-slate-400 mt-1">Año: ${year}</p>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">Existencia Final</p>
          <h3 class="text-2xl font-bold text-slate-800 mt-1">${fmtNum(totalFinal,0)}</h3>
          <p class="text-xs text-slate-400 mt-1">Muertes: ${fmtNum(totalMuertes,0)} · Ventas: ${fmtNum(totalVentas,0)}</p>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">Variación Neta</p>
          <h3 class="text-2xl font-bold ${diff>=0 ? 'text-green-600' : 'text-rose-600'} mt-1">${diff>=0?'+':''}${fmtNum(diff,0)}</h3>
          <p class="text-xs text-slate-400 mt-1">Final - Inicial</p>
        </div>
      `;

      document.getElementById('chartsContainer').innerHTML = `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <h4 class="font-bold text-slate-700 mb-4">Existencia Final por Categoría</h4>
            <div class="h-[380px]"><canvas id="fg1"></canvas></div>
          </div>
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <h4 class="font-bold text-slate-700 mb-4">Distribución Final por Grupo</h4>
            <div class="h-[380px]"><canvas id="fg2"></canvas></div>
          </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <h4 class="font-bold text-slate-700 mb-4">Balance de Movimientos (Total)</h4>
          <div class="h-[320px]"><canvas id="fg3"></canvas></div>
        </div>
      `;

      // fg1: bar final by category (top 12)
      const cats = detail
        .filter(d => !d.categoria.toUpperCase().includes('SUB') && !d.categoria.toUpperCase().includes('TOTAL'))
        .map(d => ({ categoria: d.categoria, final: d.final }))
        .sort((a,b)=>b.final-a.final)
        .slice(0, 12);

      charts.fg1 = new Chart(document.getElementById('fg1'), {
        type: 'bar',
        data: { labels: cats.map(x=>x.categoria), datasets: [{ label:'Existencia Final', data: cats.map(x=>x.final), borderRadius: 8 }] },
        options: { responsive:true, maintainAspectRatio:false, indexAxis:'y', plugins:{ legend:{ display:false } } }
      });

      // fg2: doughnut by group (sum final)
      const byGroup = {};
      detail
        .filter(d => /^\d+$/.test(d.codigo))
        .forEach(d => { byGroup[d.grupo] = (byGroup[d.grupo] || 0) + d.final; });

      charts.fg2 = new Chart(document.getElementById('fg2'), {
        type: 'doughnut',
        data: { labels: Object.keys(byGroup), datasets: [{ data: Object.values(byGroup) }] },
        options: { responsive:true, maintainAspectRatio:false, cutout:'65%', plugins:{ legend:{ position:'bottom' } } }
      });

      // fg3: movement totals
      const totals = totalRow ? totalRow : {
        nacimientos: detail.reduce((a,b)=>a+b.nacimientos,0),
        compras: detail.reduce((a,b)=>a+b.compras,0),
        muertes: detail.reduce((a,b)=>a+b.muertes,0),
        ventas: detail.reduce((a,b)=>a+b.ventas,0),
        transf_entrada: detail.reduce((a,b)=>a+b.transf_entrada,0),
        transf_salida: detail.reduce((a,b)=>a+b.transf_salida,0),
      };
      const labels = ['Nacimientos','Compras','Transf. Entrada','Muertes','Ventas','Transf. Salida'];
      const vals = [totals.nacimientos, totals.compras, totals.transf_entrada, -totals.muertes, -totals.ventas, -totals.transf_salida];

      charts.fg3 = new Chart(document.getElementById('fg3'), {
        type: 'bar',
        data: { labels, datasets: [{ label:'Impacto (positivo/negativo)', data: vals, borderRadius: 8 }] },
        options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } } }
      });
    }

    // -------------------------
    // UI: Inventario Movimiento
    // -------------------------
    function renderInventarioMovimientoUI(data, rawAll) {
      const fv = fincaFilter.value;
      const year = uniq(data.map(d=>d.anio))[0] || '';

      const totalByType = {};
      data
        .filter(d => d.categoria === 'Existencia Final')
        .forEach(d => { totalByType[d.tipo] = (totalByType[d.tipo] || 0) + d.valor; });

      const ini = totalByType['Inventario Inicial'] || 0;
      const fin = totalByType['Inventario Final'] || 0;
      const nac = totalByType['Nacimiento'] || 0;
      const mue = totalByType['Muertes'] || 0;
      const diff = fin - ini;

      document.getElementById('kpiContainer').innerHTML = `
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">Inventario Inicial</p>
          <h3 class="text-2xl font-bold text-slate-800 mt-1">${fmtNum(ini,0)}</h3>
          <p class="text-xs text-slate-400 mt-1">Año: ${year}</p>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">Inventario Final</p>
          <h3 class="text-2xl font-bold text-slate-800 mt-1">${fmtNum(fin,0)}</h3>
          <p class="text-xs text-slate-400 mt-1">Variación: <span class="${diff>=0?'text-green-600':'text-rose-600'} font-semibold">${diff>=0?'+':''}${fmtNum(diff,0)}</span></p>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">Nacimientos / Muertes</p>
          <h3 class="text-2xl font-bold text-blue-600 mt-1">${fmtNum(nac,0)} / ${fmtNum(mue,0)}</h3>
          <p class="text-xs text-slate-400 mt-1">${fv==='all' ? 'Consolidado (todas las fincas)' : `Finca: ${fv}`}</p>
        </div>
      `;

      document.getElementById('chartsContainer').innerHTML = `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <h4 class="font-bold text-slate-700 mb-4">Balance de Movimientos (Total)</h4>
            <div class="h-[360px]"><canvas id="im1"></canvas></div>
          </div>
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <h4 class="font-bold text-slate-700 mb-4">Composición Inventario Final</h4>
            <div class="h-[360px]"><canvas id="im2"></canvas></div>
          </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <h4 class="font-bold text-slate-700 mb-4">${fv==='all' ? 'Inventario Final por Finca' : 'Movimientos por Categoría'}</h4>
          <div class="h-[380px]"><canvas id="im3"></canvas></div>
        </div>
      `;

      // im1 movements
      const labels = ['Compras','Nacimiento','Entradas','Ventas','Muertes','Salidas'];
      const values = [
        (totalByType['Compras']||0),
        (totalByType['Nacimiento']||0),
        (totalByType['Entradas']||0),
        -(totalByType['Ventas']||0),
        -(totalByType['Muertes']||0),
        -(totalByType['Salidas']||0)
      ];
      charts.im1 = new Chart(document.getElementById('im1'), {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Impacto (+/-)', data: values, borderRadius: 8 }] },
        options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } } }
      });

      // im2 composition of final by category (exclude Existencia Final)
      const comp = {};
      data
        .filter(d => d.tipo === 'Inventario Final' && d.categoria !== 'Existencia Final')
        .forEach(d => { comp[d.categoria] = (comp[d.categoria] || 0) + d.valor; });

      const compLabels = Object.keys(comp);
      const compValues = Object.values(comp);
      const compColors = genDistinctColors(compLabels.length, 0.85);

      charts.im2 = new Chart(document.getElementById('im2'), {
        type: 'doughnut',
        data: { labels: compLabels, datasets: [{ data: compValues, backgroundColor: compColors }] },
        options: { responsive:true, maintainAspectRatio:false, cutout:'65%', plugins:{ legend:{ position:'bottom' } } }
      });

      // im3: if all fincas -> bar final by finca, else bar by type totals
      if (fv === 'all') {
        const byFinca = {};
        rawAll
          .filter(d => d.categoria==='Existencia Final' && d.tipo==='Inventario Final')
          .forEach(d => { byFinca[d.finca] = (byFinca[d.finca] || 0) + d.valor; });

        const items = Object.entries(byFinca).sort((a,b)=>b[1]-a[1]);
        charts.im3 = new Chart(document.getElementById('im3'), {
          type: 'bar',
          data: { labels: items.map(x=>x[0]), datasets: [{ label:'Inventario Final', data: items.map(x=>x[1]), borderRadius: 8 }] },
          options: { responsive:true, maintainAspectRatio:false, indexAxis:'y', plugins:{ legend:{ display:false } } }
        });
      } else {
        const byCat = {};
        data
          .filter(d => d.tipo !== 'Inventario Final' && d.categoria !== 'Existencia Final')
          .forEach(d => { byCat[d.categoria] = (byCat[d.categoria] || 0) + d.valor; });

        const items = Object.entries(byCat).sort((a,b)=>b[1]-a[1]).slice(0, 12);
        charts.im3 = new Chart(document.getElementById('im3'), {
          type: 'bar',
          data: { labels: items.map(x=>x[0]), datasets: [{ label:'Movimientos (suma)', data: items.map(x=>x[1]), borderRadius: 8 }] },
          options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } } }
        });
      }
    }

    // -------------------------
    // UI: Nacimientos Histórico
    // -------------------------
function renderNacimientosUI(data, allData) {
  const content = document.getElementById('sectionContent');

  if (!Array.isArray(data) || data.length === 0) {
    renderNoDataState();
    return;
  }

  // Agrupar por finca y año (sumando nacimientos, machos, hembras)
  const fincasSet = new Set();
  const yearsSet = new Set();
  const agg = {}; // agg[finca][anio] = {...}

  for (const d of data) {
    if (!d) continue;
    const finca = String(d.finca || '').trim();
    const anio = Number(d.anio);
    if (!finca || !Number.isFinite(anio)) continue;

    fincasSet.add(finca);
    yearsSet.add(anio);

    if (!agg[finca]) agg[finca] = {};
    if (!agg[finca][anio]) agg[finca][anio] = { hato_ganadero: 0, machos: 0, hembras: 0, nacimientos: 0, porcentaje: 0, _pctN: 0 };

    const slot = agg[finca][anio];
    slot.hato_ganadero = Math.max(slot.hato_ganadero, d.hato_ganadero || 0);
    slot.machos += (d.machos || 0);
    slot.hembras += (d.hembras || 0);
    slot.nacimientos += (d.nacimientos || 0);

    // porcentaje: promediar ponderado por nacimientos (si existe)
    const pct = (d.porcentaje || 0);
    if ((d.nacimientos || 0) > 0) {
      slot._pctN += pct * (d.nacimientos || 0);
    }
  }

  // Finalizar porcentaje ponderado
  for (const finca of Object.keys(agg)) {
    for (const anio of Object.keys(agg[finca])) {
      const slot = agg[finca][anio];
      slot.porcentaje = slot.nacimientos > 0 ? (slot._pctN / slot.nacimientos) : 0;
      delete slot._pctN;
    }
  }

  const fincas = Array.from(fincasSet).filter(f => normalizeKey(f) !== 'TOTAL' && normalizeKey(f) !== 'FINCA').sort();
  const years = Array.from(yearsSet).sort((a, b) => a - b);

  // Totales por año (excluyendo TOTAL)
  const totalsByYear = {};
  for (const y of years) totalsByYear[y] = { nacimientos: 0, machos: 0, hembras: 0, hato_ganadero: 0 };

  for (const f of fincas) {
    for (const y of years) {
      const slot = (agg[f] && agg[f][y]) ? agg[f][y] : null;
      if (!slot) continue;
      totalsByYear[y].nacimientos += slot.nacimientos;
      totalsByYear[y].machos += slot.machos;
      totalsByYear[y].hembras += slot.hembras;
      totalsByYear[y].hato_ganadero += slot.hato_ganadero;
    }
  }

  const latestYear = years.length ? years[years.length - 1] : null;
  const prevYear = years.length >= 2 ? years[years.length - 2] : null;

  const latestTotal = latestYear ? (totalsByYear[latestYear].nacimientos || 0) : 0;
  const prevTotal = prevYear ? (totalsByYear[prevYear].nacimientos || 0) : 0;
  const delta = (latestYear && prevYear) ? (latestTotal - prevTotal) : 0;
  const pctDelta = (latestYear && prevYear && prevTotal !== 0) ? (delta / prevTotal) : 0;

  const kpis = (latestYear && prevYear) ? ([
    { label: `Total Nacimientos ${latestYear}`, value: latestTotal, icon: '🍼' },
    { label: `Total Nacimientos ${prevYear}`, value: prevTotal, icon: '📦' },
    { label: 'Variación', value: delta, icon: delta >= 0 ? '📈' : '📉' },
    { label: '% Variación', value: pctDelta, icon: '🧮', isPct: true },
  ]) : ([
    { label: `Total Nacimientos ${latestYear || ''}`.trim(), value: latestTotal, icon: '🍼' },
    { label: 'Machos', value: latestYear ? (totalsByYear[latestYear].machos || 0) : 0, icon: '♂️' },
    { label: 'Hembras', value: latestYear ? (totalsByYear[latestYear].hembras || 0) : 0, icon: '♀️' },
    { label: 'Hato Ganadero', value: latestYear ? (totalsByYear[latestYear].hato_ganadero || 0) : 0, icon: '🐄' },
  ]);

  const kpiHtml = kpis.map(k => `
    <div class="bg-white rounded-xl p-5 shadow-sm border border-slate-200/70">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-xs uppercase tracking-wide text-slate-500">${k.label}</div>
          <div class="mt-1 text-2xl font-semibold text-slate-800">${k.isPct ? fmtPct(k.value) : fmtNum(k.value)}</div>
        </div>
        <div class="text-2xl">${k.icon}</div>
      </div>
    </div>
  `).join('');

  // Chart: nacimientos por finca (comparativo por año)
  const palette = [
    { bg: 'rgba(59, 130, 246, 0.55)', br: 'rgba(59, 130, 246, 1)' },
    { bg: 'rgba(16, 185, 129, 0.55)', br: 'rgba(16, 185, 129, 1)' },
    { bg: 'rgba(168, 85, 247, 0.55)', br: 'rgba(168, 85, 247, 1)' },
    { bg: 'rgba(249, 115, 22, 0.55)', br: 'rgba(249, 115, 22, 1)' },
    { bg: 'rgba(244, 63, 94, 0.55)', br: 'rgba(244, 63, 94, 1)' },
  ];

  const datasets = years.map((y, idx) => {
    const color = palette[idx % palette.length];
    return {
      label: String(y),
      data: fincas.map(f => (agg[f] && agg[f][y]) ? (agg[f][y].nacimientos || 0) : 0),
      backgroundColor: color.bg,
      borderColor: color.br,
      borderWidth: 1
    };
  });

  // Tabla
  const headerCols = years.map(y => `<th class="py-2 px-2 text-right">Nac. ${y}</th>`).join('');
  const headerHatoCols = years.map(y => `<th class="py-2 px-2 text-right">Hato ${y}</th>`).join('');

  const tableRows = fincas.map(f => {
    const colsHato = years.map(y => `<td class="py-2 px-2 text-right">${fmtNum((agg[f] && agg[f][y]) ? (agg[f][y].hato_ganadero || 0) : 0)}</td>`).join('');
    const colsNac = years.map(y => `<td class="py-2 px-2 text-right font-medium">${fmtNum((agg[f] && agg[f][y]) ? (agg[f][y].nacimientos || 0) : 0)}</td>`).join('');

    // Variación si hay 2+ años
    let varHtml = '';
    if (years.length >= 2) {
      const y1 = years[years.length - 2];
      const y2 = years[years.length - 1];
      const v1 = (agg[f] && agg[f][y1]) ? (agg[f][y1].nacimientos || 0) : 0;
      const v2 = (agg[f] && agg[f][y2]) ? (agg[f][y2].nacimientos || 0) : 0;
      const dlt = v2 - v1;
      const pct = v1 !== 0 ? (dlt / v1) : 0;
      varHtml = `
        <td class="py-2 px-2 text-right ${dlt >= 0 ? 'text-emerald-600' : 'text-rose-600'}">${fmtNum(dlt)}</td>
        <td class="py-2 px-2 text-right text-slate-700">${fmtPct(pct)}</td>
      `;
    }

    return `
      <tr class="hover:bg-slate-50">
        <td class="py-2 px-2 font-medium text-slate-800">${f}</td>
        ${colsHato}
        ${colsNac}
        ${varHtml}
      </tr>
    `;
  }).join('');

  const footerVarHeader = (years.length >= 2) ? `<th class="py-2 px-2 text-right">Var.</th><th class="py-2 px-2 text-right">%Var.</th>` : '';
  const footerVarCols = (years.length >= 2) ? (() => {
    const y1 = years[years.length - 2];
    const y2 = years[years.length - 1];
    const v1 = totalsByYear[y1].nacimientos || 0;
    const v2 = totalsByYear[y2].nacimientos || 0;
    const dlt = v2 - v1;
    const pct = v1 !== 0 ? (dlt / v1) : 0;
    return `<td class="py-2 px-2 text-right font-semibold ${dlt >= 0 ? 'text-emerald-600' : 'text-rose-600'}">${fmtNum(dlt)}</td><td class="py-2 px-2 text-right font-semibold">${fmtPct(pct)}</td>`;
  })() : '';

  const footerHato = years.map(y => `<td class="py-2 px-2 text-right font-semibold">${fmtNum(totalsByYear[y].hato_ganadero || 0)}</td>`).join('');
  const footerNac = years.map(y => `<td class="py-2 px-2 text-right font-semibold">${fmtNum(totalsByYear[y].nacimientos || 0)}</td>`).join('');

  const tableHtml = `
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="text-xs uppercase text-slate-500 border-b">
          <tr>
            <th class="py-2 px-2 text-left">Finca</th>
            ${headerHatoCols}
            ${headerCols}
            ${footerVarHeader}
          </tr>
        </thead>
        <tbody class="divide-y">
          ${tableRows}
        </tbody>
        <tfoot class="border-t bg-slate-50">
          <tr>
            <td class="py-2 px-2 font-semibold text-slate-800">TOTAL</td>
            ${footerHato}
            ${footerNac}
            ${footerVarCols}
          </tr>
        </tfoot>
      </table>
    </div>
  `;

  content.innerHTML = `
    <div class="space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
        ${kpiHtml}
      </div>

      <div class="bg-white rounded-xl p-5 shadow-sm border border-slate-200/70">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-semibold text-slate-800">Nacimientos por Finca (Comparativo)</h3>
          <div class="text-xs text-slate-500">${years.length ? `Años: ${years.join(' vs ')}` : ''}</div>
        </div>
        <div class="h-[380px]">
          <canvas id="nacChart"></canvas>
        </div>
      </div>

      <div class="bg-white rounded-xl p-5 shadow-sm border border-slate-200/70">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-semibold text-slate-800">Detalle por Finca</h3>
          <div class="text-xs text-slate-500">${(data[0] && data[0].mes) ? `Mes: ${data[0].mes}` : ''}</div>
        </div>
        ${tableHtml}
      </div>
    </div>
  `;

  const ctx = document.getElementById('nacChart');
  if (charts.nacChart) charts.nacChart.destroy();
  charts.nacChart = new Chart(ctx, {
    type: 'bar',
    data: { labels: fincas, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { position: 'bottom' } },
      scales: { y: { beginAtZero: true } }
    }
  });
}
    function renderNacimientosMesUI(data, rawAll) {
      const fv = fincaFilter.value;

      const yearMain = Math.max(...uniq(data.map(d=>d.anio)));
      const yearAlt = data.some(d=>d.anio===2024) ? 2024 : null;

      // KPI: total main (evita doble conteo si existe fila TOTAL GENERAL)
      const hasTG = data.some(d => normKey(d.finca) === 'TOTALGENERAL');
      const kpiBase = (fv === 'all' && hasTG) ? data.filter(d => normKey(d.finca) === 'TOTALGENERAL') : data;
      const totalMain = kpiBase.filter(d=>d.anio===yearMain).reduce((a,b)=>a + (b.nacimientos||0),0);
      const totalAlt = yearAlt ? kpiBase.filter(d=>d.anio===yearAlt).reduce((a,b)=>a + (b.nacimientos||0),0) : null;
      const diff = (totalAlt!=null) ? (totalMain-totalAlt) : null;

      // Mes pico (año principal) usando la misma base del KPI (evita doble conteo con TOTAL GENERAL)
      const byM = Array(12).fill(0);
      kpiBase.filter(d=>d.anio===yearMain).forEach(d=>{
        const idx = monthIndex(d.mes);
        if (idx>=0) byM[idx]+= (d.nacimientos||0);
      });
      const maxVal = Math.max(...byM);
      const peakIdxs = (maxVal>0) ? byM.map((v,i)=>v===maxVal?i:null).filter(v=>v!==null) : [];
      const peakLabel = peakIdxs.length ? humanJoin(peakIdxs.map(i=>MONTHS_FULL[i]), 'y') : 'N/A';

// top finca (año main)
      const byF = {};
      data.filter(d=>d.anio===yearMain && d.finca!=='TOTAL GENERAL').forEach(d=>{ byF[d.finca]=(byF[d.finca]||0)+d.nacimientos; });
      const topF = Object.keys(byF).length ? Object.keys(byF).reduce((a,b)=>byF[a]>byF[b]?a:b) : 'N/A';

      kpiContainer.className = 'grid grid-cols-1 md:grid-cols-4 gap-6';

      document.getElementById('kpiContainer').innerHTML = `
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">Total Nacimientos (${yearMain})</p>
          <h3 class="text-2xl font-bold text-slate-800 mt-1">${fmtNum(totalMain,0)}</h3>
          <p class="text-xs text-slate-400 mt-1">${fv==='all'?'Todas las fincas':`Finca: ${fv}`}</p>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">Comparativo</p>
          <h3 class="text-2xl font-bold ${diff!=null && diff>=0 ? 'text-green-600':'text-rose-600'} mt-1">${diff==null?'—':(diff>=0?'+':'')+fmtNum(diff,0)}</h3>
          <p class="text-xs text-slate-400 mt-1">${diff==null?'No hay total 2024 en el archivo':`${yearMain} vs 2024`}</p>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">Top Finca (${yearMain})</p>
          <h3 class="text-2xl font-bold text-blue-600 mt-1">${topF}</h3>
          <p class="text-xs text-slate-400 mt-1">${topF!=='N/A'?`${fmtNum(byF[topF]||0,0)} nac.`:''}</p>
        </div>
      
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">Mes Pico (${yearMain})</p>
          <h3 class="text-2xl font-bold text-slate-800 mt-1">${peakLabel}</h3>
          <p class="text-xs text-slate-400 mt-1">${fmtNum(maxVal,0)} nac.</p>
        </div>
      `;

      document.getElementById('chartsContainer').innerHTML = `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <h4 class="font-bold text-slate-700 mb-4">Total Mensual (Comparativo)</h4>
            <div class="h-[360px]"><canvas id="nm1"></canvas></div>
          </div>
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <h4 class="font-bold text-slate-700 mb-4">Nacimientos por Finca (${yearMain})</h4>
            <div class="h-[360px]"><canvas id="nm2"></canvas></div>
          </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <h4 class="font-bold text-slate-700 mb-4">Mapa Mensual (Finca seleccionada)</h4>
          <div class="h-[320px]"><canvas id="nm3"></canvas></div>
        </div>
      `;

      // nm1: total general series (si existe)
      const totalSeries = (anio) => {
        const arr = Array(12).fill(0);
        data.filter(d=>d.anio===anio && d.finca==='TOTAL GENERAL').forEach(d=>{
          const idx = monthIndex(d.mes);
          if (idx>=0) arr[idx]=d.nacimientos;
        });
        return arr;
      };

      const ds = [{ label:`Total ${yearMain}`, data: totalSeries(yearMain), borderWidth:2.5, tension:0.3 }];
      if (yearAlt) ds.push({ label:`Total ${yearAlt}`, data: totalSeries(yearAlt), borderWidth:2.5, tension:0.3 });

      charts.nm1 = new Chart(document.getElementById('nm1'), {
        type:'line',
        data:{ labels: MONTHS_FULL, datasets: ds },
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } } }
      });

      // nm2: births by finca
      const items = Object.entries(byF).sort((a,b)=>b[1]-a[1]);
      charts.nm2 = new Chart(document.getElementById('nm2'), {
        type:'bar',
        data:{ labels: items.map(x=>x[0]), datasets:[{ label:'Nacimientos', data: items.map(x=>x[1]), borderRadius: 8 }] },
        options:{ responsive:true, maintainAspectRatio:false, indexAxis:'y', plugins:{ legend:{ display:false } } }
      });

      // nm3: finca selected (or total)
      const fincaSel = (fv==='all') ? 'TOTAL GENERAL' : fv;
      const arr = Array(12).fill(0);
      data.filter(d=>d.anio===yearMain && d.finca===fincaSel).forEach(d=>{
        const idx=monthIndex(d.mes);
        if (idx>=0) arr[idx]=d.nacimientos;
      });

      charts.nm3 = new Chart(document.getElementById('nm3'), {
        type:'bar',
        data:{ labels: MONTHS_FULL, datasets:[{ label:`${fincaSel} (${yearMain})`, data: arr, borderRadius: 8 }] },
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } } }
      });
    }

    // -------------------------
    // UI: Nacimiento x Finca
    // -------------------------
    function renderNacimientoFincaUI(data, rawAll) {
      const fv = fincaFilter.value;
      const year = uniq(data.map(d=>d.anio))[0] || '';

      // KPIs
      const total = data.reduce((a,b)=>a + (b.total||0), 0);
      const totalMachos = data.reduce((a,b)=>a + (b.machos||0), 0);
      const totalHembras = data.reduce((a,b)=>a + (b.hembras||0), 0);
      const totalHato = data.reduce((a,b)=>a + (b.hato||0), 0);
      const tasa = totalHato>0 ? (total/totalHato)*100 : 0;
      const ratioM = total>0 ? (totalMachos/total)*100 : 0;

      // top month
      const byMonth = Array(12).fill(0);
      data.forEach(d => { const idx=monthIndex(d.mes); if (idx>=0) byMonth[idx] += d.total||0; });
      const topIdx = byMonth.reduce((best, v, i) => v > byMonth[best] ? i : best, 0);

      document.getElementById('kpiContainer').innerHTML = `
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">Nacimientos Totales</p>
          <h3 class="text-2xl font-bold text-slate-800 mt-1">${fmtNum(total,0)}</h3>
          <p class="text-xs text-slate-400 mt-1">Año: ${year}</p>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">Tasa (Total / Hato)</p>
          <h3 class="text-2xl font-bold text-blue-600 mt-1">${fmtPct(tasa,2)}</h3>
          <p class="text-xs text-slate-400 mt-1">Promedio ponderado mensual</p>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">Mix Machos/Hembras</p>
          <h3 class="text-2xl font-bold text-slate-800 mt-1">${fmtPct(ratioM,1)} / ${fmtPct(100-ratioM,1)}</h3>
          <p class="text-xs text-slate-400 mt-1">Mes pico: ${MONTHS_FULL[topIdx]} (${fmtNum(byMonth[topIdx],0)})</p>
        </div>
      `;

      document.getElementById('chartsContainer').innerHTML = `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <h4 class="font-bold text-slate-700 mb-4">Machos vs Hembras por Mes</h4>
            <div class="h-[360px]"><canvas id="nf1"></canvas></div>
          </div>
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <h4 class="font-bold text-slate-700 mb-4">Tasa Mensual (%)</h4>
            <div class="h-[360px]"><canvas id="nf2"></canvas></div>
          </div>
        </div>

        ${fv==='all' ? '' : `
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <h4 class="font-bold text-slate-700 mb-4">Hato vs Nacimientos (Mes a Mes)</h4>
          <div class="h-[380px]"><canvas id="nf3"></canvas></div>
        </div>
        `}
      `;

      // nf1: stacked machos/hembras
      const machArr = Array(12).fill(0);
      const hemArr = Array(12).fill(0);
      data.forEach(d => {
        const idx = monthIndex(d.mes);
        if (idx>=0) {
          machArr[idx] += d.machos || 0;
          hemArr[idx] += d.hembras || 0;
        }
      });

      charts.nf1 = new Chart(document.getElementById('nf1'), {
        type:'bar',
        data:{ labels: MONTHS_FULL, datasets:[
          { label:'Machos', data: machArr, borderRadius: 6 },
          { label:'Hembras', data: hemArr, borderRadius: 6 }
        ]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } }, scales:{ x:{ stacked:true }, y:{ stacked:true } } }
      });

      // nf2: rate monthly
      const hatoArr = Array(12).fill(0);
      data.forEach(d => { const idx=monthIndex(d.mes); if (idx>=0) hatoArr[idx] += d.hato||0; });
      const totArr = machArr.map((v,i)=>v+hemArr[i]);
      const rate = totArr.map((v,i)=>hatoArr[i]>0?(v/hatoArr[i])*100:0);

      charts.nf2 = new Chart(document.getElementById('nf2'), {
        type:'line',
        data:{ labels: MONTHS_FULL, datasets:[{ label:'Tasa (%)', data: rate, borderWidth: 2.5, tension: 0.3 }] },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            legend:{ position:'bottom' },
            tooltip:{ callbacks:{ label:(ctx)=>{
              const v = (ctx.parsed && typeof ctx.parsed==='object') ? (ctx.parsed.y ?? ctx.parsed.x) : ctx.parsed;
              const p = ctx.dataset.label ? (ctx.dataset.label + ': ') : '';
              return p + fmtPct(v,2);
            } } }
          },
          scales:{ y:{ ticks:{ callback:(v)=>fmtPct(v,2) } } }
        }
      });

      // nf3
            if (fv !== 'all') {
        const scatter = MONTHS_FULL.map((m,i)=>({ x: hatoArr[i], y: totArr[i] }));
        charts.nf3 = new Chart(document.getElementById('nf3'), {
          type:'scatter',
          data:{ datasets:[{ label:'Hato (x) vs Nacimientos (y)', data: scatter, pointRadius: 6 }] },
          options:{
            responsive:true, maintainAspectRatio:false,
            plugins:{ legend:{ position:'bottom' } },
            scales:{
              x:{ title:{ display:true, text:'Hato Reproductivo (mes)' } },
              y:{ title:{ display:true, text:'Nacimientos (mes)' } }
            }
          }
        });
            }
    }

    // -------------------------
    // UI: Muertes Histórico
    // -------------------------
function renderMuertesUI(data, allData) {
  const content = document.getElementById('sectionContent');

  if (!Array.isArray(data) || data.length === 0) {
    renderNoDataState();
    return;
  }

  // Agrupar por finca y año
  const fincasSet = new Set();
  const yearsSet = new Set();
  const agg = {}; // agg[finca][anio]

  for (const d of data) {
    if (!d) continue;
    const finca = String(d.finca || '').trim();
    const anio = Number(d.anio);
    if (!finca || !Number.isFinite(anio)) continue;

    fincasSet.add(finca);
    yearsSet.add(anio);

    if (!agg[finca]) agg[finca] = {};
    if (!agg[finca][anio]) agg[finca][anio] = { masa_ganadera: 0, crias_machos: 0, crias_hembras: 0, adultos: 0, muertes: 0, porcentaje: 0, _pctN: 0 };

    const slot = agg[finca][anio];
    slot.masa_ganadera = Math.max(slot.masa_ganadera, d.masa_ganadera || 0);
    slot.crias_machos += (d.crias_machos || 0);
    slot.crias_hembras += (d.crias_hembras || 0);
    slot.adultos += (d.adultos || 0);
    slot.muertes += (d.muertes || 0);

    const pct = (d.porcentaje || 0);
    if ((d.masa_ganadera || 0) > 0) {
      slot._pctN += pct * (d.masa_ganadera || 0);
    }
  }

  for (const finca of Object.keys(agg)) {
    for (const anio of Object.keys(agg[finca])) {
      const slot = agg[finca][anio];
      slot.porcentaje = slot.masa_ganadera > 0 ? (slot._pctN / slot.masa_ganadera) : 0;
      delete slot._pctN;
    }
  }

  const fincas = Array.from(fincasSet).filter(f => normalizeKey(f) !== 'TOTAL' && normalizeKey(f) !== 'FINCA').sort();
  const years = Array.from(yearsSet).sort((a, b) => a - b);

  const totalsByYear = {};
  for (const y of years) totalsByYear[y] = { masa_ganadera: 0, muertes: 0, crias_machos: 0, crias_hembras: 0, adultos: 0 };

  for (const f of fincas) {
    for (const y of years) {
      const slot = (agg[f] && agg[f][y]) ? agg[f][y] : null;
      if (!slot) continue;
      totalsByYear[y].masa_ganadera += slot.masa_ganadera;
      totalsByYear[y].muertes += slot.muertes;
      totalsByYear[y].crias_machos += slot.crias_machos;
      totalsByYear[y].crias_hembras += slot.crias_hembras;
      totalsByYear[y].adultos += slot.adultos;
    }
  }

  const latestYear = years.length ? years[years.length - 1] : null;
  const prevYear = years.length >= 2 ? years[years.length - 2] : null;

  const latestTotal = latestYear ? (totalsByYear[latestYear].muertes || 0) : 0;
  const prevTotal = prevYear ? (totalsByYear[prevYear].muertes || 0) : 0;
  const delta = (latestYear && prevYear) ? (latestTotal - prevTotal) : 0;
  const pctDelta = (latestYear && prevYear && prevTotal !== 0) ? (delta / prevTotal) : 0;

  // %VAR (mismo criterio que la columna %Var. en "Detalle por Finca"): Δ / año_anterior
  const latestRate = pctDelta;

const kpis = (latestYear && prevYear) ? ([
    { label: `Total Muertes ${latestYear}`, value: latestTotal, icon: '⚠️' },
    { label: `Total Muertes ${prevYear}`, value: prevTotal, icon: '📦' },
    { label: 'Variación', value: delta, icon: delta <= 0 ? '📉' : '📈' },
    { label: `Tasa ${latestYear}`, value: latestRate, icon: '🧮', isPct: true },
  ]) : ([
    { label: `Total Muertes ${latestYear || ''}`.trim(), value: latestTotal, icon: '⚠️' },
    { label: 'Crías Machos', value: latestYear ? (totalsByYear[latestYear].crias_machos || 0) : 0, icon: '♂️' },
    { label: 'Crías Hembras', value: latestYear ? (totalsByYear[latestYear].crias_hembras || 0) : 0, icon: '♀️' },
    { label: 'Adultos', value: latestYear ? (totalsByYear[latestYear].adultos || 0) : 0, icon: '🐄' },
  ]);

  const kpiHtml = kpis.map(k => `
    <div class="bg-white rounded-xl p-5 shadow-sm border border-slate-200/70">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-xs uppercase tracking-wide text-slate-500">${k.label}</div>
          <div class="mt-1 text-2xl font-semibold text-slate-800">${k.isPct ? fmtPct(k.value) : fmtNum(k.value)}</div>
        </div>
        <div class="text-2xl">${k.icon}</div>
      </div>
    </div>
  `).join('');

  // Chart: muertes por finca (comparativo)
  const palette = [
    { bg: 'rgba(244, 63, 94, 0.55)', br: 'rgba(244, 63, 94, 1)' },     // rose
    { bg: 'rgba(59, 130, 246, 0.55)', br: 'rgba(59, 130, 246, 1)' },   // blue
    { bg: 'rgba(249, 115, 22, 0.55)', br: 'rgba(249, 115, 22, 1)' },   // orange
    { bg: 'rgba(168, 85, 247, 0.55)', br: 'rgba(168, 85, 247, 1)' },   // purple
    { bg: 'rgba(16, 185, 129, 0.55)', br: 'rgba(16, 185, 129, 1)' },   // emerald
  ];

  const datasets = years.map((y, idx) => {
    const color = palette[idx % palette.length];
    return {
      label: String(y),
      data: fincas.map(f => (agg[f] && agg[f][y]) ? (agg[f][y].muertes || 0) : 0),
      backgroundColor: color.bg,
      borderColor: color.br,
      borderWidth: 1
    };
  });

  // Tabla
  const headerCols = years.map(y => `<th class="py-2 px-2 text-right">Muertes ${y}</th>`).join('');
  const headerMasaCols = years.map(y => `<th class="py-2 px-2 text-right">Masa ${y}</th>`).join('');

  const tableRows = fincas.map(f => {
    const colsMasa = years.map(y => `<td class="py-2 px-2 text-right">${fmtNum((agg[f] && agg[f][y]) ? (agg[f][y].masa_ganadera || 0) : 0)}</td>`).join('');
    const colsMu = years.map(y => `<td class="py-2 px-2 text-right font-medium">${fmtNum((agg[f] && agg[f][y]) ? (agg[f][y].muertes || 0) : 0)}</td>`).join('');

    let varHtml = '';
    if (years.length >= 2) {
      const y1 = years[years.length - 2];
      const y2 = years[years.length - 1];
      const v1 = (agg[f] && agg[f][y1]) ? (agg[f][y1].muertes || 0) : 0;
      const v2 = (agg[f] && agg[f][y2]) ? (agg[f][y2].muertes || 0) : 0;
      const dlt = v2 - v1;
      const pct = v1 !== 0 ? (dlt / v1) : 0;
      varHtml = `
        <td class="py-2 px-2 text-right ${dlt <= 0 ? 'text-emerald-600' : 'text-rose-600'}">${fmtNum(dlt)}</td>
        <td class="py-2 px-2 text-right text-slate-700">${fmtPct(pct)}</td>
      `;
    }

    return `
      <tr class="hover:bg-slate-50">
        <td class="py-2 px-2 font-medium text-slate-800">${f}</td>
        ${colsMasa}
        ${colsMu}
        ${varHtml}
      </tr>
    `;
  }).join('');

  const footerVarHeader = (years.length >= 2) ? `<th class="py-2 px-2 text-right">Var.</th><th class="py-2 px-2 text-right">%Var.</th>` : '';
  const footerVarCols = (years.length >= 2) ? (() => {
    const y1 = years[years.length - 2];
    const y2 = years[years.length - 1];
    const v1 = totalsByYear[y1].muertes || 0;
    const v2 = totalsByYear[y2].muertes || 0;
    const dlt = v2 - v1;
    const pct = v1 !== 0 ? (dlt / v1) : 0;
    return `<td class="py-2 px-2 text-right font-semibold ${dlt <= 0 ? 'text-emerald-600' : 'text-rose-600'}">${fmtNum(dlt)}</td><td class="py-2 px-2 text-right font-semibold">${fmtPct(pct)}</td>`;
  })() : '';

  const footerMasa = years.map(y => `<td class="py-2 px-2 text-right font-semibold">${fmtNum(totalsByYear[y].masa_ganadera || 0)}</td>`).join('');
  const footerMu = years.map(y => `<td class="py-2 px-2 text-right font-semibold">${fmtNum(totalsByYear[y].muertes || 0)}</td>`).join('');

  const tableHtml = `
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead class="text-xs uppercase text-slate-500 border-b">
          <tr>
            <th class="py-2 px-2 text-left">Finca</th>
            ${headerMasaCols}
            ${headerCols}
            ${footerVarHeader}
          </tr>
        </thead>
        <tbody class="divide-y">
          ${tableRows}
        </tbody>
        <tfoot class="border-t bg-slate-50">
          <tr>
            <td class="py-2 px-2 font-semibold text-slate-800">TOTAL</td>
            ${footerMasa}
            ${footerMu}
            ${footerVarCols}
          </tr>
        </tfoot>
      </table>
    </div>
  `;

  content.innerHTML = `
    <div class="space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
        ${kpiHtml}
      </div>

      <div class="bg-white rounded-xl p-5 shadow-sm border border-slate-200/70">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-semibold text-slate-800">Muertes por Finca (Comparativo)</h3>
          <div class="text-xs text-slate-500">${years.length ? `Años: ${years.join(' vs ')}` : ''}</div>
        </div>
        <div class="h-[380px]">
          <canvas id="mueChart"></canvas>
        </div>
      </div>

      <div class="bg-white rounded-xl p-5 shadow-sm border border-slate-200/70">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-semibold text-slate-800">Detalle por Finca</h3>
          <div class="text-xs text-slate-500">${(data[0] && data[0].mes) ? `Mes: ${data[0].mes}` : ''}</div>
        </div>
        ${tableHtml}
      </div>
    </div>
  `;

  const ctx = document.getElementById('mueChart');
  if (charts.mueChart) charts.mueChart.destroy();
  charts.mueChart = new Chart(ctx, {
    type: 'bar',
    data: { labels: fincas, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { position: 'bottom' } },
      scales: { y: { beginAtZero: true } }
    }
  });
}
    function renderMuertesMesUI(data, rawAll) {
      const fv = fincaFilter.value;
      const yearMain = Math.max(...uniq(data.map(d=>d.anio)));
      const yearAlt = data.some(d=>d.anio===2024 && d.finca==='TOTAL GENERAL') ? 2024 : null;

      // Base para KPIs y serie mensual (respeta filtro por finca y mes aplicado en renderDashboard)
      const hasTG = data.some(d => d.finca === 'TOTAL GENERAL');
      const baseSeries = (fincaFilter.value === 'all' && hasTG) ? data.filter(d => d.finca === 'TOTAL GENERAL') : data;

      // Total (suma de meses) para el año principal
      const total = baseSeries.filter(d=>d.anio===yearMain).reduce((a,b)=>a + (b.muertes||0), 0);

      // Comparativo vs 2024 (solo disponible para TOTAL GENERAL)
      const totalAlt = (yearAlt && fincaFilter.value==='all' && hasTG) ? baseSeries.filter(d=>d.anio===yearAlt).reduce((a,b)=>a + (b.muertes||0), 0) : null;
      const diff = (totalAlt!=null) ? (total - totalAlt) : null;

      // by finca totals (año principal)
      const byF = {};
      data.filter(d=>d.anio===yearMain && d.finca!=='TOTAL GENERAL').forEach(d=>{ byF[d.finca]=(byF[d.finca]||0)+ (d.muertes||0); });
      const topF = Object.keys(byF).length ? Object.keys(byF).reduce((a,b)=>byF[a]>byF[b]?a:b) : 'N/A';

      // by month total (baseSeries)
      const byM = Array(12).fill(0);
      baseSeries.filter(d=>d.anio===yearMain).forEach(d=>{
        const idx = monthIndex(d.mes);
        if (idx>=0) byM[idx]+= (d.muertes||0);
      });
      const maxVal = Math.max(...byM);
      const peakIdxs = (maxVal>0) ? byM.map((v,i)=>v===maxVal?i:null).filter(v=>v!==null) : [];
      const peakLabel = peakIdxs.length ? humanJoin(peakIdxs.map(i=>MONTHS_FULL[i]), 'y') : 'N/A';

      kpiContainer.className = 'grid grid-cols-1 md:grid-cols-4 gap-6';

      document.getElementById('kpiContainer').innerHTML = `
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">Muertes Totales (${yearMain})</p>
          <h3 class="text-2xl font-bold text-slate-800 mt-1">${fmtNum(total,0)}</h3>
          <p class="text-xs text-slate-400 mt-1">${fincaFilter.value==='all'?'Todas las fincas':`Finca: ${fincaFilter.value}`}</p>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">Comparativo</p>
          <h3 class="text-2xl font-bold ${diff!=null && diff>=0 ? 'text-green-600' : (diff!=null ? 'text-rose-600' : 'text-slate-800')} mt-1">${diff==null?'—':(diff>=0?'+':'')+fmtNum(diff,0)}</h3>
          <p class="text-xs text-slate-400 mt-1">${diff==null?'No hay total 2024 en el archivo':`${yearMain} vs 2024`}</p>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">Finca con más muertes</p>
          <h3 class="text-2xl font-bold text-rose-600 mt-1">${topF}</h3>
          <p class="text-xs text-slate-400 mt-1">${topF!=='N/A'?`${fmtNum(byF[topF]||0,0)} muertes`:''}</p>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">Mes pico</p>
          <h3 class="text-2xl font-bold text-slate-800 mt-1">${peakLabel}</h3>
          <p class="text-xs text-slate-400 mt-1">${fmtNum(maxVal,0)} muertes</p>
        </div>
      `;

      document.getElementById('chartsContainer').innerHTML = `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <h4 class="font-bold text-slate-700 mb-4">Muertes por Finca (${yearMain})</h4>
            <div class="h-[360px]"><canvas id="mm1"></canvas></div>
          </div>
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <h4 class="font-bold text-slate-700 mb-4">Muertes por Mes (Total)</h4>
            <div class="h-[360px]"><canvas id="mm2"></canvas></div>
          </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <div class="flex items-baseline justify-between gap-3 flex-wrap">
            <h4 class="font-bold text-slate-700">Causas (Finca seleccionada)</h4>
            <p class="text-xs text-slate-400">Selecciona una finca para ver el detalle en texto.</p>
          </div>
          <div id="mmCauses" class="mt-4 text-sm text-slate-600 whitespace-pre-line bg-slate-50 border border-slate-200 rounded-xl p-4 max-h-64 overflow-auto"></div>
        </div>
      `;

      const items = Object.entries(byF).sort((a,b)=>b[1]-a[1]);
      charts.mm1 = new Chart(document.getElementById('mm1'), {
        type:'bar',
        data:{ labels: items.map(x=>x[0]), datasets:[{ label:'Muertes', data: items.map(x=>x[1]), borderRadius: 8 }] },
        options:{ responsive:true, maintainAspectRatio:false, indexAxis:'y', plugins:{ legend:{ display:false } } }
      });

      charts.mm2 = new Chart(document.getElementById('mm2'), {
        type:'line',
        data:{ labels: MONTHS_FULL, datasets:[{ label:`Total ${yearMain}`, data: byM, borderWidth: 2.5, tension: 0.3 }] },
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } } }
      });

      // causas
      const causesDiv = document.getElementById('mmCauses');
      if (fv === 'all') {
        causesDiv.innerText = 'Selecciona una finca específica para visualizar el texto de causas.';
      } else {
        const cause = (data.find(d => d.finca===fv && d.anio===yearMain && (d.causas||'').trim() !== '') || {}).causas || '';
        causesDiv.innerText = cause ? cause : 'No se encontró texto de causas para la finca seleccionada.';
      }
    }

    // -------------------------
    // UI: Muertes x Fincas
    // -------------------------
    function renderMuertesFincasUI(data, rawAll) {
      const fv = fincaFilter.value;
      const year = uniq(data.map(d=>d.anio))[0] || '';

      const totalDeaths = data.reduce((a,b)=>a+(b.muertes_total||0),0);
      const totalMasa = data.reduce((a,b)=>a+(b.masa||0),0);
      const tasa = totalMasa>0 ? (totalDeaths/totalMasa)*100 : 0;

      const shareCria = totalDeaths>0 ? (data.reduce((a,b)=>a+(b.muertes_menor||0),0)/totalDeaths)*100 : 0;

      document.getElementById('kpiContainer').innerHTML = `
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">Muertes Totales (${year})</p>
          <h3 class="text-2xl font-bold text-slate-800 mt-1">${fmtNum(totalDeaths,0)}</h3>
          <p class="text-xs text-slate-400 mt-1">${fv==='all'?'Todas las fincas':`Finca: ${fv}`}</p>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">Tasa Global (%)</p>
          <h3 class="text-2xl font-bold text-rose-600 mt-1">${fmtPct(tasa,2)}</h3>
          <p class="text-xs text-slate-400 mt-1">Promedio Muertes / Masa ganadera al Mes</p>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">Composición</p>
          <h3 class="text-2xl font-bold text-slate-800 mt-1">${fmtPct(shareCria,1)} crías</h3>
          <p class="text-xs text-slate-400 mt-1">${fmtPct(100-shareCria,1)} adultos</p>
        </div>
      `;

      document.getElementById('chartsContainer').innerHTML = `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <h4 class="font-bold text-slate-700 mb-4">Crías vs Adultos (Mes)</h4>
            <div class="h-[360px]"><canvas id="mf1"></canvas></div>
          </div>
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <h4 class="font-bold text-slate-700 mb-4">Tasa Mensual (%)</h4>
            <div class="h-[360px]"><canvas id="mf2"></canvas></div>
          </div>
        </div>

        ${fv==='all' ? '' : `
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <h4 class="font-bold text-slate-700 mb-4">Masa vs Muertes (Dispersión)</h4>
          <div class="h-[380px]"><canvas id="mf3"></canvas></div>
        </div>
        `}
      `;

      // mf1 stacked
      const cria = Array(12).fill(0);
      const adult = Array(12).fill(0);
      data.forEach(d => {
        const idx=monthIndex(d.mes);
        if (idx>=0) {
          cria[idx]+=d.muertes_menor||0;
          adult[idx]+=d.muertes_adulto||0;
        }
      });

      charts.mf1 = new Chart(document.getElementById('mf1'), {
        type:'bar',
        data:{ labels: MONTHS_FULL, datasets:[
          { label:'Crías', data: cria, borderRadius: 6 },
          { label:'Adultos', data: adult, borderRadius: 6 }
        ]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ position:'bottom' } }, scales:{ x:{ stacked:true }, y:{ stacked:true } } }
      });

      // mf2 rate by month
      const masaArr = Array(12).fill(0);
      data.forEach(d => { const idx=monthIndex(d.mes); if (idx>=0) masaArr[idx]+=d.masa||0; });
      const totArr = cria.map((v,i)=>v+adult[i]);
      const rate = totArr.map((v,i)=>masaArr[i]>0?(v/masaArr[i])*100:0);

      charts.mf2 = new Chart(document.getElementById('mf2'), {
        type:'line',
        data:{ labels: MONTHS_FULL, datasets:[{ label:'Tasa (%)', data: rate, borderWidth: 2.5, tension: 0.3 }] },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          plugins:{
            legend:{ position:'bottom' },
            tooltip:{ callbacks:{ label:(ctx)=>{
              const v = (ctx.parsed && typeof ctx.parsed==='object') ? (ctx.parsed.y ?? ctx.parsed.x) : ctx.parsed;
              const p = ctx.dataset.label ? (ctx.dataset.label + ': ') : '';
              return p + fmtPct(v,2);
            } } }
          },
          scales:{ y:{ ticks:{ callback:(v)=>fmtPct(v,2) } } }
        }
      });

      // mf3
            if (fv !== 'all') {
        const scatter = MONTHS_FULL.map((m,i)=>({ x: masaArr[i], y: totArr[i] }));
        charts.mf3 = new Chart(document.getElementById('mf3'), {
          type:'scatter',
          data:{ datasets:[{ label:'Masa (x) vs Muertes (y)', data: scatter, pointRadius: 6 }] },
          options:{
            responsive:true, maintainAspectRatio:false,
            plugins:{ legend:{ position:'bottom' } },
            scales:{
              x:{ title:{ display:true, text:'Masa ganadera (mes)' } },
              y:{ title:{ display:true, text:'Muertes totales (mes)' } }
            }
          }
        });
            }
    }

    

    // =========================
    // Renderers adicionales (6 módulos)
    // =========================
    function renderLluviasUI(data) {
      const total = data.reduce((a, c) => a + (c.acumulado || 0), 0);
      const avg = total / data.length;
      const max = Math.max(...data.map(d => d.acumulado || 0));

      const fincaTotals = {};
      data.forEach(d => { fincaTotals[d.finca] = (fincaTotals[d.finca] || 0) + (d.acumulado || 0); });
      const topFincaName = Object.keys(fincaTotals).length
        ? Object.keys(fincaTotals).reduce((a, b) => fincaTotals[a] > fincaTotals[b] ? a : b)
        : 'N/A';

      document.getElementById('kpiContainer').innerHTML = `
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">Promedio Acumulado</p>
          <h3 class="text-2xl font-bold text-slate-800 mt-1">${fmtNum(avg, 1)} mm</h3>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">Pico Máximo</p>
          <h3 class="text-2xl font-bold text-slate-800 mt-1">${fmtNum(max, 0)} mm</h3>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">Finca con Mayor Histórico</p>
          <h3 class="text-2xl font-bold text-blue-600 mt-1">${topFincaName}</h3>
        </div>
      `;

      document.getElementById('chartsContainer').innerHTML = `
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <h4 class="font-bold text-slate-700 mb-4">Estacionalidad: Promedio Mensual (mm)</h4>
          <div class="h-[320px]"><canvas id="ll1"></canvas></div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 pb-8">
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <h4 class="font-bold text-slate-700 mb-4">Evolución Histórica (Acumulado)</h4>
            <div class="h-[360px]"><canvas id="ll2"></canvas></div>
          </div>
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <h4 class="font-bold text-slate-700 mb-4">Balance por Semestre (Promedio)</h4>
            <div class="h-[360px]"><canvas id="ll3"></canvas></div>
          </div>
        </div>
      `;

      const months = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
      const monthlyAvg = Array(12).fill(0).map((_, i) => {
        let sum = 0, cnt = 0;
        data.forEach(d => {
          const v = d.meses?.[i];
          if (v === null || v === undefined || isNaN(v)) return;
          sum += v;
          cnt += 1;
        });
        return cnt ? (sum / cnt) : 0;
      });

      charts.ll1 = new Chart(document.getElementById('ll1'), {
        type: 'bar',
        data: { labels: months, datasets: [{ label: 'mm', data: monthlyAvg, backgroundColor: '#3b82f6', borderRadius: 6 }] },
        options: { responsive: true, maintainAspectRatio: false }
      });

      const years = uniq(data.map(d => parseInt(d.anio))).filter(y => !isNaN(y)).sort((a,b)=>a-b);
      const fincas = uniq(data.map(d => d.finca));

      const palette = ['#3b82f6','#10b981','#f59e0b','#8b5cf6','#ec4899','#f97316','#06b6d4','#475569','#ef4444','#22c55e'];
      const datasets = fincas.map((f, i) => ({
        label: f,
        borderColor: palette[i % palette.length],
        backgroundColor: palette[i % palette.length],
        data: years.map(y => {
          const found = data.find(d => d.finca === f && parseInt(d.anio) === y);
          return found ? (found.acumulado || 0) : null;
        }),
        tension: 0.35,
        borderWidth: 2.5,
        pointRadius: 3
      }));

      charts.ll2 = new Chart(document.getElementById('ll2'), {
        type: 'line',
        data: { labels: years, datasets },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
      });

      const s1 = data.reduce((a, b) => a + (b.s1 || 0), 0) / data.length;
      const s2 = data.reduce((a, b) => a + (b.s2 || 0), 0) / data.length;

      charts.ll3 = new Chart(document.getElementById('ll3'), {
        type: 'doughnut',
        data: { labels: ['S1','S2'], datasets: [{ data: [s1, s2], backgroundColor: ['#3b82f6', '#1e293b'] }] },
        options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom' } } }
      });
    }

    function renderPesajesUI(data) {
      const totalKg = data.reduce((a, b) => a + (b.kilos || 0), 0);
      const totalReses = data.reduce((a, b) => a + (b.reses || 0), 0);
      const avgWeight = totalReses > 0 ? (totalKg / totalReses) : 0;

      document.getElementById('kpiContainer').innerHTML = `
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">Total Kilos Pesados</p>
          <h3 class="text-2xl font-bold text-slate-800 mt-1">${fmtNum(totalKg, 0)} Kg</h3>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">Peso Promedio</p>
          <h3 class="text-2xl font-bold text-green-600 mt-1">${fmtNum(avgWeight, 1)} Kg/res</h3>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">Total Reses</p>
          <h3 class="text-2xl font-bold text-slate-800 mt-1">${fmtNum(totalReses, 0)}</h3>
        </div>
      `;

      document.getElementById('chartsContainer').innerHTML = `
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <h4 class="font-bold text-slate-700 mb-4">Kilos por Finca</h4>
          <div class="h-[360px]"><canvas id="pe1"></canvas></div>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 pb-8">
          <h4 class="font-bold text-slate-700 mb-4">Evolución Trimestral (Kilos vs Reses)</h4>
          <div class="h-[380px]"><canvas id="pe2"></canvas></div>
        </div>
      `;

      const fNames = uniq(data.map(d => d.finca)).sort();
      const fKilos = fNames.map(name => data.filter(d => d.finca === name).reduce((a, b) => a + (b.kilos || 0), 0));

      charts.pe1 = new Chart(document.getElementById('pe1'), {
        type: 'bar',
        data: { labels: fNames, datasets: [{ label: 'Kg Totales', data: fKilos, backgroundColor: '#10b981', borderRadius: 8 }] },
        options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false }
      });

      // timeline (agrega todas las fincas)
      const groups = {};
      data.forEach(d => {
        const y = parseInt(d.anio);
        const mi = monthIndex(d.mes);
        if (isNaN(y) || mi < 0) return;
        const key = `${y}-${String(mi+1).padStart(2,'0')}`;
        if (!groups[key]) groups[key] = { y, mi, kilos: 0, reses: 0 };
        groups[key].kilos += (d.kilos || 0);
        groups[key].reses += (d.reses || 0);
      });
      const timeline = Object.values(groups).sort((a,b)=> (a.y-b.y) || (a.mi-b.mi));
      const labels = timeline.map(g => `${MONTHS_FULL[g.mi].slice(0,3)} ${g.y}`);
      const kilos = timeline.map(g => g.kilos);
      const reses = timeline.map(g => g.reses);

      charts.pe2 = new Chart(document.getElementById('pe2'), {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: 'Kg Totales', data: kilos, borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.12)', fill: true, tension: 0.25, yAxisID: 'y' },
            { label: 'Reses', data: reses, type: 'bar', backgroundColor: 'rgba(16,185,129,0.55)', borderRadius: 6, yAxisID: 'y1' }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom' } },
          scales: {
            y: { title: { display: true, text: 'Kg' } },
            y1: { position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'Reses' } }
          }
        }
      });
    }

    function renderHembrasUI(data) {
      const total = data.length;
      const avgAge = total > 0 ? (data.reduce((a, b) => a + (b.edad || 0), 0) / total) : 0;
      const avgWeight = total > 0 ? (data.reduce((a, b) => a + (b.peso || 0), 0) / total) : 0;

      const prenadas = data.filter(d => (d.repro || '').toUpperCase().includes('PREÑ')).length;
      const vacias = total - prenadas;
      const pctPrenadas = total > 0 ? (prenadas / total) * 100 : 0;

      const diasSub = data.filter(d => (d.diasAbiertos || 0) > 0);
      const avgDias = diasSub.length ? (diasSub.reduce((a, b) => a + (b.diasAbiertos || 0), 0) / diasSub.length) : 0;

      document.getElementById('kpiContainer').innerHTML = `
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">Hato Total Analizado</p>
          <h3 class="text-2xl font-bold text-slate-800 mt-1">${fmtNum(total, 0)} Hembras</h3>
          <p class="text-xs text-slate-400 mt-1">Edad media: ${fmtNum(avgAge, 1)} años</p>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">Preñadas</p>
          <h3 class="text-2xl font-bold text-green-600 mt-1">${fmtNum(prenadas,0)} (${fmtPct(pctPrenadas, 1)})</h3>
          <p class="text-xs text-slate-400 mt-1">Vacías: ${fmtNum(vacias,0)}</p>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">Promedios</p>
          <h3 class="text-2xl font-bold text-slate-800 mt-1">${fmtNum(avgWeight, 1)} Kg</h3>
          <p class="text-xs text-slate-400 mt-1">Días abiertos (excluye 0): ${fmtNum(avgDias, 0)}</p>
        </div>
      `;

      document.getElementById('chartsContainer').innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <h4 class="font-bold text-slate-700 mb-4">Estado Reproductivo</h4>
            <div class="h-[300px]"><canvas id="he1"></canvas></div>
          </div>
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <div class="flex items-center justify-between mb-4"><h4 id="hePartosTitle" class="font-bold text-slate-700">Partos por finca</h4><button id="hePartosToggle" class="no-print text-xs font-semibold px-3 py-1 rounded-lg border border-slate-200 bg-slate-50 hover:bg-slate-100">Ver Promedio</button></div>
            <div class="h-[300px]"><canvas id="he2"></canvas></div>
          </div>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <h4 class="font-bold text-slate-700 mb-4">Días Abiertos vs Edad (Dispersión)</h4>
          <div class="h-[460px]"><canvas id="he3"></canvas></div>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 pb-8">
          <h4 class="font-bold text-slate-700 mb-4">Distribución por Finca (Población)</h4>
          <div class="h-[360px]"><canvas id="he4"></canvas></div>
        </div>
      `;

      
      // Estado (incluye HL y NV) — partición sin doble conteo:
      // HL y NV se contabilizan por 'estado actual'; el resto se agrupa por Preñada/Vacía.
      // Estado Reproductivo — basado en "ESTADO ACTUAL" (VS, VP, HL, NV)
      const eKey = (d) => (d.estado || '').toString().toUpperCase().replace(/\s+/g, '').replace(/\./g, '').trim();
      const countVS = data.filter(d => eKey(d) === 'VS').length;
      const countVP = data.filter(d => eKey(d) === 'VP').length;
      const countHL = data.filter(d => eKey(d) === 'HL').length;
      const countNV = data.filter(d => eKey(d) === 'NV').length;
charts.he1 = new Chart(document.getElementById('he1'), {
        type: 'pie',
        data: {
          labels: ['VS','VP','HL','NV'],
          datasets: [{
            data: [countVS, countVP, countHL, countNV],
            backgroundColor: ['#f87171', '#10b981', '#8b5cf6', '#f59e0b']
          }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
      });

      const fNames = uniq(data.map(d => d.finca)).sort();

      const buildPartosSeries = (mode) => {
        if (mode === 'avg') {
          // Promedio de partos por finca (excluye 0 para no distorsionar)
          return fNames.map(name => {
            const sub = data.filter(d => d.finca === name && (d.partos || 0) > 0);
            if (!sub.length) return 0;
            return sub.reduce((a, b) => a + (b.partos || 0), 0) / sub.length;
          });
        }
        // Total de partos por finca
        return fNames.map(name => data
          .filter(d => d.finca === name)
          .reduce((a, b) => a + (b.partos || 0), 0)
        );
      };

      let partosMode = 'sum';
      const renderPartosChart = () => {
        const series = buildPartosSeries(partosMode);
        const decimals = partosMode === 'avg' ? 1 : 0;

        charts.he2 = new Chart(document.getElementById('he2'), {
          type: 'bar',
          data: {
            labels: fNames,
            datasets: [{
              label: partosMode === 'avg' ? 'Promedio Partos' : 'Total Partos',
              data: series,
              backgroundColor: '#8b5cf6',
              borderRadius: 8
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              y: { ticks: { callback: (v) => fmtNum(v, decimals) } }
            }
          }
        });

        const title = document.getElementById('hePartosTitle');
        const btn = document.getElementById('hePartosToggle');
        if (title) title.textContent = 'Partos por finca';
        if (btn) btn.textContent = partosMode === 'avg' ? 'Ver Total' : 'Ver Promedio';
      };

      renderPartosChart();

      const btn = document.getElementById('hePartosToggle');
      if (btn) {
        btn.onclick = () => {
          partosMode = (partosMode === 'sum') ? 'avg' : 'sum';
          try { charts.he2.destroy(); } catch(e) {}
          renderPartosChart();
        };
      }

      const scatterData = data.map(d => ({ x: d.edad || 0, y: d.diasAbiertos || 0 }));
      charts.he3 = new Chart(document.getElementById('he3'), {
        type: 'scatter',
        data: {
          datasets: [{
            label: 'Relación Edad/Días Abiertos',
            data: scatterData,
            backgroundColor: 'rgba(59, 130, 246, 0.6)',
            borderColor: '#3b82f6',
            pointRadius: 5,
            pointHoverRadius: 7
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { title: { display: true, text: 'Edad (Años)', font: { weight: 'bold' } } },
            y: { title: { display: true, text: 'Días Abiertos', font: { weight: 'bold' } } }
          },
          plugins: {
            legend: { position: 'bottom' },
            tooltip: { callbacks: { label: (ctx) => `${ctx.parsed.x} años | ${ctx.parsed.y} días` } }
          }
        }
      });

      const fCounts = fNames.map(name => data.filter(d => d.finca === name).length);
      charts.he4 = new Chart(document.getElementById('he4'), {
        type: 'bar',
        data: { labels: fNames, datasets: [{ label: 'Cantidad Hembras', data: fCounts, backgroundColor: '#3b82f6', borderRadius: 8 }] },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }

    
    function renderDesteteUI(data, rawAll, sexoSel) {
      const sex = (sexoSel || 'todos');
      const sexLabel = (sex === 'machos') ? 'Machos' : (sex === 'hembras') ? 'Hembras' : 'Todos';
      const pick = (d) => (sex === 'machos') ? (d.machos || {}) : (sex === 'hembras') ? (d.hembras || {}) : (d.todos || {});

      const labels = data.map(d => d.mes);

      const total = data.reduce((a, b) => a + (pick(b).total || 0), 0);
      const kgNacimTotal = data.reduce((a, b) => a + (pick(b).pesoNacim || 0), 0);
      const kgDesteteTotal = data.reduce((a, b) => a + (pick(b).pesoDestete || 0), 0);
      const kgIncremTotal = data.reduce((a, b) => a + (pick(b).increm || 0), 0);

      // Promedios por ternero (método solicitado: total kilos / total terneros)
      const avgPesoNacim = total > 0 ? (kgNacimTotal / total) : 0;
      const avgPesoDestete = total > 0 ? (kgDesteteTotal / total) : 0;

      // INCREM. KS promedio (total increm kilos / total terneros), con fallback a resumen del reporte cuando aplica
      const hasMonthFilter = (monthFilterWrap && monthFilter && !monthFilterWrap.classList.contains('hidden') && monthFilter.value !== 'all');
      let incAvg = 0;
      if (!hasMonthFilter && window.APP_DATA.destete_meta && window.APP_DATA.destete_meta[sex] && typeof window.APP_DATA.destete_meta[sex].increm === 'number') {
        incAvg = window.APP_DATA.destete_meta[sex].increm || (total > 0 ? (kgIncremTotal / total) : 0);
      } else {
        incAvg = total > 0 ? (kgIncremTotal / total) : 0;
      }

      const tTotal = (sex === 'todos') ? 'Total Destetados (Todos)' : `Total Destetados (${sexLabel})`;
      const tKilos = (sex === 'todos') ? 'Kilos Destete (Todos)' : `Kilos Destete (${sexLabel})`;

      // Destete es el único módulo con 5 tarjetas
      kpiContainer.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6';

      document.getElementById('kpiContainer').innerHTML = `
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">${tTotal}</p>
          <h3 class="text-2xl font-bold text-slate-800 mt-1">${fmtNum(total, 0)}</h3>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">${tKilos}</p>
          <h3 class="text-2xl font-bold text-slate-800 mt-1">${fmtNum(kgDesteteTotal, 0)} Kg</h3>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">Promedio Peso al Nacimiento</p>
          <h3 class="text-2xl font-bold text-slate-800 mt-1">${fmtNum(avgPesoNacim, 0)} Kg</h3>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">Promedio Incremento Kg hasta el Destete</p>
          <h3 class="text-2xl font-bold text-blue-600 mt-1">${fmtNum(incAvg, 0)} Kg</h3>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">Peso al Destete</p>
          <h3 class="text-2xl font-bold text-slate-800 mt-1">${fmtNum(avgPesoDestete, 0)} Kg</h3>
        </div>
      `;

      const title0 = (sex === 'todos')
        ? 'Peso al Nacimiento / Incremento / Peso al Destete (Promedio por Mes)'
        : `Peso al Nacimiento / Incremento / Peso al Destete (Promedio por Mes - ${sexLabel})`;

      const title1 = (sex === 'todos')
        ? 'Destetados por Mes (Machos / Hembras / Total)'
        : `Destetados por Mes (${sexLabel})`;

      const title2 = (sex === 'todos')
        ? 'Kilos Destete por Mes (Total)'
        : `Kilos Destete por Mes (${sexLabel})`;

      const title3 = (sex === 'todos')
        ? 'Incremento (Kg) por Mes (Machos vs Hembras)'
        : `Incremento (Kg) por Mes (${sexLabel})`;

      document.getElementById('chartsContainer').innerHTML = `
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <h4 class="font-bold text-slate-700 mb-4">${title0}</h4>
          <div class="h-[340px]"><canvas id="de0"></canvas></div>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <h4 class="font-bold text-slate-700 mb-4">${title1}</h4>
          <div class="h-[360px]"><canvas id="de1"></canvas></div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 pb-8">
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <h4 class="font-bold text-slate-700 mb-4">${title2}</h4>
            <div class="h-[360px]"><canvas id="de2"></canvas></div>
          </div>
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <h4 class="font-bold text-slate-700 mb-4">${title3}</h4>
            <div class="h-[360px]"><canvas id="de3"></canvas></div>
          </div>
        </div>
      `;

      // Chart de0: Pesos promedio por mes (Nacimiento / Incremento / Destete)
      const avgBirthArr = data.map(d => {
        const p = pick(d);
        const t = p.total || 0;
        return t > 0 ? ((p.pesoNacim || 0) / t) : 0;
      });
      const avgIncArr = data.map(d => {
        const p = pick(d);
        const t = p.total || 0;
        return t > 0 ? ((p.increm || 0) / t) : 0;
      });
      const avgWeanArr = data.map(d => {
        const p = pick(d);
        const t = p.total || 0;
        return t > 0 ? ((p.pesoDestete || 0) / t) : 0;
      });

const birthLevel = avgBirthArr;
const incLevel = avgIncArr;
const weanLevel = avgWeanArr;

const segBirth = birthLevel;
const segInc = incLevel.map((v, i) => Math.max(0, v - birthLevel[i]));
const segWean = weanLevel.map((v, i) => Math.max(0, v - incLevel[i]));

const maxWean = Math.max(...weanLevel, 0);
const yMax = Math.ceil((maxWean * 1.15) / 10) * 10;

charts.de0 = new Chart(document.getElementById('de0'), {
  type: 'bar',
  data: {
    labels,
    datasets: [
      {
        label: 'Peso al Nacimiento',
        data: segBirth,
        backgroundColor: 'rgba(59, 130, 246, 0.70)',
        borderWidth: 0,
        borderSkipped: false,
        borderRadius: { topLeft: 0, topRight: 0, bottomLeft: 12, bottomRight: 12 },
        stack: 'stack1',
        maxBarThickness: 52
      },
      {
        label: 'Incremento Kg hasta el Destete',
        data: segInc,
        backgroundColor: 'rgba(16, 185, 129, 0.70)',
        borderWidth: 0,
        borderSkipped: false,
        borderRadius: 0,
        stack: 'stack1',
        maxBarThickness: 52
      },
      {
        label: 'Peso al Destete',
        data: segWean,
        backgroundColor: 'rgba(139, 92, 246, 0.70)',
        borderWidth: 0,
        borderSkipped: false,
        borderRadius: { topLeft: 12, topRight: 12, bottomLeft: 0, bottomRight: 0 },
        stack: 'stack1',
        maxBarThickness: 52
      }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { position: 'bottom' },
      tooltip: {
        callbacks: {
          label: (ctx) => {
            const i = ctx.dataIndex;
            const lbl = ctx.dataset.label;
            if (lbl === 'Peso al Nacimiento') return `${lbl}: ${fmtNum(birthLevel[i], 0)} Kg`;
            if (lbl === 'Incremento Kg hasta el Destete') return `${lbl}: ${fmtNum(incLevel[i], 0)} Kg`;
            if (lbl === 'Peso al Destete') return `${lbl}: ${fmtNum(weanLevel[i], 0)} Kg`;
            return `${lbl}: ${fmtNum(ctx.parsed.y, 0)} Kg`;
          }
        }
      }
    },
    scales: {
      x: {
        stacked: true,
        grid: { display: true }
      },
      y: {
        stacked: true,
        beginAtZero: true,
        suggestedMax: yMax,
        ticks: { callback: (v) => fmtNum(v, 0) }
      }
    }
  }
});

// Chart de1: Destetados por mes
      if (sex === 'todos') {
        const machos = data.map(d => (d.machos?.total || 0));
        const hembras = data.map(d => (d.hembras?.total || 0));
        const todos = data.map(d => (d.todos?.total || 0));

        charts.de1 = new Chart(document.getElementById('de1'), {
          type: 'line',
          data: {
            labels,
            datasets: [
              { label: 'Machos', data: machos, borderColor: '#3b82f6', tension: 0.25, pointRadius: 3 },
              { label: 'Hembras', data: hembras, borderColor: '#10b981', tension: 0.25, pointRadius: 3 },
              { label: 'Total', data: todos, borderColor: '#1e293b', tension: 0.25, pointRadius: 3 }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom' },
              tooltip:{ callbacks:{ label:(ctx)=> `${ctx.dataset.label}: ${fmtNum(ctx.parsed.y,0)}` } }
            },
            scales:{ y:{ ticks:{ callback:(v)=>fmtNum(v,0) } } }
          }
        });
      } else {
        const arr = data.map(d => pick(d).total || 0);
        charts.de1 = new Chart(document.getElementById('de1'), {
          type: 'line',
          data: { labels, datasets: [{ label: sexLabel, data: arr, borderColor: '#3b82f6', tension: 0.25, pointRadius: 3 }] },
          options: {
            responsive:true,
            maintainAspectRatio:false,
            plugins:{
              legend:{ position:'bottom' },
              tooltip:{ callbacks:{ label:(ctx)=> `${ctx.dataset.label}: ${fmtNum(ctx.parsed.y,0)}` } }
            },
            scales:{ y:{ ticks:{ callback:(v)=>fmtNum(v,0) } } }
          }
        });
      }

      // Chart de2: Kilos Destete por mes
      const kgArr = data.map(d => pick(d).pesoDestete || 0);
      charts.de2 = new Chart(document.getElementById('de2'), {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Kg', data: kgArr, borderRadius: 8 }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' },
            tooltip:{ callbacks:{ label:(ctx)=> `Kg: ${fmtNum(ctx.parsed.y,0)}` } }
          },
          scales:{ y:{ ticks:{ callback:(v)=>fmtNum(v,0) } } }
        }
      });

      // Chart de3: Incremento por mes
      if (sex === 'todos') {
        const incMachos = data.map(d => (d.machos?.increm || 0));
        const incHembras = data.map(d => (d.hembras?.increm || 0));

        charts.de3 = new Chart(document.getElementById('de3'), {
          type: 'bar',
          data: {
            labels,
            datasets: [
              { label: 'Increm. Machos (Kg)', data: incMachos, borderRadius: 8 },
              { label: 'Increm. Hembras (Kg)', data: incHembras, borderRadius: 8 }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom' },
              tooltip:{ callbacks:{ label:(ctx)=> `${ctx.dataset.label}: ${fmtNum(ctx.parsed.y,0)}` } }
            },
            scales:{ y:{ ticks:{ callback:(v)=>fmtNum(v,0) } } }
          }
        });
      } else {
        const incArr = data.map(d => pick(d).increm || 0);
        charts.de3 = new Chart(document.getElementById('de3'), {
          type: 'bar',
          data: { labels, datasets: [{ label: `Increm. ${sexLabel} (Kg)`, data: incArr, borderRadius: 8 }] },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom' },
              tooltip:{ callbacks:{ label:(ctx)=> `${ctx.dataset.label}: ${fmtNum(ctx.parsed.y,0)}` } }
            },
            scales:{ y:{ ticks:{ callback:(v)=>fmtNum(v,0) } } }
          }
        });
      }
    }


    function renderProyeccionPartosUI(data) {
      const labels = data.map(d => d.mes);

      const totalPartos = data.reduce((a,b)=>a+(b.partos||0),0);
      const totalVacas = data.reduce((a,b)=>a+(b.vacas||0),0);
      const totalNovillas = data.reduce((a,b)=>a+(b.novillas||0),0);
      const pico = data.reduce((best, cur) => (cur.partos || 0) > (best.partos || 0) ? cur : best, data[0] || { mes:'N/A', partos:0 });
      const avgPct = data.length ? (data.reduce((a,b)=>a+(b.pct||0),0)/data.length) : 0;

      document.getElementById('kpiContainer').innerHTML = `
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">Total Partos Proyectados</p>
          <h3 class="text-2xl font-bold text-slate-800 mt-1">${fmtNum(totalPartos,0)}</h3>
          <p class="text-xs text-slate-400 mt-1">Promedio % parición: ${fmtPct(avgPct, 1)}</p>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">Mes Pico</p>
          <h3 class="text-2xl font-bold text-blue-600 mt-1">${pico?.mes || 'N/A'}</h3>
          <p class="text-xs text-slate-400 mt-1">${fmtNum(pico?.partos || 0,0)} partos</p>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">Composición (Total)</p>
          <h3 class="text-2xl font-bold text-slate-800 mt-1">${fmtNum(totalVacas,0)} Vacas</h3>
          <p class="text-xs text-slate-400 mt-1">${fmtNum(totalNovillas,0)} Novillas</p>
        </div>
      `;

      document.getElementById('chartsContainer').innerHTML = `
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <h4 class="font-bold text-slate-700 mb-4">Partos Proyectados por Mes</h4>
          <div class="h-[380px]"><canvas id="pp1"></canvas></div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 pb-8">
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <h4 class="font-bold text-slate-700 mb-4">Hato Reproductivo (Evolución)</h4>
            <div class="h-[360px]"><canvas id="pp2"></canvas></div>
          </div>
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <h4 class="font-bold text-slate-700 mb-4">Participación: Vacas vs Novillas</h4>
            <div class="h-[360px]"><canvas id="pp3"></canvas></div>
          </div>
        </div>
      `;

      const vacas = data.map(d => d.vacas || 0);
      const novillas = data.map(d => d.novillas || 0);
      const total = data.map(d => d.partos || 0);

      charts.pp1 = new Chart(document.getElementById('pp1'), {
        data: {
          labels,
          datasets: [
            { type: 'bar', label: 'Vacas', data: vacas, backgroundColor: 'rgba(59,130,246,0.65)', borderRadius: 6, stack: 's' },
            { type: 'bar', label: 'Novillas', data: novillas, backgroundColor: 'rgba(16,185,129,0.65)', borderRadius: 6, stack: 's' },
            { type: 'line', label: 'Total', data: total, borderColor: '#1e293b', backgroundColor: '#1e293b', tension: 0.25, yAxisID: 'y', pointRadius: 3 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom' } },
          scales: { x: { stacked: true }, y: { stacked: true, title: { display: true, text: 'Partos' } } }
        }
      });

      const hato = data.map(d => d.hato || 0);
      charts.pp2 = new Chart(document.getElementById('pp2'), {
        type: 'line',
        data: { labels, datasets: [{ label: 'Hato Reproductivo', data: hato, borderColor: '#8b5cf6', backgroundColor: 'rgba(139,92,246,0.12)', fill: true, tension: 0.25 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
      });

      charts.pp3 = new Chart(document.getElementById('pp3'), {
        type: 'doughnut',
        data: { labels: ['Vacas','Novillas'], datasets: [{ data: [totalVacas, totalNovillas], backgroundColor: ['#3b82f6','#10b981'] }] },
        options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom' } } }
      });
    }

    function renderVentasGanadoUI(data) {
      // Orden cronológico por año/mes (por si vienen mezclados por filtros)
      const sorted = [...data].sort((a,b)=> (a.anio-b.anio) || (monthIndex(a.mes)-monthIndex(b.mes)));

      const totalImp = sorted.reduce((a,b)=>a+(b.total_importe||0),0);
      const totalRes = sorted.reduce((a,b)=>a+(b.total_reses||0),0);
      const totalKilos = sorted.reduce((a,b)=>a+(b.total_kilos||0),0);
      const precioPromKg = totalKilos > 0 ? (totalImp / totalKilos) : 0;

      const pico = sorted.reduce((best, cur) => (cur.total_importe || 0) > (best.total_importe || 0) ? cur : best, sorted[0] || { mes:'N/A', anio:'', total_importe:0 });

      document.getElementById('kpiContainer').innerHTML = `
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">Ingresos Totales</p>
          <h3 class="text-2xl font-bold text-slate-800 mt-1">${fmtNum(totalImp, 2)}</h3>
          <p class="text-xs text-slate-400 mt-1">Reses: ${fmtNum(totalRes,0)}</p>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">Precio Promedio (ponderado)</p>
          <h3 class="text-2xl font-bold text-green-600 mt-1">${fmtNum(precioPromKg, 2)} /Kg</h3>
          <p class="text-xs text-slate-400 mt-1">Kilos vendidos: ${fmtNum(totalKilos,0)}</p>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <p class="text-sm font-medium text-slate-500">Mes Pico de Ingresos</p>
          <h3 class="text-2xl font-bold text-blue-600 mt-1">${pico?.mes || 'N/A'} ${pico?.anio || ''}</h3>
          <p class="text-xs text-slate-400 mt-1">${fmtNum(pico?.total_importe || 0, 2)}</p>
        </div>
      `;

      document.getElementById('chartsContainer').innerHTML = `
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
          <h4 class="font-bold text-slate-700 mb-4">Ingresos Mensuales (Novillos vs Vacas)</h4>
          <div class="h-[390px]"><canvas id="vg1"></canvas></div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 pb-8">
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <h4 class="font-bold text-slate-700 mb-4">Precio Promedio por Kg (Ponderado)</h4>
            <div class="h-[360px]"><canvas id="vg2"></canvas></div>
          </div>
          <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
            <h4 class="font-bold text-slate-700 mb-4">Participación de Ingresos</h4>
            <div class="h-[360px]"><canvas id="vg3"></canvas></div>
          </div>
        </div>
      `;

      const labels = sorted.map(d => `${d.mes.slice(0,3)} ${d.anio}`);
      const impNov = sorted.map(d => d.novillos_importe || 0);
      const impVac = sorted.map(d => d.vacas_importe || 0);

      charts.vg1 = new Chart(document.getElementById('vg1'), {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: 'Novillos', data: impNov, backgroundColor: 'rgba(59,130,246,0.75)', borderRadius: 6, stack: 's' },
            { label: 'Vacas', data: impVac, backgroundColor: 'rgba(16,185,129,0.75)', borderRadius: 6, stack: 's' }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom' } },
          scales: { x: { stacked: true }, y: { stacked: true, title: { display: true, text: 'Ingresos' } } }
        }
      });

      const precioKg = sorted.map(d => d.precio_prom_kg || 0);
      charts.vg2 = new Chart(document.getElementById('vg2'), {
        type: 'line',
        data: { labels, datasets: [{ label: 'Precio prom /Kg', data: precioKg, borderColor: '#f59e0b', backgroundColor: 'rgba(245,158,11,0.12)', fill: true, tension: 0.25 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
      });

      const sumNov = impNov.reduce((a,b)=>a+b,0);
      const sumVac = impVac.reduce((a,b)=>a+b,0);
      charts.vg3 = new Chart(document.getElementById('vg3'), {
        type: 'doughnut',
        data: { labels: ['Novillos','Vacas'], datasets: [{ data: [sumNov, sumVac], backgroundColor: ['#3b82f6','#10b981'] }] },
        options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom' } } }
      });
    }


// =========================
    // Export (embeds APP_DATA)
    // =========================
    function setupExport() {
      saveBtn.onclick = () => {
        const clone = document.documentElement.cloneNode(true);
        const dataScript = clone.querySelector('#dataContainer');
        if (dataScript) {
          dataScript.textContent = `window.APP_DATA = ${JSON.stringify(window.APP_DATA)}; window.CURRENT_MODULE = '${window.CURRENT_MODULE}';`;
        }
        const blob = new Blob(["<!DOCTYPE html>\n" + clone.outerHTML], { type: 'text/html' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `Dashboard_Agro_10Mod_${new Date().toISOString().split('T')[0]}.html`;
        a.click();
      };
    }
  </script>

<script>
/**
 * Detección por nombre de archivo (7 módulos)
 * Nota: NO sobreescribe funciones principales del dashboard; solo aporta utilidades de detección.
 */

function renderVentasUI(data) {
  const sorted = [...data].sort((a,b)=> (a.anio-b.anio) || (monthIndex(a.mes)-monthIndex(b.mes)));

  const totalImp = sorted.reduce((acc,d)=>acc+(d.importe||0),0);
  const totalKilos = sorted.reduce((acc,d)=>acc+(d.kilos||0),0);
  const totalCant = sorted.reduce((acc,d)=>acc+(d.cantidad||0),0);
  const precioPromKg = totalKilos > 0 ? (totalImp / totalKilos) : 0;

  const pico = sorted.reduce((best, cur) => (cur.importe||0) > (best.importe||0) ? cur : best, sorted[0] || { mes:'N/A', anio:'', importe:0 });

  // Ajuste: si la categoría es CAFE, el KPI principal debe mostrarse en LIBRAS (no kilos)
  const cv = (document.getElementById('categoriaFilter')?.value || 'all').toString().toUpperCase();
  const isCafe = (cv === 'CAFE') || ((sorted[0]?.tipo || '').toString().toUpperCase() === 'CAFE');
  const totalLibras = sorted.reduce((acc,d)=> acc + ((((d.unidad||'').toString().toUpperCase().includes('LIB')) ? (d.cantidad||0) : 0)), 0);
  const qtyMain = isCafe ? totalLibras : totalKilos;
  const mainLabel = isCafe ? 'Libras Totales' : 'Kilos Totales';
  const precioPromMain = qtyMain > 0 ? (totalImp / qtyMain) : 0;
  const priceSmallLabel = isCafe ? 'Prom. precio/libra' : 'Prom. precio/kg';


  document.getElementById('kpiContainer').innerHTML = `
    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
      <p class="text-sm font-medium text-slate-500">Ingresos Totales</p>
      <h3 class="text-2xl font-bold text-slate-800 mt-1">${fmtNum(totalImp, 2)}</h3>
      <p class="text-xs text-slate-400 mt-1">Mes pico: ${pico.mes} ${pico.anio}</p>
    </div>
    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
      <p class="text-sm font-medium text-slate-500">${mainLabel}</p>
      <h3 class="text-2xl font-bold text-slate-800 mt-1">${fmtNum(qtyMain, 0)}</h3>
      <p class="text-xs text-slate-400 mt-1">${priceSmallLabel}: ${fmtNum(precioPromMain, 2)}</p>
    </div>
    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
      <p class="text-sm font-medium text-slate-500">${isCafe ? 'Precio Promedio' : 'Cantidad Total'}</p>
      <h3 class="text-2xl font-bold text-slate-800 mt-1">${isCafe ? (fmtNum(precioPromMain, 2) + ' /Lb') : fmtNum(totalCant, 0)}</h3>
      <p class="text-xs text-slate-400 mt-1">${isCafe ? ('Libras: ' + fmtNum(totalLibras, 0)) : 'Unidades mixtas (Cbzs/Libras)'}</p>
    </div>
  `;

  // Agregados por mes (total)
  const key = (d) => `${d.anio}-${String(monthIndex(d.mes)+1).padStart(2,'0')}`;
  const byMonth = {};
  sorted.forEach(d=>{
    const k = key(d);
    if (!byMonth[k]) byMonth[k] = { label: `${d.mes.slice(0,3)} ${d.anio}`, imp:0, kilos:0 };
    byMonth[k].imp += (d.importe||0);
    byMonth[k].kilos += (d.kilos||0);
  });
  const monthKeys = Object.keys(byMonth).sort();
  const labels = monthKeys.map(k=>byMonth[k].label);
  const impVals = monthKeys.map(k=>byMonth[k].imp);
  const kiloVals = monthKeys.map(k=>byMonth[k].kilos);

  // Ingresos por tipo (HEMBRAS/MACHOS/CAFE)
  const byTipo = {};
  sorted.forEach(d=>{
    const t = (d.tipo||'OTROS');
    byTipo[t] = (byTipo[t]||0) + (d.importe||0);
  });
  const tipoLabels = Object.keys(byTipo);
  const tipoVals = tipoLabels.map(t=>byTipo[t]);

  chartsContainer.innerHTML = `
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 pb-8">
      <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
        <h4 class="font-bold text-slate-700 mb-4">Ingresos por Mes</h4>
        <div class="h-[360px]"><canvas id="v1"></canvas></div>
      </div>
      <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
        <h4 class="font-bold text-slate-700 mb-4">Kilos por Mes</h4>
        <div class="h-[360px]"><canvas id="v2"></canvas></div>
      </div>
      <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 lg:col-span-2">
        <h4 class="font-bold text-slate-700 mb-4">Participación de Ingresos por Tipo</h4>
        <div class="h-[360px]"><canvas id="v3"></canvas></div>
      </div>
    </div>
  `;

  charts.v1 = new Chart(document.getElementById('v1'), {
    type: 'bar',
    data: { labels, datasets: [{ label: 'Ingresos', data: impVals }] },
    options: {
      responsive: true, maintainAspectRatio: false,
      animation: { duration: 650 },
      plugins: { tooltip: { callbacks: { label: (ctx)=> ` ${fmtNum(ctx.parsed.y,2)}` } } },
      scales: { y: { beginAtZero: true } }
    }
  });

  charts.v2 = new Chart(document.getElementById('v2'), {
    type: 'line',
    data: { labels, datasets: [{ label: 'Kilos', data: kiloVals, tension: 0.25 }] },
    options: {
      responsive: true, maintainAspectRatio: false,
      animation: { duration: 650 },
      plugins: { tooltip: { callbacks: { label: (ctx)=> ` ${fmtNum(ctx.parsed.y,0)}` } } },
      scales: { y: { beginAtZero: true } }
    }
  });

  charts.v3 = new Chart(document.getElementById('v3'), {
    type: 'doughnut',
    data: { labels: tipoLabels, datasets: [{ data: tipoVals }] },
    options: {
      responsive: true, maintainAspectRatio: false,
      animation: { duration: 650 },
      plugins: { tooltip: { callbacks: { label: (ctx)=> `${ctx.label}: ${fmtNum(ctx.parsed,2)}` } } }
    }
  });
}


const FILE_NAME_TO_MODULE = {
  'INVENTARIO X CATEGORIA': 'inventario_general',
  'INVENTARIO X CATEGORIA 2026': 'inventario_general',
  'FLUJO DE GANADO X CATEGORIA': 'flujo_ganado_categoria',
  'INVENTARIO ENTADA Y SALIDAS': 'inventario_movimiento',
  'INVENTARIO ENTRADA Y SALIDAS': 'inventario_movimiento',
  'INVENTARIO ENTRADAS Y SALIDAS': 'inventario_movimiento',
  'NACIMIENTOS 2026': 'nacimientos',
  'MUERTES 2026': 'muertes',
  'DESTETE TERNEROS': 'destete',
  'DESTETE DE TERNEROS': 'destete',
  'PROYECION DE PARTOS': 'proyeccion_partos',
  'PROYECCION DE PARTOS': 'proyeccion_partos',
  'VENTAS 2026': 'ventas',
  'VENTAS-2026': 'ventas',
};

function normalizeKey(str) {
  return (str || '')
    .toString()
    .replace(/\ufeff/g, '')
    .trim()
    .toUpperCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // sin acentos
    .replace(/\.CSV$/i, '')
    .replace(/[_\-]+/g, ' ')
    .replace(/\s+/g, ' ')
    .trim();
}

function detectModuleFromFilename(fileName) {
  const base = normalizeKey(fileName);
  return FILE_NAME_TO_MODULE[base] || null;
}
</script>


</body></html>